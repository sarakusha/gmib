"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validJsName = validJsName;
exports.unitConverter = unitConverter;
exports.precisionConverter = precisionConverter;
exports.enumerationConverter = enumerationConverter;
exports.representationConverter = representationConverter;
exports.packed8floatConverter = packed8floatConverter;
exports.getIntSize = getIntSize;
exports.minInclusiveConverter = minInclusiveConverter;
exports.maxInclusiveConverter = maxInclusiveConverter;
exports.convertFrom = exports.convertTo = exports.versionTypeConverter = exports.fixedPointNumber4Converter = exports.percentConverter = exports.booleanConverter = exports.toInt = exports.withValue = void 0;

require("source-map-support/register");

var _printf = _interopRequireDefault(require("printf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * @license
 * Copyright (c) 2019. OOO Nata-Info
 * @author Andrei Sarakeev <avs@nata-info.ru>
 *
 * This file is part of the "@nata" project.
 * For the full copyright and license information, please view
 * the EULA file that was distributed with this source code.
 */
function validJsName(name) {
  return name.replace(/(_\w)/g, (_, s) => s[1].toUpperCase());
}

const withValue = (value, writable = false) => ({
  value,
  writable,
  configurable: false,
  enumerable: true
});

exports.withValue = withValue;
const hex = /^0X[0-9A-F]+$/i;

const isHex = str => hex.test(str) || parseInt(str, 10).toString(10) !== str.toLowerCase().replace(/^[0 ]+/, '');

const toInt = (value = 0) => {
  if (typeof value === 'number') return value;
  if (typeof value === 'boolean') return value ? 1 : 0;
  if (value === 'true') return 1;
  if (value === 'false') return 0;
  return parseInt(value, isHex(value) ? 16 : 10);
};

exports.toInt = toInt;

function unitConverter(unit) {
  const fromRe = new RegExp(`(\\s*${unit}\\s*)$`, 'i');
  return {
    from: value => typeof value === 'string' ? value.replace(fromRe, '') : value,
    to: value => value != null ? `${value}${unit}` : value
  };
}

function precisionConverter(precision) {
  const format = `%.${precision}f`;
  return {
    from: value => typeof value === 'string' ? parseFloat(value) : value,
    to: value => typeof value === 'number' ? (0, _printf.default)(format, value) : value
  };
}

function enumerationConverter(enumerationValues, simpleType) {
  const from = {};
  const to = {};
  const keys = Reflect.ownKeys(enumerationValues);
  keys.forEach(key => {
    const value = enumerationValues[key];
    const index = toInt(key);
    from[value.annotation] = index;
    to[String(index)] = value.annotation;
  }); // console.log('from %o, to %o', from, to);

  return {
    from: value => {
      if (Reflect.has(from, String(value))) {
        return from[String(value)];
      }

      const simple = toInt(value);
      return Number.isNaN(simple) ? value : simple;
    },
    to: value => {
      let index = toInt(value);
      if (Number.isNaN(index)) index = String(value);
      return Reflect.has(to, String(index)) ? to[String(index)] : value;
    }
  };
}

const yes = /^\s*(yes|on|true|1|да)\s*$/i;
const no = /^\s*(no|off|false|0|нет)\s*$/i;
const booleanConverter = {
  from: value => {
    if (typeof value === 'string') {
      if (yes.test(value)) {
        return true;
      }

      if (no.test(value)) {
        return false;
      }
    }

    return value;
  },
  to: value => {
    if (typeof value === 'boolean') {
      return value ? 'Да' : 'Нет';
    }

    return value;
  }
};
exports.booleanConverter = booleanConverter;
const percentConverter = {
  from: value => typeof value === 'number' ? Math.max(Math.min(Math.round(value * 255 / 100), 255), 0) : value,
  to: value => typeof value === 'number' ? Math.max(Math.min(Math.round(value * 100 / 255), 100), 0) : value
};
exports.percentConverter = percentConverter;

function representationConverter(format, size) {
  let from;
  let to;
  let fmt; // fromFn = toFn = function (value) { return value; };

  switch (format) {
    case '%b':
    case '%B':
      fmt = `%0${size * 8}s`;

      from = value => typeof value === 'string' ? parseInt(value, 2) : value;

      to = value => typeof value === 'number' ? (0, _printf.default)(fmt, value.toString(2)) : value;

      break;

    case '%x':
    case '%X':
      fmt = `%0${size}s`;

      from = value => typeof value === 'string' ? parseInt(value, 16) : value;

      to = value => typeof value === 'number' ? (0, _printf.default)(fmt, value.toString(16)) : value;

      break;

    default:
      from = value => value;

      to = from;
  }

  return {
    from,
    to
  };
}

function packed8floatConverter(subtype) {
  let delta = 0;

  if (subtype.appinfo && subtype.appinfo.zero) {
    delta = parseFloat(subtype.appinfo.zero) || 0;
  }

  return {
    from: value => {
      const val = typeof value === 'string' ? parseFloat(value) : value;
      return typeof val === 'number' ? Math.floor((val - delta) * 100) & 0xFF : val;
    },
    to: value => typeof value === 'number' ? value / 100 + delta : value
  };
}

const fixedPointNumber4Converter = {
  from: value => {
    const val = typeof value === 'string' ? parseFloat(value) : value;

    if (typeof val !== 'number') {
      return val;
    }

    const dec = Math.round(val * 1000) % 1000;
    const hi = (Math.floor(val) << 4) + Math.floor(dec / 100) & 0xFF;
    const low = dec % 10 + (Math.floor(dec / 10) % 10 << 4) & 0xFF;
    return hi << 8 | low;
  },
  to: value => {
    if (typeof value !== 'number') {
      return value;
    }

    const hi = value >> 8 & 0xFF;
    const low = value & 0xFF;
    const dec = (hi & 0xF) * 100 + (low >> 4) * 10 + (low & 0xF);
    return (hi >> 4) + dec / 1000;
  }
};
exports.fixedPointNumber4Converter = fixedPointNumber4Converter;
const versionTypeConverter = {
  from: () => {
    throw new Error('versionType is readonly property');
  },
  to: value => typeof value === 'number' ? `${value >> 8 & 0xFF}.${value & 0xFF} [0x${(value >>> 16).toString(16)}]` : value
};
exports.versionTypeConverter = versionTypeConverter;

function getIntSize(type) {
  switch (type) {
    case 'xs:NMTOKEN':
    case 'xs:unsignedByte':
    case 'xs:byte':
      return 1;

    case 'xs:short':
    case 'xs:unsignedShort':
      return 2;

    case 'xs:int':
    case 'xs:unsignedInt':
      return 4;

    case 'xs:long':
    case 'xs:unsignedLong':
      return 8;
  }
}

function minInclusiveConverter(min) {
  const minIncl = parseFloat(min);
  return {
    from: value => typeof value === 'number' ? Math.max(value, minIncl) : value,
    to: value => value
  };
}

function maxInclusiveConverter(max) {
  const maxIncl = parseFloat(max);
  return {
    from: value => typeof value === 'number' ? Math.min(value, maxIncl) : value,
    to: value => value
  };
}

const convertTo = converters => value => converters.reduceRight((result, converter) => result !== undefined && converter.to(result), value);

exports.convertTo = convertTo;

const convertFrom = converters => value => converters.reduce((present, converter) => converter.from(present), value);

exports.convertFrom = convertFrom;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWIvbWliLnRzIl0sIm5hbWVzIjpbInZhbGlkSnNOYW1lIiwibmFtZSIsInJlcGxhY2UiLCJfIiwicyIsInRvVXBwZXJDYXNlIiwid2l0aFZhbHVlIiwidmFsdWUiLCJ3cml0YWJsZSIsImNvbmZpZ3VyYWJsZSIsImVudW1lcmFibGUiLCJoZXgiLCJpc0hleCIsInN0ciIsInRlc3QiLCJwYXJzZUludCIsInRvU3RyaW5nIiwidG9Mb3dlckNhc2UiLCJ0b0ludCIsInVuaXRDb252ZXJ0ZXIiLCJ1bml0IiwiZnJvbVJlIiwiUmVnRXhwIiwiZnJvbSIsInRvIiwicHJlY2lzaW9uQ29udmVydGVyIiwicHJlY2lzaW9uIiwiZm9ybWF0IiwicGFyc2VGbG9hdCIsImVudW1lcmF0aW9uQ29udmVydGVyIiwiZW51bWVyYXRpb25WYWx1ZXMiLCJzaW1wbGVUeXBlIiwia2V5cyIsIlJlZmxlY3QiLCJvd25LZXlzIiwiZm9yRWFjaCIsImtleSIsImluZGV4IiwiYW5ub3RhdGlvbiIsIlN0cmluZyIsImhhcyIsInNpbXBsZSIsIk51bWJlciIsImlzTmFOIiwieWVzIiwibm8iLCJib29sZWFuQ29udmVydGVyIiwicGVyY2VudENvbnZlcnRlciIsIk1hdGgiLCJtYXgiLCJtaW4iLCJyb3VuZCIsInJlcHJlc2VudGF0aW9uQ29udmVydGVyIiwic2l6ZSIsImZtdCIsInBhY2tlZDhmbG9hdENvbnZlcnRlciIsInN1YnR5cGUiLCJkZWx0YSIsImFwcGluZm8iLCJ6ZXJvIiwidmFsIiwiZmxvb3IiLCJmaXhlZFBvaW50TnVtYmVyNENvbnZlcnRlciIsImRlYyIsImhpIiwibG93IiwidmVyc2lvblR5cGVDb252ZXJ0ZXIiLCJFcnJvciIsImdldEludFNpemUiLCJ0eXBlIiwibWluSW5jbHVzaXZlQ29udmVydGVyIiwibWluSW5jbCIsIm1heEluY2x1c2l2ZUNvbnZlcnRlciIsIm1heEluY2wiLCJjb252ZXJ0VG8iLCJjb252ZXJ0ZXJzIiwicmVkdWNlUmlnaHQiLCJyZXN1bHQiLCJjb252ZXJ0ZXIiLCJ1bmRlZmluZWQiLCJjb252ZXJ0RnJvbSIsInJlZHVjZSIsInByZXNlbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQVVBOzs7O0FBVkE7Ozs7Ozs7OztBQWFPLFNBQVNBLFdBQVQsQ0FBcUJDLElBQXJCLEVBQW1DO0FBQ3hDLFNBQU9BLElBQUksQ0FBQ0MsT0FBTCxDQUFhLFFBQWIsRUFBdUIsQ0FBQ0MsQ0FBRCxFQUFJQyxDQUFKLEtBQVVBLENBQUMsQ0FBQyxDQUFELENBQUQsQ0FBS0MsV0FBTCxFQUFqQyxDQUFQO0FBQ0Q7O0FBRU0sTUFBTUMsU0FBUyxHQUFHLENBQUNDLEtBQUQsRUFBYUMsUUFBUSxHQUFHLEtBQXhCLE1BQXVEO0FBQzlFRCxFQUFBQSxLQUQ4RTtBQUU5RUMsRUFBQUEsUUFGOEU7QUFHOUVDLEVBQUFBLFlBQVksRUFBRSxLQUhnRTtBQUk5RUMsRUFBQUEsVUFBVSxFQUFFO0FBSmtFLENBQXZELENBQWxCOzs7QUFNUCxNQUFNQyxHQUFHLEdBQUcsZ0JBQVo7O0FBQ0EsTUFBTUMsS0FBSyxHQUFJQyxHQUFELElBQWlCRixHQUFHLENBQUNHLElBQUosQ0FBU0QsR0FBVCxLQUMxQkUsUUFBUSxDQUFDRixHQUFELEVBQU0sRUFBTixDQUFSLENBQWtCRyxRQUFsQixDQUEyQixFQUEzQixNQUFtQ0gsR0FBRyxDQUFDSSxXQUFKLEdBQWtCZixPQUFsQixDQUEwQixRQUExQixFQUFvQyxFQUFwQyxDQUR4Qzs7QUFHTyxNQUFNZ0IsS0FBSyxHQUFHLENBQUNYLEtBQWdDLEdBQUcsQ0FBcEMsS0FBa0Q7QUFDckUsTUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQXJCLEVBQStCLE9BQU9BLEtBQVA7QUFDL0IsTUFBSSxPQUFPQSxLQUFQLEtBQWlCLFNBQXJCLEVBQWdDLE9BQU9BLEtBQUssR0FBRyxDQUFILEdBQU8sQ0FBbkI7QUFDaEMsTUFBSUEsS0FBSyxLQUFLLE1BQWQsRUFBc0IsT0FBTyxDQUFQO0FBQ3RCLE1BQUlBLEtBQUssS0FBSyxPQUFkLEVBQXVCLE9BQU8sQ0FBUDtBQUN2QixTQUFPUSxRQUFRLENBQUNSLEtBQUQsRUFBUUssS0FBSyxDQUFDTCxLQUFELENBQUwsR0FBZSxFQUFmLEdBQW9CLEVBQTVCLENBQWY7QUFDRCxDQU5NOzs7O0FBZ0JBLFNBQVNZLGFBQVQsQ0FBdUJDLElBQXZCLEVBQWlEO0FBQ3RELFFBQU1DLE1BQU0sR0FBRyxJQUFJQyxNQUFKLENBQVksUUFBT0YsSUFBSyxRQUF4QixFQUFpQyxHQUFqQyxDQUFmO0FBQ0EsU0FBTztBQUNMRyxJQUFBQSxJQUFJLEVBQUVoQixLQUFLLElBQUksT0FBT0EsS0FBUCxLQUFpQixRQUFqQixHQUE0QkEsS0FBSyxDQUFDTCxPQUFOLENBQWNtQixNQUFkLEVBQXNCLEVBQXRCLENBQTVCLEdBQXdEZCxLQURsRTtBQUVMaUIsSUFBQUEsRUFBRSxFQUFFakIsS0FBSyxJQUFJQSxLQUFLLElBQUksSUFBVCxHQUFpQixHQUFFQSxLQUFNLEdBQUVhLElBQUssRUFBaEMsR0FBb0NiO0FBRjVDLEdBQVA7QUFJRDs7QUFFTSxTQUFTa0Isa0JBQVQsQ0FBNEJDLFNBQTVCLEVBQTJEO0FBQ2hFLFFBQU1DLE1BQU0sR0FBSSxLQUFJRCxTQUFVLEdBQTlCO0FBQ0EsU0FBTztBQUNMSCxJQUFBQSxJQUFJLEVBQUVoQixLQUFLLElBQUksT0FBT0EsS0FBUCxLQUFpQixRQUFqQixHQUE0QnFCLFVBQVUsQ0FBQ3JCLEtBQUQsQ0FBdEMsR0FBZ0RBLEtBRDFEO0FBRUxpQixJQUFBQSxFQUFFLEVBQUVqQixLQUFLLElBQUksT0FBT0EsS0FBUCxLQUFpQixRQUFqQixHQUE0QixxQkFBT29CLE1BQVAsRUFBZXBCLEtBQWYsQ0FBNUIsR0FBb0RBO0FBRjVELEdBQVA7QUFJRDs7QUFFTSxTQUFTc0Isb0JBQVQsQ0FDTEMsaUJBREssRUFFTEMsVUFGSyxFQUU0QjtBQUNqQyxRQUFNUixJQUFTLEdBQUcsRUFBbEI7QUFDQSxRQUFNQyxFQUFPLEdBQUcsRUFBaEI7QUFDQSxRQUFNUSxJQUFJLEdBQUdDLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQkosaUJBQWhCLENBQWI7QUFDQUUsRUFBQUEsSUFBSSxDQUFDRyxPQUFMLENBQWNDLEdBQUQsSUFBUztBQUNwQixVQUFNN0IsS0FBSyxHQUFHdUIsaUJBQWlCLENBQUVNLEdBQUYsQ0FBL0I7QUFDQSxVQUFNQyxLQUFLLEdBQUduQixLQUFLLENBQUNrQixHQUFELENBQW5CO0FBQ0FiLElBQUFBLElBQUksQ0FBQ2hCLEtBQUssQ0FBQytCLFVBQVAsQ0FBSixHQUF5QkQsS0FBekI7QUFDQWIsSUFBQUEsRUFBRSxDQUFDZSxNQUFNLENBQUNGLEtBQUQsQ0FBUCxDQUFGLEdBQW9COUIsS0FBSyxDQUFDK0IsVUFBMUI7QUFDRCxHQUxELEVBSmlDLENBVWpDOztBQUNBLFNBQU87QUFDTGYsSUFBQUEsSUFBSSxFQUFHaEIsS0FBRCxJQUFXO0FBQ2YsVUFBSTBCLE9BQU8sQ0FBQ08sR0FBUixDQUFZakIsSUFBWixFQUFrQmdCLE1BQU0sQ0FBQ2hDLEtBQUQsQ0FBeEIsQ0FBSixFQUFzQztBQUNwQyxlQUFPZ0IsSUFBSSxDQUFDZ0IsTUFBTSxDQUFDaEMsS0FBRCxDQUFQLENBQVg7QUFDRDs7QUFDRCxZQUFNa0MsTUFBTSxHQUFHdkIsS0FBSyxDQUFDWCxLQUFELENBQXBCO0FBQ0EsYUFBT21DLE1BQU0sQ0FBQ0MsS0FBUCxDQUFhRixNQUFiLElBQXVCbEMsS0FBdkIsR0FBK0JrQyxNQUF0QztBQUNELEtBUEk7QUFRTGpCLElBQUFBLEVBQUUsRUFBR2pCLEtBQUQsSUFBVztBQUNiLFVBQUk4QixLQUFzQixHQUFHbkIsS0FBSyxDQUFDWCxLQUFELENBQWxDO0FBQ0EsVUFBSW1DLE1BQU0sQ0FBQ0MsS0FBUCxDQUFhTixLQUFiLENBQUosRUFBeUJBLEtBQUssR0FBR0UsTUFBTSxDQUFDaEMsS0FBRCxDQUFkO0FBQ3pCLGFBQU8wQixPQUFPLENBQUNPLEdBQVIsQ0FBWWhCLEVBQVosRUFBZ0JlLE1BQU0sQ0FBQ0YsS0FBRCxDQUF0QixJQUFpQ2IsRUFBRSxDQUFDZSxNQUFNLENBQUNGLEtBQUQsQ0FBUCxDQUFuQyxHQUFxRDlCLEtBQTVEO0FBQ0Q7QUFaSSxHQUFQO0FBY0Q7O0FBRUQsTUFBTXFDLEdBQUcsR0FBRyw2QkFBWjtBQUNBLE1BQU1DLEVBQUUsR0FBRywrQkFBWDtBQUNPLE1BQU1DLGdCQUE0QixHQUFHO0FBQzFDdkIsRUFBQUEsSUFBSSxFQUFHaEIsS0FBRCxJQUFXO0FBQ2YsUUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQXJCLEVBQStCO0FBQzdCLFVBQUlxQyxHQUFHLENBQUM5QixJQUFKLENBQVNQLEtBQVQsQ0FBSixFQUFxQjtBQUNuQixlQUFPLElBQVA7QUFDRDs7QUFDRCxVQUFJc0MsRUFBRSxDQUFDL0IsSUFBSCxDQUFRUCxLQUFSLENBQUosRUFBb0I7QUFDbEIsZUFBTyxLQUFQO0FBQ0Q7QUFDRjs7QUFDRCxXQUFPQSxLQUFQO0FBQ0QsR0FYeUM7QUFZMUNpQixFQUFBQSxFQUFFLEVBQUdqQixLQUFELElBQVc7QUFDYixRQUFJLE9BQU9BLEtBQVAsS0FBaUIsU0FBckIsRUFBZ0M7QUFDOUIsYUFBT0EsS0FBSyxHQUFHLElBQUgsR0FBVSxLQUF0QjtBQUNEOztBQUNELFdBQU9BLEtBQVA7QUFDRDtBQWpCeUMsQ0FBckM7O0FBb0JBLE1BQU13QyxnQkFBNEIsR0FBRztBQUMxQ3hCLEVBQUFBLElBQUksRUFBRWhCLEtBQUssSUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQWpCLEdBQTRCeUMsSUFBSSxDQUFDQyxHQUFMLENBQVNELElBQUksQ0FBQ0UsR0FBTCxDQUNsREYsSUFBSSxDQUFDRyxLQUFMLENBQVc1QyxLQUFLLEdBQUcsR0FBUixHQUFjLEdBQXpCLENBRGtELEVBRWxELEdBRmtELENBQVQsRUFHeEMsQ0FId0MsQ0FBNUIsR0FHUEEsS0FKa0M7QUFLMUNpQixFQUFBQSxFQUFFLEVBQUVqQixLQUFLLElBQUksT0FBT0EsS0FBUCxLQUFpQixRQUFqQixHQUE0QnlDLElBQUksQ0FBQ0MsR0FBTCxDQUN2Q0QsSUFBSSxDQUFDRSxHQUFMLENBQVNGLElBQUksQ0FBQ0csS0FBTCxDQUFXNUMsS0FBSyxHQUFHLEdBQVIsR0FBYyxHQUF6QixDQUFULEVBQXdDLEdBQXhDLENBRHVDLEVBRXZDLENBRnVDLENBQTVCLEdBR1RBO0FBUnNDLENBQXJDOzs7QUFXQSxTQUFTNkMsdUJBQVQsQ0FBaUN6QixNQUFqQyxFQUFpRDBCLElBQWpELEVBQTJFO0FBQ2hGLE1BQUk5QixJQUFKO0FBQ0EsTUFBSUMsRUFBSjtBQUNBLE1BQUk4QixHQUFKLENBSGdGLENBSWhGOztBQUVBLFVBQVEzQixNQUFSO0FBQ0UsU0FBSyxJQUFMO0FBQ0EsU0FBSyxJQUFMO0FBQ0UyQixNQUFBQSxHQUFHLEdBQUksS0FBSUQsSUFBSSxHQUFHLENBQUUsR0FBcEI7O0FBQ0E5QixNQUFBQSxJQUFJLEdBQUdoQixLQUFLLElBQUksT0FBT0EsS0FBUCxLQUFpQixRQUFqQixHQUE0QlEsUUFBUSxDQUFDUixLQUFELEVBQVEsQ0FBUixDQUFwQyxHQUFpREEsS0FBakU7O0FBQ0FpQixNQUFBQSxFQUFFLEdBQUdqQixLQUFLLElBQUksT0FBT0EsS0FBUCxLQUFpQixRQUFqQixHQUE0QixxQkFBTytDLEdBQVAsRUFBWS9DLEtBQUssQ0FBQ1MsUUFBTixDQUFlLENBQWYsQ0FBWixDQUE1QixHQUE2RFQsS0FBM0U7O0FBQ0E7O0FBQ0YsU0FBSyxJQUFMO0FBQ0EsU0FBSyxJQUFMO0FBQ0UrQyxNQUFBQSxHQUFHLEdBQUksS0FBSUQsSUFBSyxHQUFoQjs7QUFDQTlCLE1BQUFBLElBQUksR0FBR2hCLEtBQUssSUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQWpCLEdBQTRCUSxRQUFRLENBQUNSLEtBQUQsRUFBUSxFQUFSLENBQXBDLEdBQWtEQSxLQUFsRTs7QUFDQWlCLE1BQUFBLEVBQUUsR0FBR2pCLEtBQUssSUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQWpCLEdBQTRCLHFCQUFPK0MsR0FBUCxFQUFZL0MsS0FBSyxDQUFDUyxRQUFOLENBQWUsRUFBZixDQUFaLENBQTVCLEdBQThEVCxLQUE1RTs7QUFDQTs7QUFDRjtBQUNFZ0IsTUFBQUEsSUFBSSxHQUFHaEIsS0FBSyxJQUFJQSxLQUFoQjs7QUFDQWlCLE1BQUFBLEVBQUUsR0FBR0QsSUFBTDtBQWZKOztBQWtCQSxTQUFPO0FBQ0xBLElBQUFBLElBREs7QUFFTEMsSUFBQUE7QUFGSyxHQUFQO0FBSUQ7O0FBRU0sU0FBUytCLHFCQUFULENBQStCQyxPQUEvQixFQUE4RDtBQUNuRSxNQUFJQyxLQUFLLEdBQUcsQ0FBWjs7QUFDQSxNQUFJRCxPQUFPLENBQUNFLE9BQVIsSUFBbUJGLE9BQU8sQ0FBQ0UsT0FBUixDQUFnQkMsSUFBdkMsRUFBNkM7QUFDM0NGLElBQUFBLEtBQUssR0FBRzdCLFVBQVUsQ0FBQzRCLE9BQU8sQ0FBQ0UsT0FBUixDQUFnQkMsSUFBakIsQ0FBVixJQUFvQyxDQUE1QztBQUNEOztBQUNELFNBQU87QUFDTHBDLElBQUFBLElBQUksRUFBR2hCLEtBQUQsSUFBVztBQUNmLFlBQU1xRCxHQUFHLEdBQUcsT0FBT3JELEtBQVAsS0FBaUIsUUFBakIsR0FBNEJxQixVQUFVLENBQUNyQixLQUFELENBQXRDLEdBQWdEQSxLQUE1RDtBQUNBLGFBQU8sT0FBT3FELEdBQVAsS0FBZSxRQUFmLEdBQTBCWixJQUFJLENBQUNhLEtBQUwsQ0FBVyxDQUFDRCxHQUFHLEdBQUdILEtBQVAsSUFBZ0IsR0FBM0IsSUFBa0MsSUFBNUQsR0FBbUVHLEdBQTFFO0FBQ0QsS0FKSTtBQUtMcEMsSUFBQUEsRUFBRSxFQUFFakIsS0FBSyxJQUFJLE9BQU9BLEtBQVAsS0FBaUIsUUFBakIsR0FBNEJBLEtBQUssR0FBRyxHQUFSLEdBQWNrRCxLQUExQyxHQUFrRGxEO0FBTDFELEdBQVA7QUFPRDs7QUFFTSxNQUFNdUQsMEJBQXNDLEdBQUc7QUFDcER2QyxFQUFBQSxJQUFJLEVBQUdoQixLQUFELElBQVc7QUFDZixVQUFNcUQsR0FBRyxHQUFHLE9BQU9yRCxLQUFQLEtBQWlCLFFBQWpCLEdBQTRCcUIsVUFBVSxDQUFDckIsS0FBRCxDQUF0QyxHQUFnREEsS0FBNUQ7O0FBQ0EsUUFBSSxPQUFPcUQsR0FBUCxLQUFlLFFBQW5CLEVBQTZCO0FBQzNCLGFBQU9BLEdBQVA7QUFDRDs7QUFDRCxVQUFNRyxHQUFHLEdBQUdmLElBQUksQ0FBQ0csS0FBTCxDQUFXUyxHQUFHLEdBQUcsSUFBakIsSUFBeUIsSUFBckM7QUFDQSxVQUFNSSxFQUFFLEdBQUksQ0FBQ2hCLElBQUksQ0FBQ2EsS0FBTCxDQUFXRCxHQUFYLEtBQW1CLENBQXBCLElBQXlCWixJQUFJLENBQUNhLEtBQUwsQ0FBV0UsR0FBRyxHQUFHLEdBQWpCLENBQTFCLEdBQW1ELElBQTlEO0FBQ0EsVUFBTUUsR0FBRyxHQUFJRixHQUFHLEdBQUcsRUFBTixJQUFhZixJQUFJLENBQUNhLEtBQUwsQ0FBV0UsR0FBRyxHQUFHLEVBQWpCLElBQXVCLEVBQXhCLElBQStCLENBQTNDLENBQUQsR0FBa0QsSUFBOUQ7QUFDQSxXQUFRQyxFQUFFLElBQUksQ0FBUCxHQUFZQyxHQUFuQjtBQUNELEdBVm1EO0FBV3BEekMsRUFBQUEsRUFBRSxFQUFHakIsS0FBRCxJQUFXO0FBQ2IsUUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQXJCLEVBQStCO0FBQzdCLGFBQU9BLEtBQVA7QUFDRDs7QUFDRCxVQUFNeUQsRUFBRSxHQUFJekQsS0FBSyxJQUFJLENBQVYsR0FBZSxJQUExQjtBQUNBLFVBQU0wRCxHQUFHLEdBQUcxRCxLQUFLLEdBQUcsSUFBcEI7QUFDQSxVQUFNd0QsR0FBRyxHQUFHLENBQUNDLEVBQUUsR0FBRyxHQUFOLElBQWEsR0FBYixHQUFtQixDQUFDQyxHQUFHLElBQUksQ0FBUixJQUFhLEVBQWhDLElBQXNDQSxHQUFHLEdBQUcsR0FBNUMsQ0FBWjtBQUNBLFdBQU8sQ0FBQ0QsRUFBRSxJQUFJLENBQVAsSUFBWUQsR0FBRyxHQUFHLElBQXpCO0FBQ0Q7QUFuQm1ELENBQS9DOztBQXNCQSxNQUFNRyxvQkFBZ0MsR0FBRztBQUM5QzNDLEVBQUFBLElBQUksRUFBRSxNQUFNO0FBQ1YsVUFBTSxJQUFJNEMsS0FBSixDQUFVLGtDQUFWLENBQU47QUFDRCxHQUg2QztBQUk5QzNDLEVBQUFBLEVBQUUsRUFBRWpCLEtBQUssSUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQWpCLEdBQ1IsR0FBR0EsS0FBSyxJQUFJLENBQVYsR0FBZSxJQUFLLElBQUdBLEtBQUssR0FBRyxJQUFLLE9BQU0sQ0FBQ0EsS0FBSyxLQUFLLEVBQVgsRUFBZVMsUUFBZixDQUF3QixFQUF4QixDQUE0QixHQURoRSxHQUVUVDtBQU4wQyxDQUF6Qzs7O0FBU0EsU0FBUzZELFVBQVQsQ0FBb0JDLElBQXBCLEVBQWtDO0FBQ3ZDLFVBQVFBLElBQVI7QUFDRSxTQUFLLFlBQUw7QUFDQSxTQUFLLGlCQUFMO0FBQ0EsU0FBSyxTQUFMO0FBQ0UsYUFBTyxDQUFQOztBQUNGLFNBQUssVUFBTDtBQUNBLFNBQUssa0JBQUw7QUFDRSxhQUFPLENBQVA7O0FBQ0YsU0FBSyxRQUFMO0FBQ0EsU0FBSyxnQkFBTDtBQUNFLGFBQU8sQ0FBUDs7QUFDRixTQUFLLFNBQUw7QUFDQSxTQUFLLGlCQUFMO0FBQ0UsYUFBTyxDQUFQO0FBYko7QUFlRDs7QUFFTSxTQUFTQyxxQkFBVCxDQUErQnBCLEdBQS9CLEVBQXdEO0FBQzdELFFBQU1xQixPQUFPLEdBQUczQyxVQUFVLENBQUNzQixHQUFELENBQTFCO0FBQ0EsU0FBTztBQUNMM0IsSUFBQUEsSUFBSSxFQUFFaEIsS0FBSyxJQUFJLE9BQU9BLEtBQVAsS0FBaUIsUUFBakIsR0FBNkJ5QyxJQUFJLENBQUNDLEdBQUwsQ0FBUzFDLEtBQVQsRUFBZ0JnRSxPQUFoQixDQUE3QixHQUF3RGhFLEtBRGxFO0FBRUxpQixJQUFBQSxFQUFFLEVBQUVqQixLQUFLLElBQUlBO0FBRlIsR0FBUDtBQUlEOztBQUVNLFNBQVNpRSxxQkFBVCxDQUErQnZCLEdBQS9CLEVBQXdEO0FBQzdELFFBQU13QixPQUFPLEdBQUc3QyxVQUFVLENBQUNxQixHQUFELENBQTFCO0FBQ0EsU0FBTztBQUNMMUIsSUFBQUEsSUFBSSxFQUFFaEIsS0FBSyxJQUFJLE9BQU9BLEtBQVAsS0FBaUIsUUFBakIsR0FBNEJ5QyxJQUFJLENBQUNFLEdBQUwsQ0FBUzNDLEtBQVQsRUFBZ0JrRSxPQUFoQixDQUE1QixHQUF1RGxFLEtBRGpFO0FBRUxpQixJQUFBQSxFQUFFLEVBQUVqQixLQUFLLElBQUlBO0FBRlIsR0FBUDtBQUlEOztBQUVNLE1BQU1tRSxTQUFTLEdBQUlDLFVBQUQsSUFBK0JwRSxLQUFELElBQ3JEb0UsVUFBVSxDQUFDQyxXQUFYLENBQ0UsQ0FBQ0MsTUFBRCxFQUFTQyxTQUFULEtBQXVCRCxNQUFNLEtBQUtFLFNBQVgsSUFBd0JELFNBQVMsQ0FBQ3RELEVBQVYsQ0FBYXFELE1BQWIsQ0FEakQsRUFFRXRFLEtBRkYsQ0FESzs7OztBQU1BLE1BQU15RSxXQUFXLEdBQUlMLFVBQUQsSUFBK0JwRSxLQUFELElBQ3ZEb0UsVUFBVSxDQUFDTSxNQUFYLENBQWtCLENBQUNDLE9BQUQsRUFBVUosU0FBVixLQUF3QkEsU0FBUyxDQUFDdkQsSUFBVixDQUFlMkQsT0FBZixDQUExQyxFQUFtRTNFLEtBQW5FLENBREsiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoYykgMjAxOS4gT09PIE5hdGEtSW5mb1xuICogQGF1dGhvciBBbmRyZWkgU2FyYWtlZXYgPGF2c0BuYXRhLWluZm8ucnU+XG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIFwiQG5hdGFcIiBwcm9qZWN0LlxuICogRm9yIHRoZSBmdWxsIGNvcHlyaWdodCBhbmQgbGljZW5zZSBpbmZvcm1hdGlvbiwgcGxlYXNlIHZpZXdcbiAqIHRoZSBFVUxBIGZpbGUgdGhhdCB3YXMgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHNvdXJjZSBjb2RlLlxuICovXG5cbmltcG9ydCBwcmludGYgZnJvbSAncHJpbnRmJztcbmltcG9ydCB7IElNaWJUeXBlIH0gZnJvbSAnLi9kZXZpY2VzJztcblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkSnNOYW1lKG5hbWU6IHN0cmluZykge1xuICByZXR1cm4gbmFtZS5yZXBsYWNlKC8oX1xcdykvZywgKF8sIHMpID0+IHNbMV0udG9VcHBlckNhc2UoKSk7XG59XG5cbmV4cG9ydCBjb25zdCB3aXRoVmFsdWUgPSAodmFsdWU6IGFueSwgd3JpdGFibGUgPSBmYWxzZSk6IFByb3BlcnR5RGVzY3JpcHRvciA9PiAoe1xuICB2YWx1ZSxcbiAgd3JpdGFibGUsXG4gIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gIGVudW1lcmFibGU6IHRydWUsXG59KTtcbmNvbnN0IGhleCA9IC9eMFhbMC05QS1GXSskL2k7XG5jb25zdCBpc0hleCA9IChzdHI6IHN0cmluZykgPT4gaGV4LnRlc3Qoc3RyKVxuICB8fCBwYXJzZUludChzdHIsIDEwKS50b1N0cmluZygxMCkgIT09IHN0ci50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL15bMCBdKy8sICcnKTtcblxuZXhwb3J0IGNvbnN0IHRvSW50ID0gKHZhbHVlOiBzdHJpbmcgfCBib29sZWFuIHwgbnVtYmVyID0gMCk6IG51bWJlciA9PiB7XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSByZXR1cm4gdmFsdWU7XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIHZhbHVlID8gMSA6IDA7XG4gIGlmICh2YWx1ZSA9PT0gJ3RydWUnKSByZXR1cm4gMTtcbiAgaWYgKHZhbHVlID09PSAnZmFsc2UnKSByZXR1cm4gMDtcbiAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCBpc0hleCh2YWx1ZSkgPyAxNiA6IDEwKTtcbn07XG5cbnR5cGUgUmVzdWx0VHlwZSA9IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG50eXBlIFByZXNlbnRUeXBlID0gc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IHVuZGVmaW5lZDtcblxuZXhwb3J0IGludGVyZmFjZSBJQ29udmVydGVyIHtcbiAgZnJvbTogKHZhbHVlOiBQcmVzZW50VHlwZSkgPT4gUmVzdWx0VHlwZTtcbiAgdG86ICh2YWx1ZTogUmVzdWx0VHlwZSkgPT4gUHJlc2VudFR5cGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1bml0Q29udmVydGVyKHVuaXQ6IHN0cmluZyk6IElDb252ZXJ0ZXIge1xuICBjb25zdCBmcm9tUmUgPSBuZXcgUmVnRXhwKGAoXFxcXHMqJHt1bml0fVxcXFxzKikkYCwgJ2knKTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gdmFsdWUucmVwbGFjZShmcm9tUmUsICcnKSA6IHZhbHVlLFxuICAgIHRvOiB2YWx1ZSA9PiB2YWx1ZSAhPSBudWxsID8gYCR7dmFsdWV9JHt1bml0fWAgOiB2YWx1ZSxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByZWNpc2lvbkNvbnZlcnRlcihwcmVjaXNpb246IHN0cmluZyk6IElDb252ZXJ0ZXIge1xuICBjb25zdCBmb3JtYXQgPSBgJS4ke3ByZWNpc2lvbn1mYDtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gcGFyc2VGbG9hdCh2YWx1ZSkgOiB2YWx1ZSxcbiAgICB0bzogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IHByaW50Zihmb3JtYXQsIHZhbHVlKSA6IHZhbHVlLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZW51bWVyYXRpb25Db252ZXJ0ZXIoXG4gIGVudW1lcmF0aW9uVmFsdWVzOiBJTWliVHlwZVsnZW51bWVyYXRpb24nXSxcbiAgc2ltcGxlVHlwZT86IHN0cmluZyk6IElDb252ZXJ0ZXIge1xuICBjb25zdCBmcm9tOiBhbnkgPSB7fTtcbiAgY29uc3QgdG86IGFueSA9IHt9O1xuICBjb25zdCBrZXlzID0gUmVmbGVjdC5vd25LZXlzKGVudW1lcmF0aW9uVmFsdWVzISkgYXMgc3RyaW5nW107XG4gIGtleXMuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgY29uc3QgdmFsdWUgPSBlbnVtZXJhdGlvblZhbHVlcyFba2V5XTtcbiAgICBjb25zdCBpbmRleCA9IHRvSW50KGtleSk7XG4gICAgZnJvbVt2YWx1ZS5hbm5vdGF0aW9uXSA9IGluZGV4O1xuICAgIHRvW1N0cmluZyhpbmRleCldID0gdmFsdWUuYW5ub3RhdGlvbjtcbiAgfSk7XG4gIC8vIGNvbnNvbGUubG9nKCdmcm9tICVvLCB0byAlbycsIGZyb20sIHRvKTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiAodmFsdWUpID0+IHtcbiAgICAgIGlmIChSZWZsZWN0Lmhhcyhmcm9tLCBTdHJpbmcodmFsdWUpKSkge1xuICAgICAgICByZXR1cm4gZnJvbVtTdHJpbmcodmFsdWUpXTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHNpbXBsZSA9IHRvSW50KHZhbHVlKTtcbiAgICAgIHJldHVybiBOdW1iZXIuaXNOYU4oc2ltcGxlKSA/IHZhbHVlIDogc2ltcGxlO1xuICAgIH0sXG4gICAgdG86ICh2YWx1ZSkgPT4ge1xuICAgICAgbGV0IGluZGV4OiBudW1iZXIgfCBzdHJpbmcgPSB0b0ludCh2YWx1ZSk7XG4gICAgICBpZiAoTnVtYmVyLmlzTmFOKGluZGV4KSkgaW5kZXggPSBTdHJpbmcodmFsdWUpO1xuICAgICAgcmV0dXJuIFJlZmxlY3QuaGFzKHRvLCBTdHJpbmcoaW5kZXgpKSA/IHRvW1N0cmluZyhpbmRleCldIDogdmFsdWU7XG4gICAgfSxcbiAgfTtcbn1cblxuY29uc3QgeWVzID0gL15cXHMqKHllc3xvbnx0cnVlfDF80LTQsClcXHMqJC9pO1xuY29uc3Qgbm8gPSAvXlxccyoobm98b2ZmfGZhbHNlfDB80L3QtdGCKVxccyokL2k7XG5leHBvcnQgY29uc3QgYm9vbGVhbkNvbnZlcnRlcjogSUNvbnZlcnRlciA9IHtcbiAgZnJvbTogKHZhbHVlKSA9PiB7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGlmICh5ZXMudGVzdCh2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICBpZiAobm8udGVzdCh2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH0sXG4gIHRvOiAodmFsdWUpID0+IHtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcbiAgICAgIHJldHVybiB2YWx1ZSA/ICfQlNCwJyA6ICfQndC10YInO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH0sXG59O1xuXG5leHBvcnQgY29uc3QgcGVyY2VudENvbnZlcnRlcjogSUNvbnZlcnRlciA9IHtcbiAgZnJvbTogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IE1hdGgubWF4KE1hdGgubWluKFxuICAgIE1hdGgucm91bmQodmFsdWUgKiAyNTUgLyAxMDApLFxuICAgIDI1NSxcbiAgKSwgMCkgOiB2YWx1ZSxcbiAgdG86IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPyBNYXRoLm1heChcbiAgICBNYXRoLm1pbihNYXRoLnJvdW5kKHZhbHVlICogMTAwIC8gMjU1KSwgMTAwKSxcbiAgICAwLFxuICApIDogdmFsdWUsXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gcmVwcmVzZW50YXRpb25Db252ZXJ0ZXIoZm9ybWF0OiBzdHJpbmcsIHNpemU6IG51bWJlcik6IElDb252ZXJ0ZXIge1xuICBsZXQgZnJvbTogSUNvbnZlcnRlclsnZnJvbSddO1xuICBsZXQgdG86IElDb252ZXJ0ZXJbJ3RvJ107XG4gIGxldCBmbXQ6IHN0cmluZztcbiAgLy8gZnJvbUZuID0gdG9GbiA9IGZ1bmN0aW9uICh2YWx1ZSkgeyByZXR1cm4gdmFsdWU7IH07XG5cbiAgc3dpdGNoIChmb3JtYXQpIHtcbiAgICBjYXNlICclYic6XG4gICAgY2FzZSAnJUInOlxuICAgICAgZm10ID0gYCUwJHtzaXplICogOH1zYDtcbiAgICAgIGZyb20gPSB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gcGFyc2VJbnQodmFsdWUsIDIpIDogdmFsdWU7XG4gICAgICB0byA9IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPyBwcmludGYoZm10LCB2YWx1ZS50b1N0cmluZygyKSkgOiB2YWx1ZTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJyV4JzpcbiAgICBjYXNlICclWCc6XG4gICAgICBmbXQgPSBgJTAke3NpemV9c2A7XG4gICAgICBmcm9tID0gdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHBhcnNlSW50KHZhbHVlLCAxNikgOiB2YWx1ZTtcbiAgICAgIHRvID0gdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IHByaW50ZihmbXQsIHZhbHVlLnRvU3RyaW5nKDE2KSkgOiB2YWx1ZTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICBmcm9tID0gdmFsdWUgPT4gdmFsdWU7XG4gICAgICB0byA9IGZyb207XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGZyb20sXG4gICAgdG8sXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYWNrZWQ4ZmxvYXRDb252ZXJ0ZXIoc3VidHlwZTogSU1pYlR5cGUpOiBJQ29udmVydGVyIHtcbiAgbGV0IGRlbHRhID0gMDtcbiAgaWYgKHN1YnR5cGUuYXBwaW5mbyAmJiBzdWJ0eXBlLmFwcGluZm8uemVybykge1xuICAgIGRlbHRhID0gcGFyc2VGbG9hdChzdWJ0eXBlLmFwcGluZm8uemVybykgfHwgMDtcbiAgfVxuICByZXR1cm4ge1xuICAgIGZyb206ICh2YWx1ZSkgPT4ge1xuICAgICAgY29uc3QgdmFsID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHBhcnNlRmxvYXQodmFsdWUpIDogdmFsdWU7XG4gICAgICByZXR1cm4gdHlwZW9mIHZhbCA9PT0gJ251bWJlcicgPyBNYXRoLmZsb29yKCh2YWwgLSBkZWx0YSkgKiAxMDApICYgMHhGRiA6IHZhbDtcbiAgICB9LFxuICAgIHRvOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8gdmFsdWUgLyAxMDAgKyBkZWx0YSA6IHZhbHVlLFxuICB9O1xufVxuXG5leHBvcnQgY29uc3QgZml4ZWRQb2ludE51bWJlcjRDb252ZXJ0ZXI6IElDb252ZXJ0ZXIgPSB7XG4gIGZyb206ICh2YWx1ZSkgPT4ge1xuICAgIGNvbnN0IHZhbCA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBwYXJzZUZsb2F0KHZhbHVlKSA6IHZhbHVlO1xuICAgIGlmICh0eXBlb2YgdmFsICE9PSAnbnVtYmVyJykge1xuICAgICAgcmV0dXJuIHZhbDtcbiAgICB9XG4gICAgY29uc3QgZGVjID0gTWF0aC5yb3VuZCh2YWwgKiAxMDAwKSAlIDEwMDA7XG4gICAgY29uc3QgaGkgPSAoKE1hdGguZmxvb3IodmFsKSA8PCA0KSArIE1hdGguZmxvb3IoZGVjIC8gMTAwKSkgJiAweEZGO1xuICAgIGNvbnN0IGxvdyA9IChkZWMgJSAxMCArICgoTWF0aC5mbG9vcihkZWMgLyAxMCkgJSAxMCkgPDwgNCkpICYgMHhGRjtcbiAgICByZXR1cm4gKGhpIDw8IDgpIHwgbG93O1xuICB9LFxuICB0bzogKHZhbHVlKSA9PiB7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ251bWJlcicpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgY29uc3QgaGkgPSAodmFsdWUgPj4gOCkgJiAweEZGO1xuICAgIGNvbnN0IGxvdyA9IHZhbHVlICYgMHhGRjtcbiAgICBjb25zdCBkZWMgPSAoaGkgJiAweEYpICogMTAwICsgKGxvdyA+PiA0KSAqIDEwICsgKGxvdyAmIDB4Rik7XG4gICAgcmV0dXJuIChoaSA+PiA0KSArIGRlYyAvIDEwMDA7XG4gIH0sXG59O1xuXG5leHBvcnQgY29uc3QgdmVyc2lvblR5cGVDb252ZXJ0ZXI6IElDb252ZXJ0ZXIgPSB7XG4gIGZyb206ICgpID0+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3ZlcnNpb25UeXBlIGlzIHJlYWRvbmx5IHByb3BlcnR5Jyk7XG4gIH0sXG4gIHRvOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInXG4gICAgPyBgJHsodmFsdWUgPj4gOCkgJiAweEZGfS4ke3ZhbHVlICYgMHhGRn0gWzB4JHsodmFsdWUgPj4+IDE2KS50b1N0cmluZygxNil9XWBcbiAgICA6IHZhbHVlLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldEludFNpemUodHlwZTogc3RyaW5nKSB7XG4gIHN3aXRjaCAodHlwZSkge1xuICAgIGNhc2UgJ3hzOk5NVE9LRU4nOlxuICAgIGNhc2UgJ3hzOnVuc2lnbmVkQnl0ZSc6XG4gICAgY2FzZSAneHM6Ynl0ZSc6XG4gICAgICByZXR1cm4gMTtcbiAgICBjYXNlICd4czpzaG9ydCc6XG4gICAgY2FzZSAneHM6dW5zaWduZWRTaG9ydCc6XG4gICAgICByZXR1cm4gMjtcbiAgICBjYXNlICd4czppbnQnOlxuICAgIGNhc2UgJ3hzOnVuc2lnbmVkSW50JzpcbiAgICAgIHJldHVybiA0O1xuICAgIGNhc2UgJ3hzOmxvbmcnOlxuICAgIGNhc2UgJ3hzOnVuc2lnbmVkTG9uZyc6XG4gICAgICByZXR1cm4gODtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWluSW5jbHVzaXZlQ29udmVydGVyKG1pbjogc3RyaW5nKTogSUNvbnZlcnRlciB7XG4gIGNvbnN0IG1pbkluY2wgPSBwYXJzZUZsb2F0KG1pbik7XG4gIHJldHVybiB7XG4gICAgZnJvbTogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/ICBNYXRoLm1heCh2YWx1ZSwgbWluSW5jbCkgOiB2YWx1ZSxcbiAgICB0bzogdmFsdWUgPT4gdmFsdWUsXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYXhJbmNsdXNpdmVDb252ZXJ0ZXIobWF4OiBzdHJpbmcpOiBJQ29udmVydGVyIHtcbiAgY29uc3QgbWF4SW5jbCA9IHBhcnNlRmxvYXQobWF4KTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8gTWF0aC5taW4odmFsdWUsIG1heEluY2wpIDogdmFsdWUsXG4gICAgdG86IHZhbHVlID0+IHZhbHVlLFxuICB9O1xufVxuXG5leHBvcnQgY29uc3QgY29udmVydFRvID0gKGNvbnZlcnRlcnM6IElDb252ZXJ0ZXJbXSkgPT4gKHZhbHVlOiBSZXN1bHRUeXBlKSA9PlxuICBjb252ZXJ0ZXJzLnJlZHVjZVJpZ2h0KFxuICAgIChyZXN1bHQsIGNvbnZlcnRlcikgPT4gcmVzdWx0ICE9PSB1bmRlZmluZWQgJiYgY29udmVydGVyLnRvKHJlc3VsdCksXG4gICAgdmFsdWUsXG4gICk7XG5cbmV4cG9ydCBjb25zdCBjb252ZXJ0RnJvbSA9IChjb252ZXJ0ZXJzOiBJQ29udmVydGVyW10pID0+ICh2YWx1ZTogUHJlc2VudFR5cGUpID0+XG4gIGNvbnZlcnRlcnMucmVkdWNlKChwcmVzZW50LCBjb252ZXJ0ZXIpID0+IGNvbnZlcnRlci5mcm9tKHByZXNlbnQpLCB2YWx1ZSk7XG4iXX0=