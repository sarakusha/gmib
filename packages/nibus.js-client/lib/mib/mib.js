"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validJsName = validJsName;
exports.unitConverter = unitConverter;
exports.precisionConverter = precisionConverter;
exports.enumerationConverter = enumerationConverter;
exports.representationConverter = representationConverter;
exports.packed8floatConverter = packed8floatConverter;
exports.getIntSize = getIntSize;
exports.minInclusiveConverter = minInclusiveConverter;
exports.maxInclusiveConverter = maxInclusiveConverter;
exports.convertFrom = exports.convertTo = exports.versionTypeConverter = exports.fixedPointNumber4Converter = exports.percentConverter = exports.booleanConverter = exports.toInt = exports.withValue = void 0;

require("source-map-support/register");

var _printf = _interopRequireDefault(require("printf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * @license
 * Copyright (c) 2019. OOO Nata-Info
 * @author Andrei Sarakeev <avs@nata-info.ru>
 *
 * This file is part of the "@nata" project.
 * For the full copyright and license information, please view
 * the EULA file that was distributed with this source code.
 */
function validJsName(name) {
  return name.replace(/(_\w)/g, (_, s) => s[1].toUpperCase());
}

const withValue = (value, writable = false) => ({
  value,
  writable,
  configurable: false,
  enumerable: true
});

exports.withValue = withValue;
const hex = /^0X[0-9A-F]+$/i;

const isHex = str => hex.test(str) || parseInt(str, 10).toString(10) !== str.toLowerCase().replace(/^[0 ]+/, '');

const toInt = (value = 0) => {
  if (typeof value === 'number') return value;
  if (typeof value === 'boolean') return value ? 1 : 0;
  if (value === 'true') return 1;
  if (value === 'false') return 0;
  return parseInt(value, isHex(value) ? 16 : 10);
};

exports.toInt = toInt;

function unitConverter(unit) {
  const fromRe = new RegExp(`(\\s*${unit}\\s*)$`, 'i');
  return {
    from: value => typeof value === 'string' ? value.replace(fromRe, '') : value,
    to: value => value != null ? `${value}${unit}` : value
  };
}

function precisionConverter(precision) {
  const format = `%.${precision}f`;
  return {
    from: value => typeof value === 'string' ? parseFloat(value) : value,
    to: value => typeof value === 'number' ? (0, _printf.default)(format, value) : value
  };
}

function enumerationConverter(enumerationValues) {
  const from = {};
  const to = {};
  const keys = Reflect.ownKeys(enumerationValues);
  keys.forEach(key => {
    const value = enumerationValues[key];
    const index = toInt(key);
    from[value.annotation] = index;
    to[index] = value.annotation;
  }); // console.log('from %o, to %o', from, to);

  return {
    from: value => {
      if (typeof value === 'string' && Reflect.has(from, value)) return from[value];
      const simple = toInt(value);
      return Number.isNaN(simple) ? value : simple;
    },
    to: value => (typeof value === 'number' || typeof value === 'string') && Reflect.has(to, value) ? to[value] : value
  };
}

const yes = /^\s*(yes|on|true|1|да)\s*$/i;
const no = /^\s*(no|off|false|0|нет)\s*$/i;
const booleanConverter = {
  from: value => {
    if (typeof value === 'string') {
      if (yes.test(value)) {
        return true;
      }

      if (no.test(value)) {
        return false;
      }
    }

    return value;
  },
  to: value => {
    if (typeof value === 'boolean') {
      return value ? 'Да' : 'Нет';
    }

    return value;
  }
};
exports.booleanConverter = booleanConverter;
const percentConverter = {
  from: value => typeof value === 'number' ? Math.max(Math.min(Math.round(value * 255 / 100), 255), 0) : value,
  to: value => typeof value === 'number' ? Math.max(Math.min(Math.round(value * 100 / 255), 100), 0) : value
};
exports.percentConverter = percentConverter;

function representationConverter(format, size) {
  let from;
  let to;
  let fmt; // fromFn = toFn = function (value) { return value; };

  switch (format) {
    case '%b':
    case '%B':
      fmt = `%0${size * 8}s`;

      from = value => typeof value === 'string' ? parseInt(value, 2) : value;

      to = value => typeof value === 'number' ? (0, _printf.default)(fmt, value.toString(2)) : value;

      break;

    case '%x':
    case '%X':
      fmt = `%0${size}s`;

      from = value => typeof value === 'string' ? parseInt(value, 16) : value;

      to = value => typeof value === 'number' ? (0, _printf.default)(fmt, value.toString(16)) : value;

      break;

    default:
      from = value => value;

      to = from;
  }

  return {
    from,
    to
  };
}

function packed8floatConverter(subtype) {
  let delta = 0;

  if (subtype.appinfo && subtype.appinfo.zero) {
    delta = parseFloat(subtype.appinfo.zero) || 0;
  }

  return {
    from: value => {
      const val = typeof value === 'string' ? parseFloat(value) : value;
      return typeof val === 'number' ? Math.floor((val - delta) * 100) & 0xFF : val;
    },
    to: value => typeof value === 'number' ? value / 100 + delta : value
  };
}

const fixedPointNumber4Converter = {
  from: value => {
    const val = typeof value === 'string' ? parseFloat(value) : value;

    if (typeof val !== 'number') {
      return val;
    }

    const dec = Math.round(val * 1000) % 1000;
    const hi = (Math.floor(val) << 4) + Math.floor(dec / 100) & 0xFF;
    const low = dec % 10 + (Math.floor(dec / 10) % 10 << 4) & 0xFF;
    return hi << 8 | low;
  },
  to: value => {
    if (typeof value !== 'number') {
      return value;
    }

    const hi = value >> 8 & 0xFF;
    const low = value & 0xFF;
    const dec = (hi & 0xF) * 100 + (low >> 4) * 10 + (low & 0xF);
    return (hi >> 4) + dec / 1000;
  }
};
exports.fixedPointNumber4Converter = fixedPointNumber4Converter;
const versionTypeConverter = {
  from: () => {
    throw new Error('versionType is readonly property');
  },
  to: value => typeof value === 'number' ? `${value >> 8 & 0xFF}.${value & 0xFF} [0x${(value >>> 16).toString(16)}]` : value
};
exports.versionTypeConverter = versionTypeConverter;

function getIntSize(type) {
  switch (type) {
    case 'xs:NMTOKEN':
    case 'xs:unsignedByte':
    case 'xs:byte':
      return 1;

    case 'xs:short':
    case 'xs:unsignedShort':
      return 2;

    case 'xs:int':
    case 'xs:unsignedInt':
      return 4;

    case 'xs:long':
    case 'xs:unsignedLong':
      return 8;
  }
}

function minInclusiveConverter(min) {
  const minIncl = parseFloat(min);
  return {
    from: value => Math.max(value, minIncl),
    to: value => value
  };
}

function maxInclusiveConverter(max) {
  const maxIncl = parseFloat(max);
  return {
    from: value => Math.min(value, maxIncl),
    to: value => value
  };
}

const convertTo = converters => value => converters.reduceRight((result, converter) => result !== undefined && converter.to(result), value);

exports.convertTo = convertTo;

const convertFrom = converters => value => converters.reduce((present, converter) => converter.from(present), value);

exports.convertFrom = convertFrom;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWIvbWliLnRzIl0sIm5hbWVzIjpbInZhbGlkSnNOYW1lIiwibmFtZSIsInJlcGxhY2UiLCJfIiwicyIsInRvVXBwZXJDYXNlIiwid2l0aFZhbHVlIiwidmFsdWUiLCJ3cml0YWJsZSIsImNvbmZpZ3VyYWJsZSIsImVudW1lcmFibGUiLCJoZXgiLCJpc0hleCIsInN0ciIsInRlc3QiLCJwYXJzZUludCIsInRvU3RyaW5nIiwidG9Mb3dlckNhc2UiLCJ0b0ludCIsInVuaXRDb252ZXJ0ZXIiLCJ1bml0IiwiZnJvbVJlIiwiUmVnRXhwIiwiZnJvbSIsInRvIiwicHJlY2lzaW9uQ29udmVydGVyIiwicHJlY2lzaW9uIiwiZm9ybWF0IiwicGFyc2VGbG9hdCIsImVudW1lcmF0aW9uQ29udmVydGVyIiwiZW51bWVyYXRpb25WYWx1ZXMiLCJrZXlzIiwiUmVmbGVjdCIsIm93bktleXMiLCJmb3JFYWNoIiwia2V5IiwiaW5kZXgiLCJhbm5vdGF0aW9uIiwiaGFzIiwic2ltcGxlIiwiTnVtYmVyIiwiaXNOYU4iLCJ5ZXMiLCJubyIsImJvb2xlYW5Db252ZXJ0ZXIiLCJwZXJjZW50Q29udmVydGVyIiwiTWF0aCIsIm1heCIsIm1pbiIsInJvdW5kIiwicmVwcmVzZW50YXRpb25Db252ZXJ0ZXIiLCJzaXplIiwiZm10IiwicGFja2VkOGZsb2F0Q29udmVydGVyIiwic3VidHlwZSIsImRlbHRhIiwiYXBwaW5mbyIsInplcm8iLCJ2YWwiLCJmbG9vciIsImZpeGVkUG9pbnROdW1iZXI0Q29udmVydGVyIiwiZGVjIiwiaGkiLCJsb3ciLCJ2ZXJzaW9uVHlwZUNvbnZlcnRlciIsIkVycm9yIiwiZ2V0SW50U2l6ZSIsInR5cGUiLCJtaW5JbmNsdXNpdmVDb252ZXJ0ZXIiLCJtaW5JbmNsIiwibWF4SW5jbHVzaXZlQ29udmVydGVyIiwibWF4SW5jbCIsImNvbnZlcnRUbyIsImNvbnZlcnRlcnMiLCJyZWR1Y2VSaWdodCIsInJlc3VsdCIsImNvbnZlcnRlciIs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RUFFRXBFLEtBRkYsQ0FESzs7OztBQU1BLE1BQU11RSxXQUFXLEdBQUlMLFVBQUQsSUFBK0JsRSxLQUFELElBQ3ZEa0UsVUFBVSxDQUFDTSxNQUFYLENBQWtCLENBQUNDLE9BQUQsRUFBVUosU0FBVixLQUF3QkEsU0FBUyxDQUFDckQsSUFBVixDQUFleUQsT0FBZixDQUExQyxFQUFtRXpFLEtBQW5FLENBREsiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoYykgMjAxOS4gT09PIE5hdGEtSW5mb1xuICogQGF1dGhvciBBbmRyZWkgU2FyYWtlZXYgPGF2c0BuYXRhLWluZm8ucnU+XG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIFwiQG5hdGFcIiBwcm9qZWN0LlxuICogRm9yIHRoZSBmdWxsIGNvcHlyaWdodCBhbmQgbGljZW5zZSBpbmZvcm1hdGlvbiwgcGxlYXNlIHZpZXdcbiAqIHRoZSBFVUxBIGZpbGUgdGhhdCB3YXMgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHNvdXJjZSBjb2RlLlxuICovXG5cbmltcG9ydCBwcmludGYgZnJvbSAncHJpbnRmJztcbmltcG9ydCB7IElNaWJUeXBlIH0gZnJvbSAnLi9kZXZpY2VzJztcblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkSnNOYW1lKG5hbWU6IHN0cmluZykge1xuICByZXR1cm4gbmFtZS5yZXBsYWNlKC8oX1xcdykvZywgKF8sIHMpID0+IHNbMV0udG9VcHBlckNhc2UoKSk7XG59XG5cbmV4cG9ydCBjb25zdCB3aXRoVmFsdWUgPSAodmFsdWU6IGFueSwgd3JpdGFibGUgPSBmYWxzZSk6IFByb3BlcnR5RGVzY3JpcHRvciA9PiAoe1xuICB2YWx1ZSxcbiAgd3JpdGFibGUsXG4gIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gIGVudW1lcmFibGU6IHRydWUsXG59KTtcbmNvbnN0IGhleCA9IC9eMFhbMC05QS1GXSskL2k7XG5jb25zdCBpc0hleCA9IChzdHI6IHN0cmluZykgPT4gaGV4LnRlc3Qoc3RyKVxuICB8fCBwYXJzZUludChzdHIsIDEwKS50b1N0cmluZygxMCkgIT09IHN0ci50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL15bMCBdKy8sICcnKTtcblxuZXhwb3J0IGNvbnN0IHRvSW50ID0gKHZhbHVlOiBzdHJpbmcgfCBib29sZWFuIHwgbnVtYmVyID0gMCk6IG51bWJlciA9PiB7XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSByZXR1cm4gdmFsdWU7XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIHZhbHVlID8gMSA6IDA7XG4gIGlmICh2YWx1ZSA9PT0gJ3RydWUnKSByZXR1cm4gMTtcbiAgaWYgKHZhbHVlID09PSAnZmFsc2UnKSByZXR1cm4gMDtcbiAgcmV0dXJuIHBhcnNlSW50KHZhbHVlLCBpc0hleCh2YWx1ZSkgPyAxNiA6IDEwKTtcbn07XG5cbnR5cGUgUmVzdWx0VHlwZSA9IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG50eXBlIFByZXNlbnRUeXBlID0gc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IHVuZGVmaW5lZDtcblxuZXhwb3J0IGludGVyZmFjZSBJQ29udmVydGVyIHtcbiAgZnJvbTogKHZhbHVlOiBQcmVzZW50VHlwZSkgPT4gUmVzdWx0VHlwZTtcbiAgdG86ICh2YWx1ZTogUmVzdWx0VHlwZSkgPT4gUHJlc2VudFR5cGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1bml0Q29udmVydGVyKHVuaXQ6IHN0cmluZyk6IElDb252ZXJ0ZXIge1xuICBjb25zdCBmcm9tUmUgPSBuZXcgUmVnRXhwKGAoXFxcXHMqJHt1bml0fVxcXFxzKikkYCwgJ2knKTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gdmFsdWUucmVwbGFjZShmcm9tUmUsICcnKSA6IHZhbHVlLFxuICAgIHRvOiB2YWx1ZSA9PiB2YWx1ZSAhPSBudWxsID8gYCR7dmFsdWV9JHt1bml0fWAgOiB2YWx1ZSxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByZWNpc2lvbkNvbnZlcnRlcihwcmVjaXNpb246IHN0cmluZyk6IElDb252ZXJ0ZXIge1xuICBjb25zdCBmb3JtYXQgPSBgJS4ke3ByZWNpc2lvbn1mYDtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gcGFyc2VGbG9hdCh2YWx1ZSkgOiB2YWx1ZSxcbiAgICB0bzogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IHByaW50Zihmb3JtYXQsIHZhbHVlKSA6IHZhbHVlLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZW51bWVyYXRpb25Db252ZXJ0ZXIoZW51bWVyYXRpb25WYWx1ZXM6IElNaWJUeXBlWydlbnVtZXJhdGlvbiddKTogSUNvbnZlcnRlciB7XG4gIGNvbnN0IGZyb206IGFueSA9IHt9O1xuICBjb25zdCB0bzogYW55ID0ge307XG4gIGNvbnN0IGtleXMgPSBSZWZsZWN0Lm93bktleXMoZW51bWVyYXRpb25WYWx1ZXMhKSBhcyBzdHJpbmdbXTtcbiAga2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IGVudW1lcmF0aW9uVmFsdWVzIVtrZXldO1xuICAgIGNvbnN0IGluZGV4ID0gdG9JbnQoa2V5KTtcbiAgICBmcm9tW3ZhbHVlLmFubm90YXRpb25dID0gaW5kZXg7XG4gICAgdG9baW5kZXhdID0gdmFsdWUuYW5ub3RhdGlvbjtcbiAgfSk7XG4gIC8vIGNvbnNvbGUubG9nKCdmcm9tICVvLCB0byAlbycsIGZyb20sIHRvKTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiAodmFsdWUpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIFJlZmxlY3QuaGFzKGZyb20sIHZhbHVlKSkgcmV0dXJuIGZyb21bdmFsdWVdO1xuICAgICAgY29uc3Qgc2ltcGxlID0gdG9JbnQodmFsdWUpO1xuICAgICAgcmV0dXJuIE51bWJlci5pc05hTihzaW1wbGUpID8gdmFsdWUgOiBzaW1wbGU7XG4gICAgfSxcbiAgICB0bzogdmFsdWUgPT4gKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJylcbiAgICAmJiBSZWZsZWN0Lmhhcyh0bywgdmFsdWUpID8gdG9bdmFsdWVdIDogdmFsdWUsXG4gIH07XG59XG5cbmNvbnN0IHllcyA9IC9eXFxzKih5ZXN8b258dHJ1ZXwxfNC00LApXFxzKiQvaTtcbmNvbnN0IG5vID0gL15cXHMqKG5vfG9mZnxmYWxzZXwwfNC90LXRgilcXHMqJC9pO1xuZXhwb3J0IGNvbnN0IGJvb2xlYW5Db252ZXJ0ZXI6IElDb252ZXJ0ZXIgPSB7XG4gIGZyb206ICh2YWx1ZSkgPT4ge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAoeWVzLnRlc3QodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKG5vLnRlc3QodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9LFxuICB0bzogKHZhbHVlKSA9PiB7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICByZXR1cm4gdmFsdWUgPyAn0JTQsCcgOiAn0J3QtdGCJztcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IHBlcmNlbnRDb252ZXJ0ZXI6IElDb252ZXJ0ZXIgPSB7XG4gIGZyb206IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPyBNYXRoLm1heChNYXRoLm1pbihcbiAgICBNYXRoLnJvdW5kKHZhbHVlICogMjU1IC8gMTAwKSxcbiAgICAyNTUsXG4gICksIDApIDogdmFsdWUsXG4gIHRvOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8gTWF0aC5tYXgoXG4gICAgTWF0aC5taW4oTWF0aC5yb3VuZCh2YWx1ZSAqIDEwMCAvIDI1NSksIDEwMCksXG4gICAgMCxcbiAgKSA6IHZhbHVlLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJlcHJlc2VudGF0aW9uQ29udmVydGVyKGZvcm1hdDogc3RyaW5nLCBzaXplOiBudW1iZXIpOiBJQ29udmVydGVyIHtcbiAgbGV0IGZyb206IElDb252ZXJ0ZXJbJ2Zyb20nXTtcbiAgbGV0IHRvOiBJQ29udmVydGVyWyd0byddO1xuICBsZXQgZm10OiBzdHJpbmc7XG4gIC8vIGZyb21GbiA9IHRvRm4gPSBmdW5jdGlvbiAodmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9O1xuXG4gIHN3aXRjaCAoZm9ybWF0KSB7XG4gICAgY2FzZSAnJWInOlxuICAgIGNhc2UgJyVCJzpcbiAgICAgIGZtdCA9IGAlMCR7c2l6ZSAqIDh9c2A7XG4gICAgICBmcm9tID0gdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHBhcnNlSW50KHZhbHVlLCAyKSA6IHZhbHVlO1xuICAgICAgdG8gPSB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8gcHJpbnRmKGZtdCwgdmFsdWUudG9TdHJpbmcoMikpIDogdmFsdWU7XG4gICAgICBicmVhaztcbiAgICBjYXNlICcleCc6XG4gICAgY2FzZSAnJVgnOlxuICAgICAgZm10ID0gYCUwJHtzaXplfXNgO1xuICAgICAgZnJvbSA9IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBwYXJzZUludCh2YWx1ZSwgMTYpIDogdmFsdWU7XG4gICAgICB0byA9IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPyBwcmludGYoZm10LCB2YWx1ZS50b1N0cmluZygxNikpIDogdmFsdWU7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgZnJvbSA9IHZhbHVlID0+IHZhbHVlO1xuICAgICAgdG8gPSBmcm9tO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBmcm9tLFxuICAgIHRvLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFja2VkOGZsb2F0Q29udmVydGVyKHN1YnR5cGU6IElNaWJUeXBlKTogSUNvbnZlcnRlciB7XG4gIGxldCBkZWx0YSA9IDA7XG4gIGlmIChzdWJ0eXBlLmFwcGluZm8gJiYgc3VidHlwZS5hcHBpbmZvLnplcm8pIHtcbiAgICBkZWx0YSA9IHBhcnNlRmxvYXQoc3VidHlwZS5hcHBpbmZvLnplcm8pIHx8IDA7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBmcm9tOiAodmFsdWUpID0+IHtcbiAgICAgIGNvbnN0IHZhbCA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBwYXJzZUZsb2F0KHZhbHVlKSA6IHZhbHVlO1xuICAgICAgcmV0dXJuIHR5cGVvZiB2YWwgPT09ICdudW1iZXInID8gTWF0aC5mbG9vcigodmFsIC0gZGVsdGEpICogMTAwKSAmIDB4RkYgOiB2YWw7XG4gICAgfSxcbiAgICB0bzogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IHZhbHVlIC8gMTAwICsgZGVsdGEgOiB2YWx1ZSxcbiAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IGZpeGVkUG9pbnROdW1iZXI0Q29udmVydGVyOiBJQ29udmVydGVyID0ge1xuICBmcm9tOiAodmFsdWUpID0+IHtcbiAgICBjb25zdCB2YWwgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gcGFyc2VGbG9hdCh2YWx1ZSkgOiB2YWx1ZTtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gJ251bWJlcicpIHtcbiAgICAgIHJldHVybiB2YWw7XG4gICAgfVxuICAgIGNvbnN0IGRlYyA9IE1hdGgucm91bmQodmFsICogMTAwMCkgJSAxMDAwO1xuICAgIGNvbnN0IGhpID0gKChNYXRoLmZsb29yKHZhbCkgPDwgNCkgKyBNYXRoLmZsb29yKGRlYyAvIDEwMCkpICYgMHhGRjtcbiAgICBjb25zdCBsb3cgPSAoZGVjICUgMTAgKyAoKE1hdGguZmxvb3IoZGVjIC8gMTApICUgMTApIDw8IDQpKSAmIDB4RkY7XG4gICAgcmV0dXJuIChoaSA8PCA4KSB8IGxvdztcbiAgfSxcbiAgdG86ICh2YWx1ZSkgPT4ge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IGhpID0gKHZhbHVlID4+IDgpICYgMHhGRjtcbiAgICBjb25zdCBsb3cgPSB2YWx1ZSAmIDB4RkY7XG4gICAgY29uc3QgZGVjID0gKGhpICYgMHhGKSAqIDEwMCArIChsb3cgPj4gNCkgKiAxMCArIChsb3cgJiAweEYpO1xuICAgIHJldHVybiAoaGkgPj4gNCkgKyBkZWMgLyAxMDAwO1xuICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IHZlcnNpb25UeXBlQ29udmVydGVyOiBJQ29udmVydGVyID0ge1xuICBmcm9tOiAoKSA9PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCd2ZXJzaW9uVHlwZSBpcyByZWFkb25seSBwcm9wZXJ0eScpO1xuICB9LFxuICB0bzogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJ1xuICAgID8gYCR7KHZhbHVlID4+IDgpICYgMHhGRn0uJHt2YWx1ZSAmIDB4RkZ9IFsweCR7KHZhbHVlID4+PiAxNikudG9TdHJpbmcoMTYpfV1gXG4gICAgOiB2YWx1ZSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbnRTaXplKHR5cGU6IHN0cmluZykge1xuICBzd2l0Y2ggKHR5cGUpIHtcbiAgICBjYXNlICd4czpOTVRPS0VOJzpcbiAgICBjYXNlICd4czp1bnNpZ25lZEJ5dGUnOlxuICAgIGNhc2UgJ3hzOmJ5dGUnOlxuICAgICAgcmV0dXJuIDE7XG4gICAgY2FzZSAneHM6c2hvcnQnOlxuICAgIGNhc2UgJ3hzOnVuc2lnbmVkU2hvcnQnOlxuICAgICAgcmV0dXJuIDI7XG4gICAgY2FzZSAneHM6aW50JzpcbiAgICBjYXNlICd4czp1bnNpZ25lZEludCc6XG4gICAgICByZXR1cm4gNDtcbiAgICBjYXNlICd4czpsb25nJzpcbiAgICBjYXNlICd4czp1bnNpZ25lZExvbmcnOlxuICAgICAgcmV0dXJuIDg7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1pbkluY2x1c2l2ZUNvbnZlcnRlcihtaW46IHN0cmluZykgOiBJQ29udmVydGVyIHtcbiAgY29uc3QgbWluSW5jbCA9IHBhcnNlRmxvYXQobWluKTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiB2YWx1ZSA9PiBNYXRoLm1heCh2YWx1ZSBhcyBudW1iZXIsIG1pbkluY2wpLFxuICAgIHRvOiB2YWx1ZSA9PiB2YWx1ZSxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1heEluY2x1c2l2ZUNvbnZlcnRlcihtYXg6IHN0cmluZykgOiBJQ29udmVydGVyIHtcbiAgY29uc3QgbWF4SW5jbCA9IHBhcnNlRmxvYXQobWF4KTtcbiAgcmV0dXJuIHtcbiAgICBmcm9tOiB2YWx1ZSA9PiBNYXRoLm1pbih2YWx1ZSBhcyBudW1iZXIsIG1heEluY2wpLFxuICAgIHRvOiB2YWx1ZSA9PiB2YWx1ZSxcbiAgfTtcbn1cbmV4cG9ydCBjb25zdCBjb252ZXJ0VG8gPSAoY29udmVydGVyczogSUNvbnZlcnRlcltdKSA9PiAodmFsdWU6IFJlc3VsdFR5cGUpID0+XG4gIGNvbnZlcnRlcnMucmVkdWNlUmlnaHQoXG4gICAgKHJlc3VsdCwgY29udmVydGVyKSA9PiByZXN1bHQgIT09IHVuZGVmaW5lZCAmJiBjb252ZXJ0ZXIudG8ocmVzdWx0KSxcbiAgICB2YWx1ZSxcbiAgKTtcblxuZXhwb3J0IGNvbnN0IGNvbnZlcnRGcm9tID0gKGNvbnZlcnRlcnM6IElDb252ZXJ0ZXJbXSkgPT4gKHZhbHVlOiBQcmVzZW50VHlwZSkgPT5cbiAgY29udmVydGVycy5yZWR1Y2UoKHByZXNlbnQsIGNvbnZlcnRlcikgPT4gY29udmVydGVyLmZyb20ocHJlc2VudCksIHZhbHVlKTtcbiJdfQ==