"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validJsName = validJsName;
exports.unitConverter = unitConverter;
exports.precisionConverter = precisionConverter;
exports.enumerationConverter = enumerationConverter;
exports.representationConverter = representationConverter;
exports.packed8floatConverter = packed8floatConverter;
exports.getIntSize = getIntSize;
exports.minInclusiveConverter = minInclusiveConverter;
exports.maxInclusiveConverter = maxInclusiveConverter;
exports.convertFrom = exports.convertTo = exports.versionTypeConverter = exports.fixedPointNumber4Converter = exports.percentConverter = exports.booleanConverter = exports.toInt = exports.withValue = void 0;

require("source-map-support/register");

var _printf = _interopRequireDefault(require("printf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * @license
 * Copyright (c) 2019. OOO Nata-Info
 * @author Andrei Sarakeev <avs@nata-info.ru>
 *
 * This file is part of the "@nata" project.
 * For the full copyright and license information, please view
 * the EULA file that was distributed with this source code.
 */
function validJsName(name) {
  return name.replace(/(_\w)/g, (_, s) => s[1].toUpperCase());
}

const withValue = (value, writable = false) => ({
  value,
  writable,
  configurable: false,
  enumerable: true
});

exports.withValue = withValue;
const hex = /^0X[0-9A-F]+$/i;

const isHex = str => hex.test(str) || parseInt(str, 10).toString(10) !== str.toLowerCase().replace(/^[0 ]+/, '');

const toInt = (value = 0) => {
  if (typeof value === 'number') return value;
  if (typeof value === 'boolean') return value ? 1 : 0;
  if (value === 'true') return 1;
  if (value === 'false') return 0;
  return parseInt(value, isHex(value) ? 16 : 10);
};

exports.toInt = toInt;

function unitConverter(unit) {
  const fromRe = new RegExp(`(\\s*${unit}\\s*)$`, 'i');
  return {
    from: value => typeof value === 'string' ? value.replace(fromRe, '') : value,
    to: value => value != null ? `${value}${unit}` : value
  };
}

function precisionConverter(precision) {
  const format = `%.${precision}f`;
  return {
    from: value => typeof value === 'string' ? parseFloat(value) : value,
    to: value => typeof value === 'number' ? (0, _printf.default)(format, value) : value
  };
}

function enumerationConverter(enumerationValues) {
  const from = {};
  const to = {};
  const keys = Reflect.ownKeys(enumerationValues);
  keys.forEach(key => {
    const value = enumerationValues[key];
    const index = toInt(key);
    from[value.annotation] = index;
    to[String(index)] = value.annotation;
  }); // console.log('from %o, to %o', from, to);

  return {
    from: value => {
      if (Reflect.has(from, String(value))) {
        return from[String(value)];
      }

      const simple = toInt(value);
      return Number.isNaN(simple) ? value : simple;
    },
    to: value => {
      let index = toInt(value);
      if (Number.isNaN(index)) index = String(value);
      return Reflect.has(to, String(index)) ? to[String(index)] : value;
    }
  };
}

const yes = /^\s*(yes|on|true|1|да)\s*$/i;
const no = /^\s*(no|off|false|0|нет)\s*$/i;
const booleanConverter = {
  from: value => {
    if (typeof value === 'string') {
      if (yes.test(value)) {
        return true;
      }

      if (no.test(value)) {
        return false;
      }
    }

    return value;
  },
  to: value => {
    if (typeof value === 'boolean') {
      return value ? 'Да' : 'Нет';
    }

    return value;
  }
};
exports.booleanConverter = booleanConverter;
const percentConverter = {
  from: value => typeof value === 'number' ? Math.max(Math.min(Math.round(value * 255 / 100), 255), 0) : value,
  to: value => typeof value === 'number' ? Math.max(Math.min(Math.round(value * 100 / 255), 100), 0) : value
};
exports.percentConverter = percentConverter;

function representationConverter(format, size) {
  let from;
  let to;
  let fmt; // fromFn = toFn = function (value) { return value; };

  switch (format) {
    case '%b':
    case '%B':
      fmt = `%0${size * 8}s`;

      from = value => typeof value === 'string' ? parseInt(value, 2) : value;

      to = value => typeof value === 'number' ? (0, _printf.default)(fmt, value.toString(2)) : value;

      break;

    case '%x':
    case '%X':
      fmt = `%0${size}s`;

      from = value => typeof value === 'string' ? parseInt(value, 16) : value;

      to = value => typeof value === 'number' ? (0, _printf.default)(fmt, value.toString(16)) : value;

      break;

    default:
      from = value => value;

      to = from;
  }

  return {
    from,
    to
  };
}

function packed8floatConverter(subtype) {
  let delta = 0;

  if (subtype.appinfo && subtype.appinfo.zero) {
    delta = parseFloat(subtype.appinfo.zero) || 0;
  }

  return {
    from: value => {
      const val = typeof value === 'string' ? parseFloat(value) : value;
      return typeof val === 'number' ? Math.floor((val - delta) * 100) & 0xFF : val;
    },
    to: value => typeof value === 'number' ? value / 100 + delta : value
  };
}

const fixedPointNumber4Converter = {
  from: value => {
    const val = typeof value === 'string' ? parseFloat(value) : value;

    if (typeof val !== 'number') {
      return val;
    }

    const dec = Math.round(val * 1000) % 1000;
    const hi = (Math.floor(val) << 4) + Math.floor(dec / 100) & 0xFF;
    const low = dec % 10 + (Math.floor(dec / 10) % 10 << 4) & 0xFF;
    return hi << 8 | low;
  },
  to: value => {
    if (typeof value !== 'number') {
      return value;
    }

    const hi = value >> 8 & 0xFF;
    const low = value & 0xFF;
    const dec = (hi & 0xF) * 100 + (low >> 4) * 10 + (low & 0xF);
    return (hi >> 4) + dec / 1000;
  }
};
exports.fixedPointNumber4Converter = fixedPointNumber4Converter;
const versionTypeConverter = {
  from: () => {
    throw new Error('versionType is readonly property');
  },
  to: value => typeof value === 'number' ? `${value >> 8 & 0xFF}.${value & 0xFF} [0x${(value >>> 16).toString(16)}]` : value
};
exports.versionTypeConverter = versionTypeConverter;

function getIntSize(type) {
  switch (type) {
    case 'xs:NMTOKEN':
    case 'xs:unsignedByte':
    case 'xs:byte':
      return 1;

    case 'xs:short':
    case 'xs:unsignedShort':
      return 2;

    case 'xs:int':
    case 'xs:unsignedInt':
      return 4;

    case 'xs:long':
    case 'xs:unsignedLong':
      return 8;
  }
}

function minInclusiveConverter(min) {
  const minIncl = parseFloat(min);
  return {
    from: value => typeof value === 'number' ? Math.max(value, minIncl) : value,
    to: value => value
  };
}

function maxInclusiveConverter(max) {
  const maxIncl = parseFloat(max);
  return {
    from: value => typeof value === 'number' ? Math.min(value, maxIncl) : value,
    to: value => value
  };
}

const convertTo = converters => value => converters.reduceRight((result, converter) => result !== undefined && converter.to(result), value);

exports.convertTo = convertTo;

const convertFrom = converters => value => converters.reduce((present, converter) => converter.from(present), value);

exports.convertFrom = convertFrom;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWIvbWliLnRzIl0sIm5hbWVzIjpbInZhbGlkSnNOYW1lIiwibmFtZSIsInJlcGxhY2UiLCJfIiwicyIsInRvVXBwZXJDYXNlIiwid2l0aFZhbHVlIiwidmFsdWUiLCJ3cml0YWJsZSIsImNvbmZpZ3VyYWJsZSIsImVudW1lcmFibGUiLCJoZXgiLCJpc0hleCIsInN0ciIsInRlc3QiLCJwYXJzZUludCIsInRvU3RyaW5nIiwidG9Mb3dlckNhc2UiLCJ0b0ludCIsInVuaXRDb252ZXJ0ZXIiLCJ1bml0IiwiZnJvbVJlIiwiUmVnRXhwIiwiZnJvbSIsInRvIiwicHJlY2lzaW9uQ29udmVydGVyIiwicHJlY2lzaW9uIiwiZm9ybWF0IiwicGFyc2VGbG9hdCIsImVudW1lcmF0aW9uQ29udmVydGVyIiwiZW51bWVyYXRpb25WYWx1ZXMiLCJrZXlzIiwiUmVmbGVjdCIsIm93bktleXMiLCJmb3JFYWNoIiwia2V5IiwiaW5kZXgiLCJhbm5vdGF0aW9uIiwiU3RyaW5nIiwiaGFzIiwic2ltcGxlIiwiTnVtYmVyIiwiaXNOYU4iLCJ5ZXMiLCJubyIsImJvb2xlYW5Db252ZXJ0ZXIiLCJwZXJjZW50Q29udmVydGVyIiwiTWF0aCIsIm1heCIsIm1pbiIsInJvdW5kIiwicmVwcmVzZW50YXRpb25Db252ZXJ0ZXIiLCJzaXplIiwiZm10IiwicGFja2VkOGZsb2F0Q29udmVydGVyIiwic3VidHlwZSIsImRlbHRhIiwiYXBwaW5mbyIsInplcm8iLCJ2YWwiLCJmbG9vciIsImZpeGVkUG9pbnROdW1iZXI0Q29udmVydGVyIiwiZGVjIiwiaGkiLCJsb3ciLCJ2ZXJzaW9uVHlwZUNvbnZlcnRlciIsIkVycm9yIiwiZ2V0SW50U2l6ZSIsInR5cGUiLCJtaW5JbmNsdXNpdmVDb252ZXJ0ZXIiLCJtaW5JbmNsIiwibWF4SW5jbHVzaXZlQ29udmVydGVyIiwibWF4SW5jbCIsImNvbnZlcnRUbyIsImNvbnZlcnRlcnMiLCJyZWR1Y2VSaWdodCIsInJlc3VsdCIsImNv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VCxFQUFnQmlFLE9BQWhCLENBQTVCLEdBQXVEakUsS0FEakU7QUFFTGlCLElBQUFBLEVBQUUsRUFBRWpCLEtBQUssSUFBSUE7QUFGUixHQUFQO0FBSUQ7O0FBRU0sTUFBTWtFLFNBQVMsR0FBSUMsVUFBRCxJQUErQm5FLEtBQUQsSUFDckRtRSxVQUFVLENBQUNDLFdBQVgsQ0FDRSxDQUFDQyxNQUFELEVBQVNDLFNBQVQsS0FBdUJELE1BQU0sS0FBS0UsU0FBWCxJQUF3QkQsU0FBUyxDQUFDckQsRUFBVixDQUFhb0QsTUFBYixDQURqRCxFQUVFckUsS0FGRixDQURLOzs7O0FBTUEsTUFBTXdFLFdBQVcsR0FBSUwsVUFBRCxJQUErQm5FLEtBQUQsSUFDdkRtRSxVQUFVLENBQUNNLE1BQVgsQ0FBa0IsQ0FBQ0MsT0FBRCxFQUFVSixTQUFWLEtBQXdCQSxTQUFTLENBQUN0RCxJQUFWLENBQWUwRCxPQUFmLENBQTFDLEVBQW1FMUUsS0FBbkUsQ0FESyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChjKSAyMDE5LiBPT08gTmF0YS1JbmZvXG4gKiBAYXV0aG9yIEFuZHJlaSBTYXJha2VldiA8YXZzQG5hdGEtaW5mby5ydT5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgXCJAbmF0YVwiIHByb2plY3QuXG4gKiBGb3IgdGhlIGZ1bGwgY29weXJpZ2h0IGFuZCBsaWNlbnNlIGluZm9ybWF0aW9uLCBwbGVhc2Ugdmlld1xuICogdGhlIEVVTEEgZmlsZSB0aGF0IHdhcyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgc291cmNlIGNvZGUuXG4gKi9cblxuaW1wb3J0IHByaW50ZiBmcm9tICdwcmludGYnO1xuaW1wb3J0IHsgSU1pYlR5cGUgfSBmcm9tICcuL2RldmljZXMnO1xuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRKc05hbWUobmFtZTogc3RyaW5nKSB7XG4gIHJldHVybiBuYW1lLnJlcGxhY2UoLyhfXFx3KS9nLCAoXywgcykgPT4gc1sxXS50b1VwcGVyQ2FzZSgpKTtcbn1cblxuZXhwb3J0IGNvbnN0IHdpdGhWYWx1ZSA9ICh2YWx1ZTogYW55LCB3cml0YWJsZSA9IGZhbHNlKTogUHJvcGVydHlEZXNjcmlwdG9yID0+ICh7XG4gIHZhbHVlLFxuICB3cml0YWJsZSxcbiAgY29uZmlndXJhYmxlOiBmYWxzZSxcbiAgZW51bWVyYWJsZTogdHJ1ZSxcbn0pO1xuY29uc3QgaGV4ID0gL14wWFswLTlBLUZdKyQvaTtcbmNvbnN0IGlzSGV4ID0gKHN0cjogc3RyaW5nKSA9PiBoZXgudGVzdChzdHIpXG4gIHx8IHBhcnNlSW50KHN0ciwgMTApLnRvU3RyaW5nKDEwKSAhPT0gc3RyLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXlswIF0rLywgJycpO1xuXG5leHBvcnQgY29uc3QgdG9JbnQgPSAodmFsdWU6IHN0cmluZyB8IGJvb2xlYW4gfCBudW1iZXIgPSAwKTogbnVtYmVyID0+IHtcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHJldHVybiB2YWx1ZTtcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gdmFsdWUgPyAxIDogMDtcbiAgaWYgKHZhbHVlID09PSAndHJ1ZScpIHJldHVybiAxO1xuICBpZiAodmFsdWUgPT09ICdmYWxzZScpIHJldHVybiAwO1xuICByZXR1cm4gcGFyc2VJbnQodmFsdWUsIGlzSGV4KHZhbHVlKSA/IDE2IDogMTApO1xufTtcblxudHlwZSBSZXN1bHRUeXBlID0gc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbiB8IHVuZGVmaW5lZDtcbnR5cGUgUHJlc2VudFR5cGUgPSBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgdW5kZWZpbmVkO1xuXG5leHBvcnQgaW50ZXJmYWNlIElDb252ZXJ0ZXIge1xuICBmcm9tOiAodmFsdWU6IFByZXNlbnRUeXBlKSA9PiBSZXN1bHRUeXBlO1xuICB0bzogKHZhbHVlOiBSZXN1bHRUeXBlKSA9PiBQcmVzZW50VHlwZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVuaXRDb252ZXJ0ZXIodW5pdDogc3RyaW5nKTogSUNvbnZlcnRlciB7XG4gIGNvbnN0IGZyb21SZSA9IG5ldyBSZWdFeHAoYChcXFxccyoke3VuaXR9XFxcXHMqKSRgLCAnaScpO1xuICByZXR1cm4ge1xuICAgIGZyb206IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyB2YWx1ZS5yZXBsYWNlKGZyb21SZSwgJycpIDogdmFsdWUsXG4gICAgdG86IHZhbHVlID0+IHZhbHVlICE9IG51bGwgPyBgJHt2YWx1ZX0ke3VuaXR9YCA6IHZhbHVlLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJlY2lzaW9uQ29udmVydGVyKHByZWNpc2lvbjogc3RyaW5nKTogSUNvbnZlcnRlciB7XG4gIGNvbnN0IGZvcm1hdCA9IGAlLiR7cHJlY2lzaW9ufWZgO1xuICByZXR1cm4ge1xuICAgIGZyb206IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBwYXJzZUZsb2F0KHZhbHVlKSA6IHZhbHVlLFxuICAgIHRvOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8gcHJpbnRmKGZvcm1hdCwgdmFsdWUpIDogdmFsdWUsXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlbnVtZXJhdGlvbkNvbnZlcnRlcihlbnVtZXJhdGlvblZhbHVlczogSU1pYlR5cGVbJ2VudW1lcmF0aW9uJ10pOiBJQ29udmVydGVyIHtcbiAgY29uc3QgZnJvbTogYW55ID0ge307XG4gIGNvbnN0IHRvOiBhbnkgPSB7fTtcbiAgY29uc3Qga2V5cyA9IFJlZmxlY3Qub3duS2V5cyhlbnVtZXJhdGlvblZhbHVlcyEpIGFzIHN0cmluZ1tdO1xuICBrZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgIGNvbnN0IHZhbHVlID0gZW51bWVyYXRpb25WYWx1ZXMhW2tleV07XG4gICAgY29uc3QgaW5kZXggPSB0b0ludChrZXkpO1xuICAgIGZyb21bdmFsdWUuYW5ub3RhdGlvbl0gPSBpbmRleDtcbiAgICB0b1tTdHJpbmcoaW5kZXgpXSA9IHZhbHVlLmFubm90YXRpb247XG4gIH0pO1xuICAvLyBjb25zb2xlLmxvZygnZnJvbSAlbywgdG8gJW8nLCBmcm9tLCB0byk7XG4gIHJldHVybiB7XG4gICAgZnJvbTogKHZhbHVlKSA9PiB7XG4gICAgICBpZiAoUmVmbGVjdC5oYXMoZnJvbSwgU3RyaW5nKHZhbHVlKSkpIHtcbiAgICAgICAgcmV0dXJuIGZyb21bU3RyaW5nKHZhbHVlKV07XG4gICAgICB9XG4gICAgICBjb25zdCBzaW1wbGUgPSB0b0ludCh2YWx1ZSk7XG4gICAgICByZXR1cm4gTnVtYmVyLmlzTmFOKHNpbXBsZSkgPyB2YWx1ZSA6IHNpbXBsZTtcbiAgICB9LFxuICAgIHRvOiAodmFsdWUpID0+IHtcbiAgICAgIGxldCBpbmRleDogbnVtYmVyIHwgc3RyaW5nID0gdG9JbnQodmFsdWUpO1xuICAgICAgaWYgKE51bWJlci5pc05hTihpbmRleCkpIGluZGV4ID0gU3RyaW5nKHZhbHVlKTtcbiAgICAgIHJldHVybiBSZWZsZWN0Lmhhcyh0bywgU3RyaW5nKGluZGV4KSkgPyB0b1tTdHJpbmcoaW5kZXgpXSA6IHZhbHVlO1xuICAgIH0sXG4gIH07XG59XG5cbmNvbnN0IHllcyA9IC9eXFxzKih5ZXN8b258dHJ1ZXwxfNC00LApXFxzKiQvaTtcbmNvbnN0IG5vID0gL15cXHMqKG5vfG9mZnxmYWxzZXwwfNC90LXRgilcXHMqJC9pO1xuZXhwb3J0IGNvbnN0IGJvb2xlYW5Db252ZXJ0ZXI6IElDb252ZXJ0ZXIgPSB7XG4gIGZyb206ICh2YWx1ZSkgPT4ge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAoeWVzLnRlc3QodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKG5vLnRlc3QodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9LFxuICB0bzogKHZhbHVlKSA9PiB7XG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICByZXR1cm4gdmFsdWUgPyAn0JTQsCcgOiAn0J3QtdGCJztcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IHBlcmNlbnRDb252ZXJ0ZXI6IElDb252ZXJ0ZXIgPSB7XG4gIGZyb206IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPyBNYXRoLm1heChNYXRoLm1pbihcbiAgICBNYXRoLnJvdW5kKHZhbHVlICogMjU1IC8gMTAwKSxcbiAgICAyNTUsXG4gICksIDApIDogdmFsdWUsXG4gIHRvOiB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8gTWF0aC5tYXgoXG4gICAgTWF0aC5taW4oTWF0aC5yb3VuZCh2YWx1ZSAqIDEwMCAvIDI1NSksIDEwMCksXG4gICAgMCxcbiAgKSA6IHZhbHVlLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHJlcHJlc2VudGF0aW9uQ29udmVydGVyKGZvcm1hdDogc3RyaW5nLCBzaXplOiBudW1iZXIpOiBJQ29udmVydGVyIHtcbiAgbGV0IGZyb206IElDb252ZXJ0ZXJbJ2Zyb20nXTtcbiAgbGV0IHRvOiBJQ29udmVydGVyWyd0byddO1xuICBsZXQgZm10OiBzdHJpbmc7XG4gIC8vIGZyb21GbiA9IHRvRm4gPSBmdW5jdGlvbiAodmFsdWUpIHsgcmV0dXJuIHZhbHVlOyB9O1xuXG4gIHN3aXRjaCAoZm9ybWF0KSB7XG4gICAgY2FzZSAnJWInOlxuICAgIGNhc2UgJyVCJzpcbiAgICAgIGZtdCA9IGAlMCR7c2l6ZSAqIDh9c2A7XG4gICAgICBmcm9tID0gdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHBhcnNlSW50KHZhbHVlLCAyKSA6IHZhbHVlO1xuICAgICAgdG8gPSB2YWx1ZSA9PiB0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInID8gcHJpbnRmKGZtdCwgdmFsdWUudG9TdHJpbmcoMikpIDogdmFsdWU7XG4gICAgICBicmVhaztcbiAgICBjYXNlICcleCc6XG4gICAgY2FzZSAnJVgnOlxuICAgICAgZm10ID0gYCUwJHtzaXplfXNgO1xuICAgICAgZnJvbSA9IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBwYXJzZUludCh2YWx1ZSwgMTYpIDogdmFsdWU7XG4gICAgICB0byA9IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPyBwcmludGYoZm10LCB2YWx1ZS50b1N0cmluZygxNikpIDogdmFsdWU7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgZnJvbSA9IHZhbHVlID0+IHZhbHVlO1xuICAgICAgdG8gPSBmcm9tO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBmcm9tLFxuICAgIHRvLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFja2VkOGZsb2F0Q29udmVydGVyKHN1YnR5cGU6IElNaWJUeXBlKTogSUNvbnZlcnRlciB7XG4gIGxldCBkZWx0YSA9IDA7XG4gIGlmIChzdWJ0eXBlLmFwcGluZm8gJiYgc3VidHlwZS5hcHBpbmZvLnplcm8pIHtcbiAgICBkZWx0YSA9IHBhcnNlRmxvYXQoc3VidHlwZS5hcHBpbmZvLnplcm8pIHx8IDA7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBmcm9tOiAodmFsdWUpID0+IHtcbiAgICAgIGNvbnN0IHZhbCA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBwYXJzZUZsb2F0KHZhbHVlKSA6IHZhbHVlO1xuICAgICAgcmV0dXJuIHR5cGVvZiB2YWwgPT09ICdudW1iZXInID8gTWF0aC5mbG9vcigodmFsIC0gZGVsdGEpICogMTAwKSAmIDB4RkYgOiB2YWw7XG4gICAgfSxcbiAgICB0bzogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IHZhbHVlIC8gMTAwICsgZGVsdGEgOiB2YWx1ZSxcbiAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IGZpeGVkUG9pbnROdW1iZXI0Q29udmVydGVyOiBJQ29udmVydGVyID0ge1xuICBmcm9tOiAodmFsdWUpID0+IHtcbiAgICBjb25zdCB2YWwgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gcGFyc2VGbG9hdCh2YWx1ZSkgOiB2YWx1ZTtcbiAgICBpZiAodHlwZW9mIHZhbCAhPT0gJ251bWJlcicpIHtcbiAgICAgIHJldHVybiB2YWw7XG4gICAgfVxuICAgIGNvbnN0IGRlYyA9IE1hdGgucm91bmQodmFsICogMTAwMCkgJSAxMDAwO1xuICAgIGNvbnN0IGhpID0gKChNYXRoLmZsb29yKHZhbCkgPDwgNCkgKyBNYXRoLmZsb29yKGRlYyAvIDEwMCkpICYgMHhGRjtcbiAgICBjb25zdCBsb3cgPSAoZGVjICUgMTAgKyAoKE1hdGguZmxvb3IoZGVjIC8gMTApICUgMTApIDw8IDQpKSAmIDB4RkY7XG4gICAgcmV0dXJuIChoaSA8PCA4KSB8IGxvdztcbiAgfSxcbiAgdG86ICh2YWx1ZSkgPT4ge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IGhpID0gKHZhbHVlID4+IDgpICYgMHhGRjtcbiAgICBjb25zdCBsb3cgPSB2YWx1ZSAmIDB4RkY7XG4gICAgY29uc3QgZGVjID0gKGhpICYgMHhGKSAqIDEwMCArIChsb3cgPj4gNCkgKiAxMCArIChsb3cgJiAweEYpO1xuICAgIHJldHVybiAoaGkgPj4gNCkgKyBkZWMgLyAxMDAwO1xuICB9LFxufTtcblxuZXhwb3J0IGNvbnN0IHZlcnNpb25UeXBlQ29udmVydGVyOiBJQ29udmVydGVyID0ge1xuICBmcm9tOiAoKSA9PiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCd2ZXJzaW9uVHlwZSBpcyByZWFkb25seSBwcm9wZXJ0eScpO1xuICB9LFxuICB0bzogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJ1xuICAgID8gYCR7KHZhbHVlID4+IDgpICYgMHhGRn0uJHt2YWx1ZSAmIDB4RkZ9IFsweCR7KHZhbHVlID4+PiAxNikudG9TdHJpbmcoMTYpfV1gXG4gICAgOiB2YWx1ZSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRJbnRTaXplKHR5cGU6IHN0cmluZykge1xuICBzd2l0Y2ggKHR5cGUpIHtcbiAgICBjYXNlICd4czpOTVRPS0VOJzpcbiAgICBjYXNlICd4czp1bnNpZ25lZEJ5dGUnOlxuICAgIGNhc2UgJ3hzOmJ5dGUnOlxuICAgICAgcmV0dXJuIDE7XG4gICAgY2FzZSAneHM6c2hvcnQnOlxuICAgIGNhc2UgJ3hzOnVuc2lnbmVkU2hvcnQnOlxuICAgICAgcmV0dXJuIDI7XG4gICAgY2FzZSAneHM6aW50JzpcbiAgICBjYXNlICd4czp1bnNpZ25lZEludCc6XG4gICAgICByZXR1cm4gNDtcbiAgICBjYXNlICd4czpsb25nJzpcbiAgICBjYXNlICd4czp1bnNpZ25lZExvbmcnOlxuICAgICAgcmV0dXJuIDg7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1pbkluY2x1c2l2ZUNvbnZlcnRlcihtaW46IHN0cmluZyk6IElDb252ZXJ0ZXIge1xuICBjb25zdCBtaW5JbmNsID0gcGFyc2VGbG9hdChtaW4pO1xuICByZXR1cm4ge1xuICAgIGZyb206IHZhbHVlID0+IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgPyAgTWF0aC5tYXgodmFsdWUsIG1pbkluY2wpIDogdmFsdWUsXG4gICAgdG86IHZhbHVlID0+IHZhbHVlLFxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWF4SW5jbHVzaXZlQ29udmVydGVyKG1heDogc3RyaW5nKTogSUNvbnZlcnRlciB7XG4gIGNvbnN0IG1heEluY2wgPSBwYXJzZUZsb2F0KG1heCk7XG4gIHJldHVybiB7XG4gICAgZnJvbTogdmFsdWUgPT4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyA/IE1hdGgubWluKHZhbHVlLCBtYXhJbmNsKSA6IHZhbHVlLFxuICAgIHRvOiB2YWx1ZSA9PiB2YWx1ZSxcbiAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IGNvbnZlcnRUbyA9IChjb252ZXJ0ZXJzOiBJQ29udmVydGVyW10pID0+ICh2YWx1ZTogUmVzdWx0VHlwZSkgPT5cbiAgY29udmVydGVycy5yZWR1Y2VSaWdodChcbiAgICAocmVzdWx0LCBjb252ZXJ0ZXIpID0+IHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIGNvbnZlcnRlci50byhyZXN1bHQpLFxuICAgIHZhbHVlLFxuICApO1xuXG5leHBvcnQgY29uc3QgY29udmVydEZyb20gPSAoY29udmVydGVyczogSUNvbnZlcnRlcltdKSA9PiAodmFsdWU6IFByZXNlbnRUeXBlKSA9PlxuICBjb252ZXJ0ZXJzLnJlZHVjZSgocHJlc2VudCwgY29udmVydGVyKSA9PiBjb252ZXJ0ZXIuZnJvbShwcmVzZW50KSwgdmFsdWUpO1xuIl19