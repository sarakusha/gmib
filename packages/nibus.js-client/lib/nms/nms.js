"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSizeOf = getSizeOf;
exports.decodeValue = decodeValue;
exports.writeValue = writeValue;
exports.encodeValue = encodeValue;
exports.getNmsType = getNmsType;

require("source-map-support/register");

var _iconvLite = require("iconv-lite");

var _errors = require("../errors");

var _nbconst = require("../nbconst");

var _helper = require("../nibus/helper");

var _NmsValueType = _interopRequireDefault(require("./NmsValueType"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * @license
 * Copyright (c) 2019. OOO Nata-Info
 * @author Andrei Sarakeev <avs@nata-info.ru>
 *
 * This file is part of the "@nata" project.
 * For the full copyright and license information, please view
 * the EULA file that was distributed with this source code.
 */
const packByte = b => b % 100 / 10 * 16 + b % 10;

const unpackByte = byte => (byte & 0x0f) + (byte >> 4 & 0x0f) * 10;

function getDateTime(buffer, offset = 0) {
  const day = unpackByte(buffer.readUInt8(offset));
  const month = unpackByte(buffer.readUInt8(1 + offset));
  const year = unpackByte(buffer.readUInt8(3 + offset)) + 100 * unpackByte(buffer.readUInt8(2 + offset));
  const hour = unpackByte(buffer.readUInt8(4 + offset));
  const minute = unpackByte(buffer.readUInt8(5 + offset));
  const second = unpackByte(buffer.readUInt8(6 + offset));
  const ms = unpackByte(buffer.readUInt8(8 + offset)) + 100 * (buffer.readUInt8(7 + offset) & 0x0f);
  return new Date(year, month, day, hour, minute, second, ms);
}

function getSizeOf(valueType, value) {
  switch (valueType) {
    case undefined:
      return 0;

    case _NmsValueType.default.Boolean:
    case _NmsValueType.default.Int8:
    case _NmsValueType.default.UInt8:
      return 1;

    case _NmsValueType.default.Int16:
    case _NmsValueType.default.UInt16:
      return 2;

    case _NmsValueType.default.Int32:
    case _NmsValueType.default.UInt32:
    case _NmsValueType.default.Real32:
      return 4;

    case _NmsValueType.default.Int64:
    case _NmsValueType.default.UInt64:
    case _NmsValueType.default.Real64:
      return 8;

    case _NmsValueType.default.DateTime:
      return 10;

    case _NmsValueType.default.String:
      return value ? value.length + 1 : 0;
  }

  if ((valueType & _NmsValueType.default.Array) === 0) {
    throw new _errors.MibError('Invalid ValueType');
  }

  const arrayType = valueType & _NmsValueType.default.Array - 1;
  const itemSize = getSizeOf(arrayType) || 0;
  return value ? value.length * itemSize : itemSize;
}

function decodeValue(valueType, buffer, offset = 0) {
  console.assert(buffer.length >= offset + getSizeOf(valueType), `Buffer is too small ${buffer.length} < ${offset} + ${getSizeOf(valueType)}`);

  switch (valueType) {
    case _NmsValueType.default.Boolean:
      return !!buffer[offset];

    case _NmsValueType.default.Int8:
      return buffer.readInt8(offset);

    case _NmsValueType.default.Int16:
      return buffer.readInt16LE(offset);

    case _NmsValueType.default.Int32:
      return buffer.readInt32LE(offset);

    case _NmsValueType.default.Int64:
    case _NmsValueType.default.UInt64:
      return buffer.toString('hex', offset, offset + 8).match(/.{2}/g).reverse().join('').toUpperCase();

    case _NmsValueType.default.UInt8:
      return buffer.readUInt8(offset);

    case _NmsValueType.default.UInt16:
      return buffer.readUInt16LE(offset);

    case _NmsValueType.default.UInt32:
      return buffer.readUInt32LE(offset);

    case _NmsValueType.default.Real32:
      return buffer.readFloatLE(offset);

    case _NmsValueType.default.Real64:
      return buffer.readDoubleLE(offset);

    case _NmsValueType.default.String:
      {
        const nil = buffer.indexOf(0, offset);
        return (0, _iconvLite.decode)(buffer.slice(offset, nil !== -1 ? nil : undefined), 'win1251');
      }

    case _NmsValueType.default.DateTime:
      return getDateTime(buffer, offset);

    default:
      break;
  }

  if ((valueType & _NmsValueType.default.Array) === 0) {
    throw new _errors.MibError(`Invalid ValueType ${_NmsValueType.default[valueType]}`);
  }

  const arrayType = valueType & _NmsValueType.default.Array - 1;
  const arraySize = buffer.length - offset;
  const itemSize = getSizeOf(arrayType);
  const arrayLength = arraySize / itemSize;
  const array = [];

  for (let i = 0; i < arrayLength; i += 1) {
    const value = decodeValue(arrayType, buffer, offset + i * itemSize);
    array.push(value);
  }

  return array;
}

function writeValue(valueType, value, buffer, offset = 0) {
  let pos = offset;

  switch (valueType) {
    case _NmsValueType.default.Boolean:
      pos = buffer.writeUInt8(value ? 1 : 0, pos);
      break;

    case _NmsValueType.default.Int8:
      pos = buffer.writeInt8(value, pos);
      break;

    case _NmsValueType.default.Int16:
      pos = buffer.writeInt16LE(value, pos);
      break;

    case _NmsValueType.default.Int32:
      pos = buffer.writeInt32LE(value, pos);
      break;

    case _NmsValueType.default.Int64:
      console.error('signedLong is not implemented');
      break;

    case _NmsValueType.default.UInt64:
      if (typeof value === 'number') {
        const int = Math.floor(value);
        const low = int & 0xFFFFFFFF;
        const hi = 0; // console.log(`${valueType} hi=${hi} lo=${low} value=${value}, int=${int}`);

        pos = buffer.writeUInt32LE(low, pos);
        pos = buffer.writeUInt32LE(hi, pos);
      }

      if (typeof value === 'string') {
        // console.log('STR', value);
        // const start = pos;
        pos = buffer.write((0, _helper.chunkArray)(value.padStart(16, '0'), 2).reverse().join(''), pos, 8, 'hex'); // console.log('BUF', buffer.toString('hex', start, pos + 1));
      }

      break;

    case _NmsValueType.default.UInt8:
      pos = buffer.writeUInt8(value, pos);
      break;

    case _NmsValueType.default.UInt16:
      pos = buffer.writeUInt16LE(value, pos);
      break;

    case _NmsValueType.default.UInt32:
      pos = buffer.writeUInt32LE(value, pos);
      break;

    case _NmsValueType.default.Real32:
      pos = buffer.writeFloatLE(value, pos);
      break;

    case _NmsValueType.default.Real64:
      pos = buffer.writeDoubleLE(value, pos);
      break;

    case _NmsValueType.default.String:
      {
        let src = (0, _iconvLite.encode)(value, 'win1251');

        if (src.length > _nbconst.NMS_MAX_DATA_LENGTH - 2) {
          src = src.slice(0, _nbconst.NMS_MAX_DATA_LENGTH - 2);
        }

        pos = src.copy(buffer, pos);
        pos = buffer.writeUInt8(0, pos + offset);
        break;
      }

    case _NmsValueType.default.DateTime:
      {
        const dtbuffer = Buffer.from([packByte(value.getDate()), packByte(value.getMonth()), packByte(value.getFullYear() % 100), packByte(Math.floor(value.getFullYear() / 100)), packByte(value.getHours()), packByte(value.getMinutes()), packByte(value.getSeconds()), packByte(Math.floor(value.getMilliseconds() / 100) & 0x0f), packByte(value.getMilliseconds() % 100), packByte(value.getDay() + 1)]);
        pos = offset + dtbuffer.copy(buffer, pos);
        break;
      }

    default:
      break;
  }

  if (valueType & _NmsValueType.default.Array) {
    // TODO: Проверить запись массивов
    const arrayType = valueType & _NmsValueType.default.Array - 1;

    for (const item of value) {
      pos = writeValue(arrayType, item, buffer, pos);
    }
  }

  return pos;
}

function encodeValue(valueType, value) {
  const buffer = Buffer.alloc(1 + getSizeOf(valueType, value));
  buffer[0] = valueType & 0xFF;
  writeValue(valueType, value, buffer, 1);
  return buffer;
}

function getNmsType(simpleType) {
  switch (simpleType) {
    case 'xs:boolean':
      return _NmsValueType.default.Boolean;

    case 'xs:unsignedByte':
      return _NmsValueType.default.UInt8;

    case 'xs:byte':
      return _NmsValueType.default.Int8;

    case 'xs:short':
      return _NmsValueType.default.Int16;

    case 'xs:unsignedShort':
      return _NmsValueType.default.UInt16;

    case 'xs:int':
      return _NmsValueType.default.Int32;

    case 'xs:unsignedInt':
      return _NmsValueType.default.UInt32;

    case 'xs:long':
      return _NmsValueType.default.Int64;

    case 'xs:unsignedLong':
      return _NmsValueType.default.UInt64;

    case 'xs:float':
      return _NmsValueType.default.Real32;

    case 'xs:NMTOKEN':
      return _NmsValueType.default.UInt8;

    case 'xs:string':
      return _NmsValueType.default.String;

    default:
      return _NmsValueType.default.Unknown;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ubXMvbm1zLnRzIl0sIm5hbWVzIjpbInBhY2tCeXRlIiwiYiIsInVucGFja0J5dGUiLCJieXRlIiwiZ2V0RGF0ZVRpbWUiLCJidWZmZXIiLCJvZmZzZXQiLCJkYXkiLCJyZWFkVUludDgiLCJtb250aCIsInllYXIiLCJob3VyIiwibWludXRlIiwic2Vjb25kIiwibXMiLCJEYXRlIiwiZ2V0U2l6ZU9mIiwidmFsdWVUeXBlIiwidmFsdWUiLCJ1bmRlZmluZWQiLCJObXNWYWx1ZVR5cGUiLCJCb29sZWFuIiwiSW50OCIsIlVJbnQ4IiwiSW50MTYiLCJVSW50MTYiLCJJbnQzMiIsIlVJbnQzMiIsIlJlYWwzMiIsIkludDY0IiwiVUludDY0IiwiUmVhbDY0IiwiRGF0ZVRpbWUiLCJTdHJpbmciLCJsZW5ndGgiLCJBcnJheSIsIk1pYkVycm9yIiwiYXJyYXlUeXBlIiwiaXRlbVNpemUiLCJkZWNvZGVWYWx1ZSIsImNvbnNvbGUiLCJhc3NlcnQiLCJyZWFkSW50OCIsInJlYWRJbnQxNkxFIiwicmVhZEludDMyTEUiLCJ0b1N0cmluZyIsIm1hdGNoIiwicmV2ZXJzZSIsImpvaW4iLCJ0b1VwcGVyQ2FzZSIsInJlYWRVSW50MTZMRSIsInJlYWRVSW50MzJMRSIsInJlYWRGbG9hdExFIiwicmVhZERvdWJsZUxFIiwibmlsIiwiaW5kZXhPZiIsInNsaWNlIiwiYXJyYXlTaXplIiwiYXJyYXlMZW5ndGgiLCJhcnJheSIsImkiLCJwdXNoIiwid3JpdGVWYWx1ZSIsInBvcyIsIndyaXRlVUludDgiLCJ3cml0ZUludDgiLCJ3cml0ZUludDE2TEUiLCJ3cml0ZUludDMyTEUiLCJlcnJvciIsImludCIsIk1hdGgiLCJmbG9vciIsImxvdyIsImhpIiwid3JpdGVVSW50MzJMRSIsIndyaXRlIiwicGFkU3RhcnQiLCJ3cml0ZVVJbnQxNkxFIiwid3JpdGVGbG9hdExFIiwid3JpdGVEb3VibGVMRSIsInNyYyIsIk5NU19NQVhfREFUQV9MRU5HVEgiLCJjb3B5IiwiZHRidWZmZXIiLCJCdWZmZXIiLCJmcm9tIiwiZ2V0RGF0ZSIsImdldE1vbnRoIiwiZ2V0RnVsbFllYXIiLCJnZXRIb3VycyIsImdldE1pbnV0ZXMiLCJnZXRTZWNvbmRzIiwiZ2V0TWlsbGlzZWNvbmRzIiwiZ2V0RGF5IiwiaXRlbSIsImVuY29kZVZhbHVlIiwiYWxsb2MiLCJnZXRObXNUeXBlIiwic2ltcGxlVHlwZSIsIlVua25vd24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7QUFVQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQWRBOzs7Ozs7Ozs7QUFnQkEsTUFBTUEsUUFBUSxHQUFJQyxDQUFELElBQWtCQSxDQUFDLEdBQUcsR0FBTCxHQUFZLEVBQWIsR0FBbUIsRUFBcEIsR0FBMkJBLENBQUMsR0FBRyxFQUEvRDs7QUFDQSxNQUFNQyxVQUFVLEdBQUlDLElBQUQsSUFBa0IsQ0FBQ0EsSUFBSSxHQUFHLElBQVIsSUFBaUIsQ0FBRUEsSUFBSSxJQUFJLENBQVQsR0FBYyxJQUFmLElBQXVCLEVBQTdFOztBQUVBLFNBQVNDLFdBQVQsQ0FBcUJDLE1BQXJCLEVBQXFDQyxNQUFjLEdBQUcsQ0FBdEQsRUFBeUQ7QUFDdkQsUUFBTUMsR0FBRyxHQUFHTCxVQUFVLENBQUNHLE1BQU0sQ0FBQ0csU0FBUCxDQUFpQkYsTUFBakIsQ0FBRCxDQUF0QjtBQUNBLFFBQU1HLEtBQUssR0FBR1AsVUFBVSxDQUFDRyxNQUFNLENBQUNHLFNBQVAsQ0FBaUIsSUFBSUYsTUFBckIsQ0FBRCxDQUF4QjtBQUNBLFFBQU1JLElBQUksR0FBR1IsVUFBVSxDQUFDRyxNQUFNLENBQUNHLFNBQVAsQ0FBaUIsSUFBSUYsTUFBckIsQ0FBRCxDQUFWLEdBQ1IsTUFBTUosVUFBVSxDQUFDRyxNQUFNLENBQUNHLFNBQVAsQ0FBaUIsSUFBSUYsTUFBckIsQ0FBRCxDQURyQjtBQUVBLFFBQU1LLElBQUksR0FBR1QsVUFBVSxDQUFDRyxNQUFNLENBQUNHLFNBQVAsQ0FBaUIsSUFBSUYsTUFBckIsQ0FBRCxDQUF2QjtBQUNBLFFB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QXBCOztBQUNGLFNBQUssVUFBTDtBQUNFLGFBQU9WLHNCQUFhUSxNQUFwQjs7QUFDRixTQUFLLFlBQUw7QUFDRSxhQUFPUixzQkFBYUcsS0FBcEI7O0FBQ0YsU0FBSyxXQUFMO0FBQ0UsYUFBT0gsc0JBQWFhLE1BQXBCOztBQUNGO0FBQ0UsYUFBT2Isc0JBQWErRSxPQUFwQjtBQTFCSjtBQTRCRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChjKSAyMDE5LiBPT08gTmF0YS1JbmZvXG4gKiBAYXV0aG9yIEFuZHJlaSBTYXJha2VldiA8YXZzQG5hdGEtaW5mby5ydT5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgXCJAbmF0YVwiIHByb2plY3QuXG4gKiBGb3IgdGhlIGZ1bGwgY29weXJpZ2h0IGFuZCBsaWNlbnNlIGluZm9ybWF0aW9uLCBwbGVhc2Ugdmlld1xuICogdGhlIEVVTEEgZmlsZSB0aGF0IHdhcyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgc291cmNlIGNvZGUuXG4gKi9cblxuaW1wb3J0IHsgZGVjb2RlLCBlbmNvZGUgfSBmcm9tICdpY29udi1saXRlJztcbmltcG9ydCB7IE1pYkVycm9yIH0gZnJvbSAnLi4vZXJyb3JzJztcbmltcG9ydCB7IE5NU19NQVhfREFUQV9MRU5HVEggfSBmcm9tICcuLi9uYmNvbnN0JztcbmltcG9ydCB7IGNodW5rQXJyYXkgfSBmcm9tICcuLi9uaWJ1cy9oZWxwZXInO1xuaW1wb3J0IE5tc1ZhbHVlVHlwZSBmcm9tICcuL05tc1ZhbHVlVHlwZSc7XG5cbmNvbnN0IHBhY2tCeXRlID0gKGI6IG51bWJlcikgPT4gKCgoYiAlIDEwMCkgLyAxMCkgKiAxNikgKyAoYiAlIDEwKTtcbmNvbnN0IHVucGFja0J5dGUgPSAoYnl0ZTogbnVtYmVyKSA9PiAoYnl0ZSAmIDB4MGYpICsgKCgoYnl0ZSA+PiA0KSAmIDB4MGYpICogMTApO1xuXG5mdW5jdGlvbiBnZXREYXRlVGltZShidWZmZXI6IEJ1ZmZlciwgb2Zmc2V0OiBudW1iZXIgPSAwKSB7XG4gIGNvbnN0IGRheSA9IHVucGFja0J5dGUoYnVmZmVyLnJlYWRVSW50OChvZmZzZXQpKTtcbiAgY29uc3QgbW9udGggPSB1bnBhY2tCeXRlKGJ1ZmZlci5yZWFkVUludDgoMSArIG9mZnNldCkpO1xuICBjb25zdCB5ZWFyID0gdW5wYWNrQnl0ZShidWZmZXIucmVhZFVJbnQ4KDMgKyBvZmZzZXQpKVxuICAgICsgKDEwMCAqIHVucGFja0J5dGUoYnVmZmVyLnJlYWRVSW50OCgyICsgb2Zmc2V0KSkpO1xuICBjb25zdCBob3VyID0gdW5wYWNrQnl0ZShidWZmZXIucmVhZFVJbnQ4KDQgKyBvZmZzZXQpKTtcbiAgY29uc3QgbWludXRlID0gdW5wYWNrQnl0ZShidWZmZXIucmVhZFVJbnQ4KDUgKyBvZmZzZXQpKTtcbiAgY29uc3Qgc2Vjb25kID0gdW5wYWNrQnl0ZShidWZmZXIucmVhZFVJbnQ4KDYgKyBvZmZzZXQpKTtcbiAgY29uc3QgbXMgPSB1bnBhY2tCeXRlKGJ1ZmZlci5yZWFkVUludDgoOCArIG9mZnNldCkpXG4gICAgKyAoMTAwICogKGJ1ZmZlci5yZWFkVUludDgoNyArIG9mZnNldCkgJiAweDBmKSk7XG4gIHJldHVybiBuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF5LCBob3VyLCBtaW51dGUsIHNlY29uZCwgbXMpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2l6ZU9mKHZhbHVlVHlwZT86IE5tc1ZhbHVlVHlwZSwgdmFsdWU/OiBzdHJpbmcpOiBudW1iZXIge1xuICBzd2l0Y2ggKHZhbHVlVHlwZSkge1xuICAgIGNhc2UgdW5kZWZpbmVkOlxuICAgICAgcmV0dXJuIDA7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuQm9vbGVhbjpcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5JbnQ4OlxuICAgIGNhc2UgTm1zVmFsdWVUeXBlLlVJbnQ4OlxuICAgICAgcmV0dXJuIDE7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuSW50MTY6XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuVUludDE2OlxuICAgICAgcmV0dXJuIDI7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuSW50MzI6XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuVUludDMyOlxuICAgIGNhc2UgTm1zVmFsdWVUeXBlLlJlYWwzMjpcbiAgICAgIHJldHVybiA0O1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLkludDY0OlxuICAgIGNhc2UgTm1zVmFsdWVUeXBlLlVJbnQ2NDpcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5SZWFsNjQ6XG4gICAgICByZXR1cm4gODtcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5EYXRlVGltZTpcbiAgICAgIHJldHVybiAxMDtcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5TdHJpbmc6XG4gICAgICByZXR1cm4gdmFsdWUgPyAodmFsdWUubGVuZ3RoICsgMSkgOiAwO1xuICB9XG5cbiAgaWYgKCh2YWx1ZVR5cGUgJiBObXNWYWx1ZVR5cGUuQXJyYXkpID09PSAwKSB7XG4gICAgdGhyb3cgbmV3IE1pYkVycm9yKCdJbnZhbGlkIFZhbHVlVHlwZScpO1xuICB9XG5cbiAgY29uc3QgYXJyYXlUeXBlID0gdmFsdWVUeXBlICYgKE5tc1ZhbHVlVHlwZS5BcnJheSAtIDEpO1xuICBjb25zdCBpdGVtU2l6ZSA9IGdldFNpemVPZihhcnJheVR5cGUpIHx8IDA7XG5cbiAgcmV0dXJuIHZhbHVlID8gdmFsdWUubGVuZ3RoICogaXRlbVNpemUgOiBpdGVtU2l6ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlY29kZVZhbHVlKHZhbHVlVHlwZTogTm1zVmFsdWVUeXBlLCBidWZmZXI6IEJ1ZmZlciwgb2Zmc2V0ID0gMCk6IGFueSB7XG4gIGNvbnNvbGUuYXNzZXJ0KFxuICAgIGJ1ZmZlci5sZW5ndGggPj0gb2Zmc2V0ICsgZ2V0U2l6ZU9mKHZhbHVlVHlwZSksXG4gICAgYEJ1ZmZlciBpcyB0b28gc21hbGwgJHtidWZmZXIubGVuZ3RofSA8ICR7b2Zmc2V0fSArICR7Z2V0U2l6ZU9mKHZhbHVlVHlwZSl9YCxcbiAgKTtcbiAgc3dpdGNoICh2YWx1ZVR5cGUpIHtcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5Cb29sZWFuOlxuICAgICAgcmV0dXJuICEhYnVmZmVyW29mZnNldF07XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuSW50ODpcbiAgICAgIHJldHVybiBidWZmZXIucmVhZEludDgob2Zmc2V0KTtcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5JbnQxNjpcbiAgICAgIHJldHVybiBidWZmZXIucmVhZEludDE2TEUob2Zmc2V0KTtcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5JbnQzMjpcbiAgICAgIHJldHVybiBidWZmZXIucmVhZEludDMyTEUob2Zmc2V0KTtcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5JbnQ2NDpcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5VSW50NjQ6XG4gICAgICByZXR1cm4gYnVmZmVyXG4gICAgICAgIC50b1N0cmluZygnaGV4Jywgb2Zmc2V0LCBvZmZzZXQgKyA4KVxuICAgICAgICAubWF0Y2goLy57Mn0vZykhXG4gICAgICAgIC5yZXZlcnNlKCkuam9pbignJylcbiAgICAgICAgLnRvVXBwZXJDYXNlKCk7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuVUludDg6XG4gICAgICByZXR1cm4gYnVmZmVyLnJlYWRVSW50OChvZmZzZXQpO1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLlVJbnQxNjpcbiAgICAgIHJldHVybiBidWZmZXIucmVhZFVJbnQxNkxFKG9mZnNldCk7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuVUludDMyOlxuICAgICAgcmV0dXJuIGJ1ZmZlci5yZWFkVUludDMyTEUob2Zmc2V0KTtcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5SZWFsMzI6XG4gICAgICByZXR1cm4gYnVmZmVyLnJlYWRGbG9hdExFKG9mZnNldCk7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuUmVhbDY0OlxuICAgICAgcmV0dXJuIGJ1ZmZlci5yZWFkRG91YmxlTEUob2Zmc2V0KTtcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5TdHJpbmc6IHtcbiAgICAgIGNvbnN0IG5pbCA9IGJ1ZmZlci5pbmRleE9mKDAsIG9mZnNldCk7XG4gICAgICByZXR1cm4gZGVjb2RlKGJ1ZmZlci5zbGljZShvZmZzZXQsIG5pbCAhPT0gLTEgPyBuaWwgOiB1bmRlZmluZWQpLCAnd2luMTI1MScpO1xuICAgIH1cbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5EYXRlVGltZTpcbiAgICAgIHJldHVybiBnZXREYXRlVGltZShidWZmZXIsIG9mZnNldCk7XG4gICAgZGVmYXVsdDpcbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgaWYgKCh2YWx1ZVR5cGUgJiBObXNWYWx1ZVR5cGUuQXJyYXkpID09PSAwKSB7XG4gICAgdGhyb3cgbmV3IE1pYkVycm9yKGBJbnZhbGlkIFZhbHVlVHlwZSAke05tc1ZhbHVlVHlwZVt2YWx1ZVR5cGVdfWApO1xuICB9XG5cbiAgY29uc3QgYXJyYXlUeXBlID0gdmFsdWVUeXBlICYgKE5tc1ZhbHVlVHlwZS5BcnJheSAtIDEpO1xuICBjb25zdCBhcnJheVNpemUgPSBidWZmZXIubGVuZ3RoIC0gb2Zmc2V0O1xuICBjb25zdCBpdGVtU2l6ZSA9IGdldFNpemVPZihhcnJheVR5cGUpO1xuICBjb25zdCBhcnJheUxlbmd0aCA9IGFycmF5U2l6ZSAvIGl0ZW1TaXplO1xuICBjb25zdCBhcnJheSA9IFtdO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXlMZW5ndGg7IGkgKz0gMSkge1xuICAgIGNvbnN0IHZhbHVlID0gZGVjb2RlVmFsdWUoYXJyYXlUeXBlLCBidWZmZXIsIG9mZnNldCArIChpICogaXRlbVNpemUpKTtcbiAgICBhcnJheS5wdXNoKHZhbHVlKTtcbiAgfVxuXG4gIHJldHVybiBhcnJheTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdyaXRlVmFsdWUoXG4gIHZhbHVlVHlwZTogTm1zVmFsdWVUeXBlLFxuICB2YWx1ZTogYW55LFxuICBidWZmZXI6IEJ1ZmZlcixcbiAgb2Zmc2V0ID0gMCk6IG51bWJlciB7XG4gIGxldCBwb3MgPSBvZmZzZXQ7XG4gIHN3aXRjaCAodmFsdWVUeXBlKSB7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuQm9vbGVhbjpcbiAgICAgIHBvcyA9IGJ1ZmZlci53cml0ZVVJbnQ4KHZhbHVlID8gMSA6IDAsIHBvcyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5JbnQ4OlxuICAgICAgcG9zID0gYnVmZmVyLndyaXRlSW50OCh2YWx1ZSwgcG9zKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLkludDE2OlxuICAgICAgcG9zID0gYnVmZmVyLndyaXRlSW50MTZMRSh2YWx1ZSwgcG9zKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLkludDMyOlxuICAgICAgcG9zID0gYnVmZmVyLndyaXRlSW50MzJMRSh2YWx1ZSwgcG9zKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLkludDY0OlxuICAgICAgY29uc29sZS5lcnJvcignc2lnbmVkTG9uZyBpcyBub3QgaW1wbGVtZW50ZWQnKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLlVJbnQ2NDpcbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIGNvbnN0IGludCA9IE1hdGguZmxvb3IodmFsdWUpO1xuICAgICAgICBjb25zdCBsb3cgPSBpbnQgJiAweEZGRkZGRkZGO1xuICAgICAgICBjb25zdCBoaSA9IDA7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGAke3ZhbHVlVHlwZX0gaGk9JHtoaX0gbG89JHtsb3d9IHZhbHVlPSR7dmFsdWV9LCBpbnQ9JHtpbnR9YCk7XG4gICAgICAgIHBvcyA9IGJ1ZmZlci53cml0ZVVJbnQzMkxFKGxvdywgcG9zKTtcbiAgICAgICAgcG9zID0gYnVmZmVyLndyaXRlVUludDMyTEUoaGksIHBvcyk7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAvLyBjb25zb2xlLmxvZygnU1RSJywgdmFsdWUpO1xuICAgICAgICAvLyBjb25zdCBzdGFydCA9IHBvcztcbiAgICAgICAgcG9zID0gYnVmZmVyLndyaXRlKFxuICAgICAgICAgIGNodW5rQXJyYXkodmFsdWUucGFkU3RhcnQoMTYsICcwJyksIDIpLnJldmVyc2UoKS5qb2luKCcnKSxcbiAgICAgICAgICBwb3MsXG4gICAgICAgICAgOCxcbiAgICAgICAgICAnaGV4JyxcbiAgICAgICAgKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coJ0JVRicsIGJ1ZmZlci50b1N0cmluZygnaGV4Jywgc3RhcnQsIHBvcyArIDEpKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLlVJbnQ4OlxuICAgICAgcG9zID0gYnVmZmVyLndyaXRlVUludDgodmFsdWUsIHBvcyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5VSW50MTY6XG4gICAgICBwb3MgPSBidWZmZXIud3JpdGVVSW50MTZMRSh2YWx1ZSwgcG9zKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLlVJbnQzMjpcbiAgICAgIHBvcyA9IGJ1ZmZlci53cml0ZVVJbnQzMkxFKHZhbHVlLCBwb3MpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuUmVhbDMyOlxuICAgICAgcG9zID0gYnVmZmVyLndyaXRlRmxvYXRMRSh2YWx1ZSwgcG9zKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgTm1zVmFsdWVUeXBlLlJlYWw2NDpcbiAgICAgIHBvcyA9IGJ1ZmZlci53cml0ZURvdWJsZUxFKHZhbHVlLCBwb3MpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBObXNWYWx1ZVR5cGUuU3RyaW5nOiB7XG4gICAgICBsZXQgc3JjID0gZW5jb2RlKHZhbHVlLCAnd2luMTI1MScpO1xuICAgICAgaWYgKHNyYy5sZW5ndGggPiBOTVNfTUFYX0RBVEFfTEVOR1RIIC0gMikge1xuICAgICAgICBzcmMgPSBzcmMuc2xpY2UoMCwgTk1TX01BWF9EQVRBX0xFTkdUSCAtIDIpO1xuICAgICAgfVxuICAgICAgcG9zID0gc3JjLmNvcHkoYnVmZmVyLCBwb3MpO1xuICAgICAgcG9zID0gYnVmZmVyLndyaXRlVUludDgoMCwgcG9zICsgb2Zmc2V0KTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBjYXNlIE5tc1ZhbHVlVHlwZS5EYXRlVGltZToge1xuICAgICAgY29uc3QgZHRidWZmZXIgPSBCdWZmZXIuZnJvbShbXG4gICAgICAgIHBhY2tCeXRlKHZhbHVlLmdldERhdGUoKSksXG4gICAgICAgIHBhY2tCeXRlKHZhbHVlLmdldE1vbnRoKCkpLFxuICAgICAgICBwYWNrQnl0ZSh2YWx1ZS5nZXRGdWxsWWVhcigpICUgMTAwKSxcbiAgICAgICAgcGFja0J5dGUoTWF0aC5mbG9vcih2YWx1ZS5nZXRGdWxsWWVhcigpIC8gMTAwKSksXG4gICAgICAgIHBhY2tCeXRlKHZhbHVlLmdldEhvdXJzKCkpLFxuICAgICAgICBwYWNrQnl0ZSh2YWx1ZS5nZXRNaW51dGVzKCkpLFxuICAgICAgICBwYWNrQnl0ZSh2YWx1ZS5nZXRTZWNvbmRzKCkpLFxuICAgICAgICBwYWNrQnl0ZShNYXRoLmZsb29yKHZhbHVlLmdldE1pbGxpc2Vjb25kcygpIC8gMTAwKSAmIDB4MGYpLFxuICAgICAgICBwYWNrQnl0ZSh2YWx1ZS5nZXRNaWxsaXNlY29uZHMoKSAlIDEwMCksXG4gICAgICAgIHBhY2tCeXRlKHZhbHVlLmdldERheSgpICsgMSksXG4gICAgICBdKTtcbiAgICAgIHBvcyA9IG9mZnNldCArIGR0YnVmZmVyLmNvcHkoYnVmZmVyLCBwb3MpO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICBicmVhaztcbiAgfVxuXG4gIGlmICh2YWx1ZVR5cGUgJiBObXNWYWx1ZVR5cGUuQXJyYXkpIHtcbiAgICAvLyBUT0RPOiDQn9GA0L7QstC10YDQuNGC0Ywg0LfQsNC/0LjRgdGMINC80LDRgdGB0LjQstC+0LJcbiAgICBjb25zdCBhcnJheVR5cGUgPSB2YWx1ZVR5cGUgJiAoTm1zVmFsdWVUeXBlLkFycmF5IC0gMSk7XG5cbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpIHtcbiAgICAgIHBvcyA9IHdyaXRlVmFsdWUoYXJyYXlUeXBlLCBpdGVtLCBidWZmZXIsIHBvcyk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHBvcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVuY29kZVZhbHVlKHZhbHVlVHlwZTogTm1zVmFsdWVUeXBlLCB2YWx1ZTogYW55KSB7XG4gIGNvbnN0IGJ1ZmZlciA9IEJ1ZmZlci5hbGxvYygxICsgZ2V0U2l6ZU9mKHZhbHVlVHlwZSwgdmFsdWUpKTtcbiAgYnVmZmVyWzBdID0gdmFsdWVUeXBlICYgMHhGRjtcbiAgd3JpdGVWYWx1ZSh2YWx1ZVR5cGUsIHZhbHVlLCBidWZmZXIsIDEpO1xuICByZXR1cm4gYnVmZmVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Tm1zVHlwZShzaW1wbGVUeXBlOiBzdHJpbmcpIHtcbiAgc3dpdGNoIChzaW1wbGVUeXBlKSB7XG4gICAgY2FzZSAneHM6Ym9vbGVhbic6XG4gICAgICByZXR1cm4gTm1zVmFsdWVUeXBlLkJvb2xlYW47XG4gICAgY2FzZSAneHM6dW5zaWduZWRCeXRlJzpcbiAgICAgIHJldHVybiBObXNWYWx1ZVR5cGUuVUludDg7XG4gICAgY2FzZSAneHM6Ynl0ZSc6XG4gICAgICByZXR1cm4gTm1zVmFsdWVUeXBlLkludDg7XG4gICAgY2FzZSAneHM6c2hvcnQnOlxuICAgICAgcmV0dXJuIE5tc1ZhbHVlVHlwZS5JbnQxNjtcbiAgICBjYXNlICd4czp1bnNpZ25lZFNob3J0JzpcbiAgICAgIHJldHVybiBObXNWYWx1ZVR5cGUuVUludDE2O1xuICAgIGNhc2UgJ3hzOmludCc6XG4gICAgICByZXR1cm4gTm1zVmFsdWVUeXBlLkludDMyO1xuICAgIGNhc2UgJ3hzOnVuc2lnbmVkSW50JzpcbiAgICAgIHJldHVybiBObXNWYWx1ZVR5cGUuVUludDMyO1xuICAgIGNhc2UgJ3hzOmxvbmcnOlxuICAgICAgcmV0dXJuIE5tc1ZhbHVlVHlwZS5JbnQ2NDtcbiAgICBjYXNlICd4czp1bnNpZ25lZExvbmcnOlxuICAgICAgcmV0dXJuIE5tc1ZhbHVlVHlwZS5VSW50NjQ7XG4gICAgY2FzZSAneHM6ZmxvYXQnOlxuICAgICAgcmV0dXJuIE5tc1ZhbHVlVHlwZS5SZWFsMzI7XG4gICAgY2FzZSAneHM6Tk1UT0tFTic6XG4gICAgICByZXR1cm4gTm1zVmFsdWVUeXBlLlVJbnQ4O1xuICAgIGNhc2UgJ3hzOnN0cmluZyc6XG4gICAgICByZXR1cm4gTm1zVmFsdWVUeXBlLlN0cmluZztcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIE5tc1ZhbHVlVHlwZS5Vbmtub3duO1xuICB9XG59XG4iXX0=