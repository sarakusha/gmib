"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _Address = _interopRequireDefault(require("../Address"));

var _nbconst = require("../nbconst");

var _nibus = require("../nibus");

var _nms = require("./nms");

var _NmsServiceType = _interopRequireDefault(require("./NmsServiceType"));

var _NmsValueType = _interopRequireDefault(require("./NmsValueType"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const emptyBuffer = Buffer.alloc(0);

class NmsDatagram extends _nibus.NibusDatagram {
  static isNmsFrame(frame) {
    return frame[0] === _nbconst.PREAMBLE && frame.length > 15 && frame[_nbconst.Offsets.PROTOCOL] === 1 && frame[_nbconst.Offsets.LENGTH] > 3;
  }

  constructor(frameOrOptions) {
    if (Buffer.isBuffer(frameOrOptions)) {
      super(frameOrOptions);

      _defineProperty(this, "isResponse", void 0);

      _defineProperty(this, "notReply", void 0);

      _defineProperty(this, "service", void 0);

      _defineProperty(this, "id", void 0);

      _defineProperty(this, "nms", void 0);

      _defineProperty(this, "timeout", void 0);
    } else {
      const options = {
        source: new _Address.default('auto'),
        isResponse: false,
        notReply: false,
        nms: emptyBuffer,
        ...frameOrOptions
      };
      console.assert(options.nms.length <= _nbconst.NMS_MAX_DATA_LENGTH); // fix: NMS batch read

      const nmsLength = options.service !== _NmsServiceType.default.Read ? options.nms.length & 0x3f : 0;
      const nibusData = [(options.service & 0x1f) << 3 | (options.isResponse ? 4 : 0) | options.id >> 8 & 3, options.id & 0xff, (options.notReply ? 0x80 : 0) | nmsLength, ...options.nms];
      const nibusOptions = Object.assign({
        data: Buffer.from(nibusData),
        protocol: 1
      }, options);
      super(nibusOptions);

      _defineProperty(this, "isResponse", void 0);

      _defineProperty(this, "notReply", void 0);

      _defineProperty(this, "service", void 0);

      _defineProperty(this, "id", void 0);

      _defineProperty(this, "nms", void 0);

      _defineProperty(this, "timeout", void 0);

      if (frameOrOptions.timeout !== undefined) {
        this.timeout = frameOrOptions.timeout;
      }
    }

    const {
      data
    } = this;
    this.id = (data[0] & 3) << 8 | data[1];
    this.service = data[0] >> 3;
    this.isResponse = !!(data[0] & 4);
    this.notReply = !!(data[2] & 0x80); // fix: NMS batch read

    const nmsLength = this.service !== _NmsServiceType.default.Read ? data[2] & 0x3F : data.length - 3;
    this.nms = this.data.slice(3, 3 + nmsLength);
  }

  get valueType() {
    const {
      nms,
      service
    } = this;

    switch (service) {
      case _NmsServiceType.default.Read:
        if (nms.length > 2) {
          return this.nms[1];
        }

        break;

      case _NmsServiceType.default.InformationReport:
        return this.nms[0];

      case _NmsServiceType.default.UploadSegment:
        return _NmsValueType.default.UInt32;

      case _NmsServiceType.default.RequestDomainUpload:
        return _NmsValueType.default.UInt32;

      case _NmsServiceType.default.RequestDomainDownload:
        return _NmsValueType.default.UInt32;

      default:
        break;
    }

    return undefined;
  }

  get status() {
    if (this.nms.length === 0 || !this.isResponse) {
      return undefined;
    }

    return this.nms.readInt8(0);
  }

  get value() {
    const {
      valueType,
      nms,
      service
    } = this;

    if (valueType === undefined) {
      return undefined;
    }

    const {
      length
    } = nms;

    const safeDecode = (index, type = valueType) => length < index + (0, _nms.getSizeOf)(type) ? undefined : (0, _nms.decodeValue)(type, nms, index);

    switch (service) {
      case _NmsServiceType.default.Read:
        return safeDecode(2);

      case _NmsServiceType.default.InformationReport:
        return safeDecode(1);

      case _NmsServiceType.default.RequestDomainUpload:
        return safeDecode(1);

      case _NmsServiceType.default.UploadSegment:
        return {
          data: nms.slice(5),
          offset: safeDecode(1)
        };

      case _NmsServiceType.default.RequestDomainDownload:
        return safeDecode(1);

      default:
        return undefined;
    }
  }

  isResponseFor(req) {
    const {
      isResponse,
      service,
      source,
      id
    } = this;
    return isResponse && service === req.service && (source.equals(req.destination) || id === req.id && req.destination.isEmpty);
  }

  toJSON() {
    const {
      data,
      ...props
    } = super.toJSON();
    const result = { ...props,
      id: this.id,
      service: _NmsServiceType.default[this.service],
      data: undefined
    };

    if (this.isResponse || this.service === _NmsServiceType.default.InformationReport) {
      if (this.valueType !== undefined) {
        // result.value = JSON.stringify(this.value);
        result.value = this.value;
        result.valueType = _NmsValueType.default[this.valueType];
      }

      result.status = this.status;
    } else {
      result.notReply = this.notReply;
      result.nms = Buffer.from(this.nms);
    }

    return result;
  }

}

exports.default = NmsDatagram;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ubXMvTm1zRGF0YWdyYW0udHMiXSwibmFtZXMiOlsiZW1wdHlCdWZmZXIiLCJCdWZmZXIiLCJhbGxvYyIsIk5tc0RhdGFncmFtIiwiTmlidXNEYXRhZ3JhbSIsImlzTm1zRnJhbWUiLCJmcmFtZSIsIlBSRUFNQkxFIiwibGVuZ3RoIiwiT2Zmc2V0cyIsIlBST1RPQ09MIiwiTEVOR1RIIiwiY29uc3RydWN0b3IiLCJmcmFtZU9yT3B0aW9ucyIsImlzQnVmZmVyIiwib3B0aW9ucyIsInNvdXJjZSIsIkFkZHJlc3MiLCJpc1Jlc3BvbnNlIiwibm90UmVwbHkiLCJubXMiLCJjb25zb2xlIiwiYXNzZXJ0IiwiTk1TX01BWF9EQVRBX0xFTkdUSCIsIm5tc0xlbmd0aCIsInNlcnZpY2UiLCJObXNTZXJ2aWNlVHlwZSIsIlJlYWQiLCJuaWJ1c0RhdGEiLCJpZCIsIm5pYnVzT3B0aW9ucyIsIk9iamVjdCIsImFzc2lnbiIsImRhdGEiLCJmcm9tIiwicHJvdG9jb2wiLCJ0aW1lb3V0IiwidW5kZWZpbmVkIiwic2xpY2UiLCJ2YWx1ZVR5cGUiLCJJbmZvcm1hdGlvblJlcG9ydCIsIlVwbG9hZFNlZ21lbnQiLCJObXNWYWx1ZVR5cGUiLCJVSW50MzIiLCJSZXF1ZXN0RG9tYWluVXBsb2FkIiwiUmVxdWVzdERvbWFpbkRvd25sb2FkIiwic3RhdHVzIiwicmVhZEludDgiLCJ2YWx1ZSIsInNhZmVEZWNvZGUiLCJpbmRleCIsInR5cGUiLCJvZmZzZXQiLCJpc1Jlc3BvbnNlRm9yIiwicmVxIiwiZXF1YWxzIiwiZGVzdGluYXRpb24iLCJpc0VtcHR5IiwidG9KU09OIiwicHJvcHMiLCJyZXN1bHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQVVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFZQSxNQUFNQSxXQUFXLEdBQUdDLE1BQU0sQ0FBQ0MsS0FBUCxDQUFhLENBQWIsQ0FBcEI7O0FBZWUsTUFBTUMsV0FBTixTQUEwQkMsb0JBQTFC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QUFDekIsRUFBWCxJQUFpQnlCLEdBQUcsQ0FBQ0UsV0FBSixDQUFnQkMsT0FEbkUsQ0FBUDtBQUVEOztBQUVNQyxFQUFBQSxNQUFQLEdBQWtDO0FBQ2hDLFVBQU07QUFBRXpCLE1BQUFBLElBQUY7QUFBUSxTQUFHMEI7QUFBWCxRQUFxQixNQUFNRCxNQUFOLEVBQTNCO0FBQ0EsVUFBTUUsTUFBd0IsR0FBRyxFQUMvQixHQUFHRCxLQUQ0QjtBQUUvQjlCLE1BQUFBLEVBQUUsRUFBRSxLQUFLQSxFQUZzQjtBQUcvQkosTUFBQUEsT0FBTyxFQUFFQyx3QkFBZSxLQUFLRCxPQUFwQixDQUhzQjtBQUkvQlEsTUFBQUEsSUFBSSxFQUFFSTtBQUp5QixLQUFqQzs7QUFNQSxRQUFJLEtBQUtuQixVQUFMLElBQW1CLEtBQUtPLE9BQUwsS0FBaUJDLHdCQUFlYyxpQkFBdkQsRUFBMEU7QUFDeEUsVUFBSSxLQUFLRCxTQUFMLEtBQW1CRixTQUF2QixFQUFrQztBQUNoQztBQUNBdUIsUUFBQUEsTUFBTSxDQUFDWixLQUFQLEdBQWUsS0FBS0EsS0FBcEI7QUFDQVksUUFBQUEsTUFBTSxDQUFDckIsU0FBUCxHQUFtQkcsc0JBQWEsS0FBS0gsU0FBbEIsQ0FBbkI7QUFDRDs7QUFDRHFCLE1BQUFBLE1BQU0sQ0FBQ2QsTUFBUCxHQUFnQixLQUFLQSxNQUFyQjtBQUNELEtBUEQsTUFPTztBQUNMYyxNQUFBQSxNQUFNLENBQUN6QyxRQUFQLEdBQWtCLEtBQUtBLFFBQXZCO0FBQ0F5QyxNQUFBQSxNQUFNLENBQUN4QyxHQUFQLEdBQWFuQixNQUFNLENBQUNpQyxJQUFQLENBQVksS0FBS2QsR0FBakIsQ0FBYjtBQUNEOztBQUNELFdBQU93QyxNQUFQO0FBQ0Q7O0FBM0kyRSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChjKSAyMDE5LiBPT08gTmF0YS1JbmZvXG4gKiBAYXV0aG9yIEFuZHJlaSBTYXJha2VldiA8YXZzQG5hdGEtaW5mby5ydT5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgXCJAbmF0YVwiIHByb2plY3QuXG4gKiBGb3IgdGhlIGZ1bGwgY29weXJpZ2h0IGFuZCBsaWNlbnNlIGluZm9ybWF0aW9uLCBwbGVhc2Ugdmlld1xuICogdGhlIEVVTEEgZmlsZSB0aGF0IHdhcyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgc291cmNlIGNvZGUuXG4gKi9cblxuaW1wb3J0IEFkZHJlc3MgZnJvbSAnLi4vQWRkcmVzcyc7XG5pbXBvcnQgeyBOTVNfTUFYX0RBVEFfTEVOR1RILCBPZmZzZXRzLCBQUkVBTUJMRSB9IGZyb20gJy4uL25iY29uc3QnO1xuaW1wb3J0IHsgSU5pYnVzQ29tbW9uLCBJTmlidXNEYXRhZ3JhbUpTT04sIElOaWJ1c09wdGlvbnMsIE5pYnVzRGF0YWdyYW0gfSBmcm9tICcuLi9uaWJ1cyc7XG5pbXBvcnQgeyBkZWNvZGVWYWx1ZSwgZ2V0U2l6ZU9mIH0gZnJvbSAnLi9ubXMnO1xuaW1wb3J0IE5tc1NlcnZpY2VUeXBlIGZyb20gJy4vTm1zU2VydmljZVR5cGUnO1xuaW1wb3J0IE5tc1ZhbHVlVHlwZSBmcm9tICcuL05tc1ZhbHVlVHlwZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSU5tc09wdGlvbnMgZXh0ZW5kcyBJTmlidXNDb21tb24ge1xuICBpZDogbnVtYmVyO1xuICBzZXJ2aWNlOiBObXNTZXJ2aWNlVHlwZTtcbiAgbm1zPzogQnVmZmVyO1xuICBpc1Jlc3BvbnNlPzogYm9vbGVhbjtcbiAgbm90UmVwbHk/OiBib29sZWFuO1xuICBzdGF0dXM/OiBudW1iZXI7XG4gIHRpbWVvdXQ/OiBudW1iZXI7XG59XG5cbmNvbnN0IGVtcHR5QnVmZmVyID0gQnVmZmVyLmFsbG9jKDApO1xuXG5leHBvcnQgaW50ZXJmYWNlIElObXNEYXRhZ3JhbUpTT04gZXh0ZW5kcyBJTmlidXNEYXRhZ3JhbUpTT04ge1xuICBwcm90b2NvbDogc3RyaW5nO1xuICBkYXRhPzogbmV2ZXI7XG4gIGlkOiBudW1iZXI7XG4gIHNlcnZpY2U6IHN0cmluZztcbiAgbm1zPzogQnVmZmVyO1xuICBpc1Jlc3BvbnNlPzogYm9vbGVhbjtcbiAgbm90UmVwbHk/OiBib29sZWFuO1xuICB2YWx1ZT86IHN0cmluZztcbiAgdmFsdWVUeXBlPzogc3RyaW5nO1xuICBzdGF0dXM/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE5tc0RhdGFncmFtIGV4dGVuZHMgTmlidXNEYXRhZ3JhbSBpbXBsZW1lbnRzIElObXNPcHRpb25zIHtcbiAgcHVibGljIHN0YXRpYyBpc05tc0ZyYW1lKGZyYW1lOiBCdWZmZXIpIHtcbiAgICByZXR1cm4gZnJhbWVbMF0gPT09IFBSRUFNQkxFICYmIGZyYW1lLmxlbmd0aCA+IDE1ICYmIGZyYW1lW09mZnNldHMuUFJPVE9DT0xdID09PSAxXG4gICAgICAmJiBmcmFtZVtPZmZzZXRzLkxFTkdUSF0gPiAzO1xuICB9XG5cbiAgcHVibGljIHJlYWRvbmx5IGlzUmVzcG9uc2U6IGJvb2xlYW47XG4gIHB1YmxpYyByZWFkb25seSBub3RSZXBseTogYm9vbGVhbjtcbiAgcHVibGljIHJlYWRvbmx5IHNlcnZpY2U6IG51bWJlcjtcbiAgcHVibGljIHJlYWRvbmx5IGlkOiBudW1iZXI7XG4gIHB1YmxpYyByZWFkb25seSBubXM6IEJ1ZmZlcjtcbiAgcHVibGljIHJlYWRvbmx5IHRpbWVvdXQ/OiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoZnJhbWVPck9wdGlvbnM6IEJ1ZmZlciB8IElObXNPcHRpb25zKSB7XG4gICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihmcmFtZU9yT3B0aW9ucykpIHtcbiAgICAgIHN1cGVyKGZyYW1lT3JPcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgICAgc291cmNlOiBuZXcgQWRkcmVzcygnYXV0bycpLFxuICAgICAgICBpc1Jlc3BvbnNlOiBmYWxzZSxcbiAgICAgICAgbm90UmVwbHk6IGZhbHNlLFxuICAgICAgICBubXM6IGVtcHR5QnVmZmVyLFxuICAgICAgICAuLi5mcmFtZU9yT3B0aW9ucyxcbiAgICAgIH07XG4gICAgICBjb25zb2xlLmFzc2VydChvcHRpb25zLm5tcy5sZW5ndGggPD0gTk1TX01BWF9EQVRBX0xFTkdUSCk7XG4gICAgICAvLyBmaXg6IE5NUyBiYXRjaCByZWFkXG4gICAgICBjb25zdCBubXNMZW5ndGggPSBvcHRpb25zLnNlcnZpY2UgIT09IE5tc1NlcnZpY2VUeXBlLlJlYWRcbiAgICAgICAgPyAob3B0aW9ucy5ubXMubGVuZ3RoICYgMHgzZilcbiAgICAgICAgOiAwO1xuICAgICAgY29uc3QgbmlidXNEYXRhID0gW1xuICAgICAgICAoKG9wdGlvbnMuc2VydmljZSAmIDB4MWYpIDw8IDMpIHwgKG9wdGlvbnMuaXNSZXNwb25zZSA/IDQgOiAwKSB8ICgob3B0aW9ucy5pZCA+PiA4KSAmIDMpLFxuICAgICAgICBvcHRpb25zLmlkICYgMHhmZixcbiAgICAgICAgKG9wdGlvbnMubm90UmVwbHkgPyAweDgwIDogMCkgfCBubXNMZW5ndGgsXG4gICAgICAgIC4uLm9wdGlvbnMubm1zLFxuICAgICAgXTtcbiAgICAgIGNvbnN0IG5pYnVzT3B0aW9uczogSU5pYnVzT3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgICBkYXRhOiBCdWZmZXIuZnJvbShuaWJ1c0RhdGEpLFxuICAgICAgICBwcm90b2NvbDogMSxcbiAgICAgIH0sIG9wdGlvbnMpO1xuICAgICAgc3VwZXIobmlidXNPcHRpb25zKTtcbiAgICAgIGlmIChmcmFtZU9yT3B0aW9ucy50aW1lb3V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy50aW1lb3V0ID0gZnJhbWVPck9wdGlvbnMudGltZW91dDtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgeyBkYXRhIH0gPSB0aGlzO1xuICAgIHRoaXMuaWQgPSAoKGRhdGFbMF0gJiAzKSA8PCA4KSB8IGRhdGFbMV07XG4gICAgdGhpcy5zZXJ2aWNlID0gZGF0YVswXSA+PiAzO1xuICAgIHRoaXMuaXNSZXNwb25zZSA9ICEhKGRhdGFbMF0gJiA0KTtcbiAgICB0aGlzLm5vdFJlcGx5ID0gISEoZGF0YVsyXSAmIDB4ODApO1xuICAgIC8vIGZpeDogTk1TIGJhdGNoIHJlYWRcbiAgICBjb25zdCBubXNMZW5ndGggPSB0aGlzLnNlcnZpY2UgIT09IE5tc1NlcnZpY2VUeXBlLlJlYWRcbiAgICAgID8gZGF0YVsyXSAmIDB4M0ZcbiAgICAgIDogZGF0YS5sZW5ndGggLSAzO1xuICAgIHRoaXMubm1zID0gdGhpcy5kYXRhLnNsaWNlKDMsIDMgKyBubXNMZW5ndGgpO1xuICB9XG5cbiAgZ2V0IHZhbHVlVHlwZSgpIHtcbiAgICBjb25zdCB7IG5tcywgc2VydmljZSB9ID0gdGhpcztcbiAgICBzd2l0Y2ggKHNlcnZpY2UpIHtcbiAgICAgIGNhc2UgTm1zU2VydmljZVR5cGUuUmVhZDpcbiAgICAgICAgaWYgKG5tcy5sZW5ndGggPiAyKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMubm1zWzFdO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBObXNTZXJ2aWNlVHlwZS5JbmZvcm1hdGlvblJlcG9ydDpcbiAgICAgICAgcmV0dXJuIHRoaXMubm1zWzBdO1xuICAgICAgY2FzZSBObXNTZXJ2aWNlVHlwZS5VcGxvYWRTZWdtZW50OlxuICAgICAgICByZXR1cm4gTm1zVmFsdWVUeXBlLlVJbnQzMjtcbiAgICAgIGNhc2UgTm1zU2VydmljZVR5cGUuUmVxdWVzdERvbWFpblVwbG9hZDpcbiAgICAgICAgcmV0dXJuIE5tc1ZhbHVlVHlwZS5VSW50MzI7XG4gICAgICBjYXNlIE5tc1NlcnZpY2VUeXBlLlJlcXVlc3REb21haW5Eb3dubG9hZDpcbiAgICAgICAgcmV0dXJuIE5tc1ZhbHVlVHlwZS5VSW50MzI7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVhaztcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGdldCBzdGF0dXMoKSB7XG4gICAgaWYgKHRoaXMubm1zLmxlbmd0aCA9PT0gMCB8fCAhdGhpcy5pc1Jlc3BvbnNlKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5ubXMucmVhZEludDgoMCk7XG4gIH1cblxuICBnZXQgdmFsdWUoKSB7XG4gICAgY29uc3QgeyB2YWx1ZVR5cGUsIG5tcywgc2VydmljZSB9ID0gdGhpcztcbiAgICBpZiAodmFsdWVUeXBlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSBubXM7XG4gICAgY29uc3Qgc2FmZURlY29kZSA9IChpbmRleDogbnVtYmVyLCB0eXBlID0gdmFsdWVUeXBlKSA9PiAobGVuZ3RoIDwgaW5kZXggKyBnZXRTaXplT2YodHlwZSlcbiAgICAgID8gdW5kZWZpbmVkXG4gICAgICA6IGRlY29kZVZhbHVlKHR5cGUsIG5tcywgaW5kZXgpKTtcbiAgICBzd2l0Y2ggKHNlcnZpY2UpIHtcbiAgICAgIGNhc2UgTm1zU2VydmljZVR5cGUuUmVhZDpcbiAgICAgICAgcmV0dXJuIHNhZmVEZWNvZGUoMik7XG4gICAgICBjYXNlIE5tc1NlcnZpY2VUeXBlLkluZm9ybWF0aW9uUmVwb3J0OlxuICAgICAgICByZXR1cm4gc2FmZURlY29kZSgxKTtcbiAgICAgIGNhc2UgTm1zU2VydmljZVR5cGUuUmVxdWVzdERvbWFpblVwbG9hZDpcbiAgICAgICAgcmV0dXJuIHNhZmVEZWNvZGUoMSk7XG4gICAgICBjYXNlIE5tc1NlcnZpY2VUeXBlLlVwbG9hZFNlZ21lbnQ6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgZGF0YTogbm1zLnNsaWNlKDUpLFxuICAgICAgICAgIG9mZnNldDogc2FmZURlY29kZSgxKSxcbiAgICAgICAgfTtcbiAgICAgIGNhc2UgTm1zU2VydmljZVR5cGUuUmVxdWVzdERvbWFpbkRvd25sb2FkOlxuICAgICAgICByZXR1cm4gc2FmZURlY29kZSgxKTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGlzUmVzcG9uc2VGb3IocmVxOiBObXNEYXRhZ3JhbSkge1xuICAgIGNvbnN0IHsgaXNSZXNwb25zZSwgc2VydmljZSwgc291cmNlLCBpZCB9ID0gdGhpcztcbiAgICByZXR1cm4gaXNSZXNwb25zZSAmJiBzZXJ2aWNlID09PSByZXEuc2VydmljZVxuICAgICAgJiYgKHNvdXJjZS5lcXVhbHMocmVxLmRlc3RpbmF0aW9uKSB8fCAoaWQgPT09IHJlcS5pZCAmJiByZXEuZGVzdGluYXRpb24uaXNFbXB0eSkpO1xuICB9XG5cbiAgcHVibGljIHRvSlNPTigpOiBJTm1zRGF0YWdyYW1KU09OIHtcbiAgICBjb25zdCB7IGRhdGEsIC4uLnByb3BzIH0gPSBzdXBlci50b0pTT04oKTtcbiAgICBjb25zdCByZXN1bHQ6IElObXNEYXRhZ3JhbUpTT04gPSB7XG4gICAgICAuLi5wcm9wcyxcbiAgICAgIGlkOiB0aGlzLmlkLFxuICAgICAgc2VydmljZTogTm1zU2VydmljZVR5cGVbdGhpcy5zZXJ2aWNlXSxcbiAgICAgIGRhdGE6IHVuZGVmaW5lZCxcbiAgICB9O1xuICAgIGlmICh0aGlzLmlzUmVzcG9uc2UgfHwgdGhpcy5zZXJ2aWNlID09PSBObXNTZXJ2aWNlVHlwZS5JbmZvcm1hdGlvblJlcG9ydCkge1xuICAgICAgaWYgKHRoaXMudmFsdWVUeXBlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgLy8gcmVzdWx0LnZhbHVlID0gSlNPTi5zdHJpbmdpZnkodGhpcy52YWx1ZSk7XG4gICAgICAgIHJlc3VsdC52YWx1ZSA9IHRoaXMudmFsdWU7XG4gICAgICAgIHJlc3VsdC52YWx1ZVR5cGUgPSBObXNWYWx1ZVR5cGVbdGhpcy52YWx1ZVR5cGVdO1xuICAgICAgfVxuICAgICAgcmVzdWx0LnN0YXR1cyA9IHRoaXMuc3RhdHVzO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQubm90UmVwbHkgPSB0aGlzLm5vdFJlcGx5O1xuICAgICAgcmVzdWx0Lm5tcyA9IEJ1ZmZlci5mcm9tKHRoaXMubm1zKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuIl19