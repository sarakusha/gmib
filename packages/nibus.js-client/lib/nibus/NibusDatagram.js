"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Protocol = void 0;

require("source-map-support/register");

require("reflect-metadata");

var _crc = require("crc");

var _lodash = _interopRequireDefault(require("lodash"));

var _Address = _interopRequireDefault(require("../Address"));

var _nbconst = require("../nbconst");

var _helper = require("./helper");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

let Protocol;
exports.Protocol = Protocol;

(function (Protocol) {
  Protocol[Protocol["NMS"] = 1] = "NMS";
  Protocol[Protocol["SARP"] = 2] = "SARP";
})(Protocol || (exports.Protocol = Protocol = {}));

const leadZero = value => `0${value}`.slice(-2);

// @timeStamp
class NibusDatagram {
  // @noenum
  // @noenum
  // public readonly timeStamp: number;
  constructor(frameOrOptions) {
    _defineProperty(this, "priority", void 0);

    _defineProperty(this, "protocol", void 0);

    _defineProperty(this, "destination", void 0);

    _defineProperty(this, "source", void 0);

    _defineProperty(this, "data", void 0);

    _defineProperty(this, "raw", void 0);

    if (Buffer.isBuffer(frameOrOptions)) {
      const frame = Buffer.from(frameOrOptions);
      console.assert(_nbconst.Offsets.DATA < frame.length && frame.length < 256, 'Invalid datagram');
      this.raw = frame;
    } else {
      const options = {
        priority: 0,
        source: NibusDatagram.defaultSource,
        ...frameOrOptions
      }; // console.log('OPTIONS', options, frameOrOptions);

      console.assert(options.data.length <= _nbconst.MAX_DATA_LENGTH);

      const destination = _Address.default.toAddress(options.destination);

      const source = _Address.default.toAddress(options.source);

      const frame = [_nbconst.PREAMBLE, ...destination.raw, ...source.raw, 0xC0 | (options.priority & 3) << 4 | (destination.rawType & 3) << 2 | source.rawType & 3, options.data.length + 1, options.protocol, ...options.data];
      const crc = (0, _crc.crc16ccitt)(Buffer.from(frame.slice(1)), 0);
      frame.push(crc >> 8, crc & 255);
      this.raw = Buffer.from(frame);
    }

    const serviceByte = this.raw[_nbconst.Offsets.SERVICE];
    const destAddressType = serviceByte >> 2 & 3;
    const srcAddressType = serviceByte & 3;
    this.priority = serviceByte >> 4 & 3;
    this.protocol = this.raw[_nbconst.Offsets.PROTOCOL];
    this.destination = _Address.default.read(destAddressType, this.raw, _nbconst.Offsets.DESTINATION);
    this.source = _Address.default.read(srcAddressType, this.raw, _nbconst.Offsets.SOURCE); // Реальная длина данных на 1 меньше чем указано в LENGTH!

    this.data = this.raw.slice(_nbconst.Offsets.DATA, _nbconst.Offsets.DATA + this.raw[_nbconst.Offsets.LENGTH] - 1);
    Reflect.defineMetadata('timeStamp', Date.now(), this);
    process.nextTick(() => Object.freeze(this));
  }

  toJSON() {
    const ts = new Date(Reflect.getMetadata('timeStamp', this));
    return {
      priority: this.priority,
      protocol: Protocol[this.protocol],
      source: this.source.toString(),
      destination: this.destination.toString(),
      timeStamp: `${leadZero(ts.getHours())}:${leadZero(ts.getMinutes())}:\
${leadZero(ts.getSeconds())}.${ts.getMilliseconds()}`,
      data: Buffer.from(this.data)
    };
  }

  toString(opts) {
    let self = replaceBuffers(this.toJSON());

    if (opts) {
      if (opts.pick) {
        self = _lodash.default.pick(self, opts.pick);
      }

      if (opts.omit) {
        self = _lodash.default.omit(self, opts.omit);
      }
    }

    return JSON.stringify(self);
  }

}

exports.default = NibusDatagram;

_defineProperty(NibusDatagram, "defaultSource", _Address.default.empty);

const replaceBuffers = obj => {
  Object.entries(obj).forEach(([name, value]) => {
    if (Buffer.isBuffer(value)) {
      obj[name] = (0, _helper.printBuffer)(value);
    } else if (_lodash.default.isPlainObject(value)) {
      obj[name] = replaceBuffers(value);
    }
  });
  return obj;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9uaWJ1cy9OaWJ1c0RhdGFncmFtLnRzIl0sIm5hbWVzIjpbIlByb3RvY29sIiwibGVhZFplcm8iLCJ2YWx1ZSIsInNsaWNlIiwiTmlidXNEYXRhZ3JhbSIsImNvbnN0cnVjdG9yIiwiZnJhbWVPck9wdGlvbnMiLCJCdWZmZXIiLCJpc0J1ZmZlciIsImZyYW1lIiwiZnJvbSIsImNvbnNvbGUiLCJhc3NlcnQiLCJPZmZzZXRzIiwiREFUQSIsImxlbmd0aCIsInJhdyIsIm9wdGlvbnMiLCJwcmlvcml0eSIsInNvdXJjZSIsImRlZmF1bHRTb3VyY2UiLCJkYXRhIiwiTUFYX0RBVEFfTEVOR1RIIiwiZGVzdGluYXRpb24iLCJBZGRyZXNzIiwidG9BZGRyZXNzIiwiUFJFQU1CTEUiLCJyYXdUeXBlIiwicHJvdG9jb2wiLCJjcmMiLCJwdXNoIiwic2VydmljZUJ5dGUiLCJTRVJWSUNFIiwiZGVzdEFkZHJlc3NUeXBlIiwic3JjQWRkcmVzc1R5cGUiLCJQUk9UT0NPTCIsInJlYWQiLCJERVNUSU5BVElPTiIsIlNPVVJDRSIsIkxFTkdUSCIsIlJlZmxlY3QiLCJkZWZpbmVNZXRhZGF0YSIsIkRhdGUiLCJub3ciLCJwcm9jZXNzIiwibmV4dFRpY2siLCJPYmplY3QiLCJmcmVlemUiLCJ0b0pTT04iLCJ0cyIsImdldE1ldGFkYXRhIiwidG9TdHJpbmciLCJ0aW1lU3RhbXAiLCJnZXRIb3VycyIsImdldE1pbnV0ZXMiLCJnZXRTZWNvbmRzIiwiZ2V0TWlsbGlzZWNvbmRzIiwib3B0cyIsInNlbGYiLCJyZXBsYWNlQnVmZmVycyIsInBpY2siLCJfIiwib21pdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJlbXB0eSIsIm9iaiIsImVudHJpZXMiLCJmb3JFYWNoIiwibmFtZSIsImlzUGxhaW5PYmplY3QiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQVVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7SUFVWUEsUTs7O1dBQUFBLFE7QUFBQUEsRUFB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LypcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkuIE9PTyBOYXRhLUluZm9cbiAqIEBhdXRob3IgQW5kcmVpIFNhcmFrZWV2IDxhdnNAbmF0YS1pbmZvLnJ1PlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBcIkBuYXRhXCIgcHJvamVjdC5cbiAqIEZvciB0aGUgZnVsbCBjb3B5cmlnaHQgYW5kIGxpY2Vuc2UgaW5mb3JtYXRpb24sIHBsZWFzZSB2aWV3XG4gKiB0aGUgRVVMQSBmaWxlIHRoYXQgd2FzIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyBzb3VyY2UgY29kZS5cbiAqL1xuXG5pbXBvcnQgJ3JlZmxlY3QtbWV0YWRhdGEnO1xuaW1wb3J0IHsgY3JjMTZjY2l0dCB9IGZyb20gJ2NyYyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEFkZHJlc3MsIHsgQWRkcmVzc1BhcmFtIH0gZnJvbSAnLi4vQWRkcmVzcyc7XG5pbXBvcnQgeyBNQVhfREFUQV9MRU5HVEgsIE9mZnNldHMsIFBSRUFNQkxFIH0gZnJvbSAnLi4vbmJjb25zdCc7XG5pbXBvcnQgeyBwcmludEJ1ZmZlciB9IGZyb20gJy4vaGVscGVyJztcblxuLy8gaW1wb3J0IHt0aW1lU3RhbXB9IGZyb20gJy4uL3V0aWxzJztcblxuZXhwb3J0IGludGVyZmFjZSBJTmlidXNDb21tb24ge1xuICBkZXN0aW5hdGlvbjogQWRkcmVzc1BhcmFtO1xuICBwcmlvcml0eT86IG51bWJlcjtcbiAgc291cmNlPzogQWRkcmVzc1BhcmFtO1xufVxuXG5leHBvcnQgZW51bSBQcm90b2NvbCB7XG4gIE5NUyA9IDEsXG4gIFNBUlAgPSAyLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElOaWJ1c09wdGlvbnMgZXh0ZW5kcyBJTmlidXNDb21tb24ge1xuICBwcm90b2NvbDogUHJvdG9jb2w7XG4gIGRhdGE6IEJ1ZmZlcjtcbn1cblxuY29uc3QgbGVhZFplcm8gPSAodmFsdWU6IG51bWJlcikgPT4gYDAke3ZhbHVlfWAuc2xpY2UoLTIpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElOaWJ1c0RhdGFncmFtSlNPTiB7XG4gIHByaW9yaXR5OiBudW1iZXI7XG4gIHByb3RvY29sOiBzdHJpbmc7XG4gIGRlc3RpbmF0aW9uOiBzdHJpbmc7XG4gIHNvdXJjZTogc3RyaW5nO1xuICB0aW1lU3RhbXA6IHN0cmluZztcbiAgZGF0YT86IEJ1ZmZlcjtcbn1cblxuLy8gQHRpbWVTdGFtcFxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTmlidXNEYXRhZ3JhbSBpbXBsZW1lbnRzIElOaWJ1c09wdGlvbnMge1xuICBwdWJsaWMgc3RhdGljIGRlZmF1bHRTb3VyY2U6IEFkZHJlc3NQYXJhbSA9IEFkZHJlc3MuZW1wdHk7XG4gIHB1YmxpYyByZWFkb25seSBwcmlvcml0eTogbnVtYmVyO1xuICBwdWJsaWMgcmVhZG9ubHkgcHJvdG9jb2w6IG51bWJlcjtcbiAgcHVibGljIHJlYWRvbmx5IGRlc3RpbmF0aW9uOiBBZGRyZXNzO1xuICBwdWJsaWMgcmVhZG9ubHkgc291cmNlOiBBZGRyZXNzO1xuICBwdWJsaWMgcmVhZG9ubHkgZGF0YTogQnVmZmVyO1xuXG4gIC8vIEBub2VudW1cbiAgcHVibGljIHJlYWRvbmx5IHJhdzogQnVmZmVyO1xuXG4gIC8vIEBub2VudW1cbiAgLy8gcHVibGljIHJlYWRvbmx5IHRpbWVTdGFtcDogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKGZyYW1lT3JPcHRpb25zOiBCdWZmZXIgfCBJTmlidXNPcHRpb25zKSB7XG4gICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcihmcmFtZU9yT3B0aW9ucykpIHtcbiAgICAgIGNvbnN0IGZyYW1lOiBCdWZmZXIgPSBCdWZmZXIuZnJvbShmcmFtZU9yT3B0aW9ucyk7XG4gICAgICBjb25zb2xlLmFzc2VydChcbiAgICAgICAgT2Zmc2V0cy5EQVRBIDwgZnJhbWUubGVuZ3RoICYmIGZyYW1lLmxlbmd0aCA8IDI1NixcbiAgICAgICAgJ0ludmFsaWQgZGF0YWdyYW0nLFxuICAgICAgKTtcbiAgICAgIHRoaXMucmF3ID0gZnJhbWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgIHByaW9yaXR5OiAwLFxuICAgICAgICBzb3VyY2U6IE5pYnVzRGF0YWdyYW0uZGVmYXVsdFNvdXJjZSxcbiAgICAgICAgLi4uZnJhbWVPck9wdGlvbnMsXG4gICAgICB9O1xuICAgICAgLy8gY29uc29sZS5sb2coJ09QVElPTlMnLCBvcHRpb25zLCBmcmFtZU9yT3B0aW9ucyk7XG4gICAgICBjb25zb2xlLmFzc2VydChvcHRpb25zLmRhdGEubGVuZ3RoIDw9IE1BWF9EQVRBX0xFTkdUSCk7XG4gICAgICBjb25zdCBkZXN0aW5hdGlvbiA9IEFkZHJlc3MudG9BZGRyZXNzKG9wdGlvbnMuZGVzdGluYXRpb24pITtcbiAgICAgIGNvbnN0IHNvdXJjZSA9IEFkZHJlc3MudG9BZGRyZXNzKG9wdGlvbnMuc291cmNlKSE7XG4gICAgICBjb25zdCBmcmFtZSA9IFtcbiAgICAgICAgUFJFQU1CTEUsXG4gICAgICAgIC4uLmRlc3RpbmF0aW9uLnJhdyxcbiAgICAgICAgLi4uc291cmNlLnJhdyxcbiAgICAgICAgMHhDMCB8IChvcHRpb25zLnByaW9yaXR5ICYgMykgPDwgNCB8IChkZXN0aW5hdGlvbi5yYXdUeXBlICYgMykgPDwgMiB8IChzb3VyY2UucmF3VHlwZSAmIDMpLFxuICAgICAgICBvcHRpb25zLmRhdGEubGVuZ3RoICsgMSxcbiAgICAgICAgb3B0aW9ucy5wcm90b2NvbCxcbiAgICAgICAgLi4ub3B0aW9ucy5kYXRhLFxuICAgICAgXTtcbiAgICAgIGNvbnN0IGNyYyA9IGNyYzE2Y2NpdHQoQnVmZmVyLmZyb20oZnJhbWUuc2xpY2UoMSkpLCAwKTtcbiAgICAgIGZyYW1lLnB1c2goY3JjID4+IDgsIGNyYyAmIDI1NSk7XG4gICAgICB0aGlzLnJhdyA9IEJ1ZmZlci5mcm9tKGZyYW1lKTtcbiAgICB9XG4gICAgY29uc3Qgc2VydmljZUJ5dGUgPSB0aGlzLnJhd1tPZmZzZXRzLlNFUlZJQ0VdO1xuICAgIGNvbnN0IGRlc3RBZGRyZXNzVHlwZSA9IChzZXJ2aWNlQnl0ZSA+PiAyKSAmIDM7XG4gICAgY29uc3Qgc3JjQWRkcmVzc1R5cGUgPSBzZXJ2aWNlQnl0ZSAmIDM7XG5cbiAgICB0aGlzLnByaW9yaXR5ID0gKHNlcnZpY2VCeXRlID4+IDQpICYgMztcbiAgICB0aGlzLnByb3RvY29sID0gdGhpcy5yYXdbT2Zmc2V0cy5QUk9UT0NPTF07XG4gICAgdGhpcy5kZXN0aW5hdGlvbiA9IEFkZHJlc3MucmVhZChkZXN0QWRkcmVzc1R5cGUsIHRoaXMucmF3LCBPZmZzZXRzLkRFU1RJTkFUSU9OKTtcbiAgICB0aGlzLnNvdXJjZSA9IEFkZHJlc3MucmVhZChzcmNBZGRyZXNzVHlwZSwgdGhpcy5yYXcsIE9mZnNldHMuU09VUkNFKTtcbiAgICAvLyDQoNC10LDQu9GM0L3QsNGPINC00LvQuNC90LAg0LTQsNC90L3Ri9GFINC90LAgMSDQvNC10L3RjNGI0LUg0YfQtdC8INGD0LrQsNC30LDQvdC+INCyIExFTkdUSCFcbiAgICB0aGlzLmRhdGEgPSB0aGlzLnJhdy5zbGljZShPZmZzZXRzLkRBVEEsIChPZmZzZXRzLkRBVEEgKyB0aGlzLnJhd1tPZmZzZXRzLkxFTkdUSF0pIC0gMSk7XG4gICAgUmVmbGVjdC5kZWZpbmVNZXRhZGF0YSgndGltZVN0YW1wJywgRGF0ZS5ub3coKSwgdGhpcyk7XG4gICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiBPYmplY3QuZnJlZXplKHRoaXMpKTtcbiAgfVxuXG4gIHB1YmxpYyB0b0pTT04oKTogSU5pYnVzRGF0YWdyYW1KU09OIHtcbiAgICBjb25zdCB0cyA9IG5ldyBEYXRlKFJlZmxlY3QuZ2V0TWV0YWRhdGEoJ3RpbWVTdGFtcCcsIHRoaXMpKTtcbiAgICByZXR1cm4ge1xuICAgICAgcHJpb3JpdHk6IHRoaXMucHJpb3JpdHksXG4gICAgICBwcm90b2NvbDogUHJvdG9jb2xbdGhpcy5wcm90b2NvbF0sXG4gICAgICBzb3VyY2U6IHRoaXMuc291cmNlLnRvU3RyaW5nKCksXG4gICAgICBkZXN0aW5hdGlvbjogdGhpcy5kZXN0aW5hdGlvbi50b1N0cmluZygpLFxuICAgICAgdGltZVN0YW1wOiBgJHtsZWFkWmVybyh0cy5nZXRIb3VycygpKX06JHtsZWFkWmVybyh0cy5nZXRNaW51dGVzKCkpfTpcXFxuJHtsZWFkWmVybyh0cy5nZXRTZWNvbmRzKCkpfS4ke3RzLmdldE1pbGxpc2Vjb25kcygpfWAsXG4gICAgICBkYXRhOiBCdWZmZXIuZnJvbSh0aGlzLmRhdGEpLFxuICAgIH07XG4gIH1cblxuICB0b1N0cmluZyhvcHRzPzogeyBwaWNrPzogc3RyaW5nW10sIG9taXQ/OiBzdHJpbmdbXSB9KSB7XG4gICAgbGV0IHNlbGY6IGFueSA9IHJlcGxhY2VCdWZmZXJzKHRoaXMudG9KU09OKCkpO1xuICAgIGlmIChvcHRzKSB7XG4gICAgICBpZiAob3B0cy5waWNrKSB7XG4gICAgICAgIHNlbGYgPSBfLnBpY2soc2VsZiwgb3B0cy5waWNrKTtcbiAgICAgIH1cbiAgICAgIGlmIChvcHRzLm9taXQpIHtcbiAgICAgICAgc2VsZiA9IF8ub21pdChzZWxmLCBvcHRzLm9taXQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoc2VsZik7XG4gIH1cbn1cblxuY29uc3QgcmVwbGFjZUJ1ZmZlcnMgPSAob2JqOiBhbnkpID0+IHtcbiAgT2JqZWN0LmVudHJpZXMob2JqKS5mb3JFYWNoKChbbmFtZSwgdmFsdWVdKSA9PiB7XG4gICAgaWYgKEJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSkpIHtcbiAgICAgIG9ialtuYW1lXSA9IHByaW50QnVmZmVyKHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKF8uaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHtcbiAgICAgIG9ialtuYW1lXSA9IHJlcGxhY2VCdWZmZXJzKHZhbHVlKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gb2JqO1xufVxuIl19