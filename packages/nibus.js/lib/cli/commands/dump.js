"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _chalk = _interopRequireDefault(require("chalk"));

var _cliTable = _interopRequireDefault(require("cli-table3"));

var _lodash = _interopRequireDefault(require("lodash"));

var _debug = _interopRequireDefault(require("debug"));

var _nibus = _interopRequireWildcard(require("@nata/nibus.js-client"));

var _mib = require("@nata/nibus.js-client/lib/mib");

var _nibus2 = require("@nata/nibus.js-client/lib/nibus");

var _sarp = require("@nata/nibus.js-client/lib/sarp");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * @license
 * Copyright (c) 2019. Nata-Info
 * @author Andrei Sarakeev <avs@nata-info.ru>
 *
 * This file is part of the "@nata" project.
 * For the full copyright and license information, please view
 * the EULA file that was distributed with this source code.
 */
const debug = (0, _debug.default)('nibus:dump');
let count = 0;

async function dumpDevice(address, connection, argv, mib) {
  const raw = argv.raw;
  const compact = argv.compact;
  let device;

  if (!mib) {
    const [version, type] = await connection.getVersion(address);
    device = _mib.devices.create(address, type, version);
  } else {
    device = _mib.devices.create(address, mib);
  }

  device.connection = connection;
  let ids = [];

  if (argv.name) {
    ids = argv.name.map(name => device.getId(name));
  }

  const result = await device.read(...ids);
  const rows = Object.keys(result).map(key => {
    const value = raw ? device.getError(key) || device.getRawValue(key) : result[key];
    return {
      value,
      key,
      displayName: Reflect.getMetadata('displayName', device, key)
    };
  });
  const proto = Reflect.getPrototypeOf(device);
  device.release();

  const categories = _lodash.default.groupBy(rows, ({
    key
  }) => Reflect.getMetadata('category', proto, key) || '');

  console.info(` Устройство ${Reflect.getMetadata('mib', proto)} [${address.toString()}]`);
  const table = new _cliTable.default({
    head: ['Название', 'Значение', 'Имя'],
    style: {
      compact
    },
    wordWrap: true
  });

  const toRow = ({
    displayName,
    value,
    key
  }) => {
    let val;

    if (value && value.error) {
      val = _chalk.default.red(value.error);
    } else if (value && value.errcode) {
      val = _chalk.default.red(`errcode: ${value.errcode}`);
    } else {
      val = JSON.stringify(value);

      if (!Reflect.getMetadata('isWritable', proto, key)) {
        val = _chalk.default.grey(val);
      }
    }

    return [displayName, val, key];
  };

  Object.keys(categories).forEach(category => {
    const rows = categories[category];

    if (category) {
      table.push([{
        colSpan: 3,
        content: _chalk.default.yellow(category.toUpperCase())
      }]);
    }

    table.push(...rows.map(toRow));
  });
  console.info(table.toString());
}

function findDevices(mib, connection, argv) {
  count += 1;
  const proto = (0, _mib.getMibPrototype)(mib);
  const type = Reflect.getMetadata('deviceType', proto);
  connection.findByType(type).catch(e => debug('error while findByType', e.stack));
  connection.on('sarp', datagram => {
    count += 1;
    if (datagram.queryType !== _sarp.SarpQueryType.ByType) return;
    const responseType = datagram.queryParam.readUInt16BE(3); // const item = types.find(({ type }) => responseType === type);

    if (responseType !== type) return;
    const address = new _nibus.Address(datagram.mac);
    dumpDevice(address, connection, argv, mib).catch( // () => {},
    e => console.error('error while dump:', e.message));
  });
}

const dumpCommand = {
  command: 'dump',
  describe: 'Выдать дампы устройств',
  builder: argv => argv.check(argv => {
    if (argv.id && !argv.mac && !argv.mib) {
      throw `Данный аргумент требует следующий дополнительный аргумент:
 id -> mib или id -> mac`;
    }

    return true;
  }),
  handler: argv => new Promise(async (resolve, reject) => {
    const close = err => {
      clearTimeout(timeout);

      _nibus.default.close();

      if (err) reject(err);else resolve();
    };

    const mac = argv.mac && new _nibus.Address(argv.mac);
    count = await _nibus.default.start();

    _nibus.default.on('found', async ({
      address,
      connection
    }) => {
      try {
        if (connection.description.link) {
          if (mac) {
            count += 1;
            await dumpDevice(mac, connection, argv);
          } else if (argv.mib) {
            findDevices(argv.mib, connection, argv);
          }
        }

        if ((!mac || mac.equals(address)) && (!argv.mib || argv.mib === connection.description.mib)) {
          await dumpDevice(address, connection, argv, connection.description.mib);
        }

        count -= 1;

        if (count === 0) {
          clearTimeout(timeout);
          process.nextTick(close);
        }
      } catch (e) {
        close(e.message || e);
      }
    });

    const wait = () => {
      count -= 1;

      if (count > 0) {
        timeout = setTimeout(wait, (0, _nibus2.getNibusTimeout)());
      } else {
        close();
      }
    };

    let timeout = setTimeout(wait, (0, _nibus2.getNibusTimeout)());
  })
};
var _default = dumpCommand;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGkvY29tbWFuZHMvZHVtcC50cyJdLCJuYW1lcyI6WyJkZWJ1ZyIsImNvdW50IiwiZHVtcERldmljZSIsImFkZHJlc3MiLCJjb25uZWN0aW9uIiwiYXJndiIsIm1pYiIsInJhdyIsImNvbXBhY3QiLCJkZXZpY2UiLCJ2ZXJzaW9uIiwidHlwZSIsImdldFZlcnNpb24iLCJkZXZpY2VzIiwiY3JlYXRlIiwiaWRzIiwibmFtZSIsIm1hcCIsImdldElkIiwicmVzdWx0IiwicmVhZCIsInJvd3MiLCJPYmplY3QiLCJrZXlzIiwia2V5IiwidmFsdWUiLCJnZXRFcnJvciIsImdldFJhd1ZhbHVlIiwiZGlzcGxheU5hbWUiLCJSZWZsZWN0IiwiZ2V0TWV0YWRhdGEiLCJwcm90byIsImdldFByb3RvdHlwZU9mIiwicmVsZWFzZSIsImNhdGVnb3JpZXMiLCJfIiwiZ3JvdXBCeSIsImNvbnNvbGUiLCJpbmZvIiwidG9TdHJpbmciLCJ0YWJsZSIsIlRhYmxlIiwiaGVhZCIsInN0eWxlIiwid29yZFdyYXAiLCJ0b1JvdyIsInZhbCIsImVycm9yIiwiY2hhbGsiLCJyZWQiLCJlcnJjb2RlIiwiSlNPTiIsInN0cmluZ2lmeSIsImdyZXkiLCJmb3JFYWNoIiwiY2F0ZWdvcnkiLCJwdXNoIiwiY29sU3BhbiIsImNvbnRlbnQiLCJ5ZWxsb3ciLCJ0b1VwcGVyQ2FzZSIsImZpbmREZXZpY2VzIiwiZmluZEJ5VHlwZSIsImNhdGNoIiwiZSIsInN0YWNrIiwib24iLCJkYXRhZ3JhbSIsInF1ZXJ5VHlwZSIsIlNhcnBRdWVyeVR5cGUiLCJCeVR5cGUiLCJyZXNwb25zZVR5cGUiLCJxdWVyeVBhcmFtIiwicmVhZFVJbnQxNkJFIiwiQWRkcmVzcyIsIm1hYyIsIm1lc3NhZ2UiLCJkdW1wQ29tbWFuZCIsImNvbW1hbmQiLCJkZXNjcmliZSIsImJ1aWxkZXIiLCJjaGVjayIsImlkIiwiaGFuZGxlciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiY2xvc2UiLCJlcnIiLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0Iiwic2Vzc2lvbiIsInN0YXJ0IiwiZGVzY3JpcHRpb24iLCJsaW5rIiwiZXF1YWxzIiwicHJvY2VzcyIsIm5leHRUaWNrIiwid2FpdCIsInNldFRpbWVvdXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQVVBOztBQUNBOztBQUNBOztBQUVBOztBQUVBOztBQUVBOztBQUNBOztBQUNBOzs7Ozs7QUFwQkE7Ozs7Ozs7OztBQTRCQSxNQUFNQSxLQUFLLEdBQUcsb0JBQWEsWUFBYixDQUFkO0FBQ0EsSUFBSUMsS0FBSyxHQUFHLENBQVo7O0FBRUEsZUFBZUMsVUFBZixDQUNFQyxPQURGLEVBRUVDLFVBRkYsRUFHRUMsSUFIRixFQUlFQyxHQUpGLEVBSStCO0FBQzdCLFFBQU1DLEdBQUcsR0FBR0YsSUFBSSxDQUFDRSxHQUFqQjtBQUNBLFFBQU1DLE9BQU8sR0FBR0gsSUFBSSxDQUFDRyxPQUFyQjtBQUVBLE1BQUlDLE1BQUo7O0FBQ0EsTUFBSSxDQUFDSCxHQUFMLEVBQVU7QUFDUixVQUFNLENBQUNJLE9BQUQsRUFBVUMsSUFBVixJQUFrQixNQUFNUCxVQUFVLENBQUNRLFVBQVgsQ0FBc0JULE9BQXRCLENBQTlCO0FBQ0FNLElBQUFBLE1BQU0sR0FBR0ksYUFBUUMsTUFBUixDQUFlWCxPQUFmLEVBQXdCUSxJQUF4QixFQUE4QkQsT0FBOUIsQ0FBVDtBQUNELEdBSEQsTUFHTztBQUNMRCxJQUFBQSxNQUFNLEdBQUdJLGFBQVFDLE1BQVIsQ0FBZVgsT0FBZixFQUF3QkcsR0FBeEIsQ0FBVDtBQUNEOztBQUNERyxFQUFBQSxNQUFNLENBQUNMLFVBQVAsR0FBb0JBLFVBQXBCO0FBQ0EsTUFBSVcsR0FBYSxHQUFHLEVBQXBCOztBQUNBLE1BQUlWLElBQUksQ0FBQ1csSUFBVCxFQUFlO0FBQ2JELElBQUFBLEdBQUcsR0FBR1YsSUFBSSxDQUFDVyxJQUFMLENBQVVDLEdBQVYsQ0FBY0QsSUFBSSxJQUFJUCxNQUFNLENBQUNTLEtBQVAsQ0FBYUYsSUFBYixDQUF0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LE1BQUFBLEtBQUssSUFBSSxDQUFUOztBQUNBLFVBQUlBLEtBQUssR0FBRyxDQUFaLEVBQWU7QUFDYnlGLFFBQUFBLE9BQU8sR0FBR1MsVUFBVSxDQUFDRCxJQUFELEVBQU8sOEJBQVAsQ0FBcEI7QUFDRCxPQUZELE1BRU87QUFDTFgsUUFBQUEsS0FBSztBQUNOO0FBQ0YsS0FQRDs7QUFTQSxRQUFJRyxPQUFPLEdBQUdTLFVBQVUsQ0FBQ0QsSUFBRCxFQUFPLDhCQUFQLENBQXhCO0FBQ0QsR0ExQ2dCO0FBWHNDLENBQXpEO2VBd0RlckIsVyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChjKSAyMDE5LiBOYXRhLUluZm9cbiAqIEBhdXRob3IgQW5kcmVpIFNhcmFrZWV2IDxhdnNAbmF0YS1pbmZvLnJ1PlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBcIkBuYXRhXCIgcHJvamVjdC5cbiAqIEZvciB0aGUgZnVsbCBjb3B5cmlnaHQgYW5kIGxpY2Vuc2UgaW5mb3JtYXRpb24sIHBsZWFzZSB2aWV3XG4gKiB0aGUgRVVMQSBmaWxlIHRoYXQgd2FzIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyBzb3VyY2UgY29kZS5cbiAqL1xuXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IFRhYmxlLCB7IEhvcml6b250YWxUYWJsZSB9IGZyb20gJ2NsaS10YWJsZTMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEFyZ3VtZW50cywgQ29tbWFuZE1vZHVsZSB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCBkZWJ1Z0ZhY3RvcnkgZnJvbSAnZGVidWcnO1xuXG5pbXBvcnQgc2Vzc2lvbiwgeyBBZGRyZXNzIH0gZnJvbSAnQG5hdGEvbmlidXMuanMtY2xpZW50JztcbmltcG9ydCB7IENvbW1vbk9wdHMgfSBmcm9tICcuLi9vcHRpb25zJztcbmltcG9ydCB7IGRldmljZXMsIGdldE1pYlByb3RvdHlwZSwgSURldmljZSB9IGZyb20gJ0BuYXRhL25pYnVzLmpzLWNsaWVudC9saWIvbWliJztcbmltcG9ydCB7IGdldE5pYnVzVGltZW91dCwgTmlidXNDb25uZWN0aW9uIH0gZnJvbSAnQG5hdGEvbmlidXMuanMtY2xpZW50L2xpYi9uaWJ1cyc7XG5pbXBvcnQgeyBTYXJwUXVlcnlUeXBlIH0gZnJvbSAnQG5hdGEvbmlidXMuanMtY2xpZW50L2xpYi9zYXJwJztcblxudHlwZSBSb3dUeXBlID0ge1xuICBkaXNwbGF5TmFtZTogc3RyaW5nLFxuICB2YWx1ZTogYW55LFxuICBrZXk6IHN0cmluZyxcbn07XG5cbmNvbnN0IGRlYnVnID0gZGVidWdGYWN0b3J5KCduaWJ1czpkdW1wJyk7XG5sZXQgY291bnQgPSAwO1xuXG5hc3luYyBmdW5jdGlvbiBkdW1wRGV2aWNlKFxuICBhZGRyZXNzOiBBZGRyZXNzLFxuICBjb25uZWN0aW9uOiBOaWJ1c0Nvbm5lY3Rpb24sXG4gIGFyZ3Y6IEFyZ3VtZW50czxEdW1wT3B0cz4sXG4gIG1pYj86IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCByYXcgPSBhcmd2LnJhdztcbiAgY29uc3QgY29tcGFjdCA9IGFyZ3YuY29tcGFjdDtcblxuICBsZXQgZGV2aWNlOiBJRGV2aWNlO1xuICBpZiAoIW1pYikge1xuICAgIGNvbnN0IFt2ZXJzaW9uLCB0eXBlXSA9IGF3YWl0IGNvbm5lY3Rpb24uZ2V0VmVyc2lvbihhZGRyZXNzKTtcbiAgICBkZXZpY2UgPSBkZXZpY2VzLmNyZWF0ZShhZGRyZXNzLCB0eXBlLCB2ZXJzaW9uKTtcbiAgfSBlbHNlIHtcbiAgICBkZXZpY2UgPSBkZXZpY2VzLmNyZWF0ZShhZGRyZXNzLCBtaWIpO1xuICB9XG4gIGRldmljZS5jb25uZWN0aW9uID0gY29ubmVjdGlvbjtcbiAgbGV0IGlkczogbnVtYmVyW10gPSBbXTtcbiAgaWYgKGFyZ3YubmFtZSkge1xuICAgIGlkcyA9IGFyZ3YubmFtZS5tYXAobmFtZSA9PiBkZXZpY2UuZ2V0SWQobmFtZSkpO1xuICB9XG4gIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgZGV2aWNlLnJlYWQoLi4uaWRzKTtcbiAgY29uc3Qgcm93czogUm93VHlwZVtdID0gT2JqZWN0LmtleXMocmVzdWx0KVxuICAgIC5tYXAoKGtleSkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSByYXcgPyBkZXZpY2UuZ2V0RXJyb3Ioa2V5KSB8fCBkZXZpY2UuZ2V0UmF3VmFsdWUoa2V5KSA6IHJlc3VsdFtrZXldO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsdWUsXG4gICAgICAgIGtleSxcbiAgICAgICAgZGlzcGxheU5hbWU6IFJlZmxlY3QuZ2V0TWV0YWRhdGEoJ2Rpc3BsYXlOYW1lJywgZGV2aWNlLCBrZXkpLFxuICAgICAgfTtcbiAgICB9KTtcbiAgY29uc3QgcHJvdG8gPSBSZWZsZWN0LmdldFByb3RvdHlwZU9mKGRldmljZSk7XG4gIGRldmljZS5yZWxlYXNlKCk7XG4gIGNvbnN0IGNhdGVnb3JpZXMgPSBfLmdyb3VwQnkoXG4gICAgcm93cyxcbiAgICAoeyBrZXkgfSkgPT4gUmVmbGVjdC5nZXRNZXRhZGF0YSgnY2F0ZWdvcnknLCBwcm90bywga2V5KSB8fCAnJyxcbiAgKTtcbiAgY29uc29sZS5pbmZvKGAg0KPRgdGC0YDQvtC50YHRgtCy0L4gJHtSZWZsZWN0LmdldE1ldGFkYXRhKCdtaWInLCBwcm90byl9IFske2FkZHJlc3MudG9TdHJpbmcoKX1dYCk7XG4gIGNvbnN0IHRhYmxlID0gbmV3IFRhYmxlKHtcbiAgICBoZWFkOiBbJ9Cd0LDQt9Cy0LDQvdC40LUnLCAn0JfQvdCw0YfQtdC90LjQtScsICfQmNC80Y8nXSxcbiAgICBzdHlsZTogeyBjb21wYWN0IH0sXG4gICAgd29yZFdyYXA6IHRydWUsXG4gIH0pIGFzIEhvcml6b250YWxUYWJsZTtcbiAgY29uc3QgdG9Sb3cgPSAoeyBkaXNwbGF5TmFtZSwgdmFsdWUsIGtleSB9OiBSb3dUeXBlKSA9PiB7XG4gICAgbGV0IHZhbDtcbiAgICBpZiAodmFsdWUgJiYgdmFsdWUuZXJyb3IpIHtcbiAgICAgIHZhbCA9IGNoYWxrLnJlZCh2YWx1ZS5lcnJvcik7XG4gICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB2YWx1ZS5lcnJjb2RlKSB7XG4gICAgICB2YWwgPSBjaGFsay5yZWQoYGVycmNvZGU6ICR7dmFsdWUuZXJyY29kZX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFsID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xuICAgICAgaWYgKCFSZWZsZWN0LmdldE1ldGFkYXRhKCdpc1dyaXRhYmxlJywgcHJvdG8sIGtleSkpIHtcbiAgICAgICAgdmFsID0gY2hhbGsuZ3JleSh2YWwpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gW2Rpc3BsYXlOYW1lLCB2YWwsIGtleV07XG4gIH07XG4gIE9iamVjdC5rZXlzKGNhdGVnb3JpZXMpLmZvckVhY2goKGNhdGVnb3J5KSA9PiB7XG4gICAgY29uc3Qgcm93cyA9IGNhdGVnb3JpZXNbY2F0ZWdvcnldIGFzIFJvd1R5cGVbXTtcbiAgICBpZiAoY2F0ZWdvcnkpIHtcbiAgICAgIHRhYmxlLnB1c2goW3tcbiAgICAgICAgY29sU3BhbjogMyxcbiAgICAgICAgY29udGVudDogY2hhbGsueWVsbG93KGNhdGVnb3J5LnRvVXBwZXJDYXNlKCkpLFxuICAgICAgfV0pO1xuICAgIH1cbiAgICB0YWJsZS5wdXNoKC4uLnJvd3MubWFwKHRvUm93KSk7XG4gIH0pO1xuICBjb25zb2xlLmluZm8odGFibGUudG9TdHJpbmcoKSk7XG59XG5cbmZ1bmN0aW9uIGZpbmREZXZpY2VzKG1pYjogc3RyaW5nLCBjb25uZWN0aW9uOiBOaWJ1c0Nvbm5lY3Rpb24sIGFyZ3Y6IEFyZ3VtZW50czxEdW1wT3B0cz4pIHtcbiAgY291bnQgKz0gMTtcbiAgY29uc3QgcHJvdG8gPSBnZXRNaWJQcm90b3R5cGUobWliKTtcbiAgY29uc3QgdHlwZSA9IFJlZmxlY3QuZ2V0TWV0YWRhdGEoJ2RldmljZVR5cGUnLCBwcm90bykgYXMgbnVtYmVyO1xuICBjb25uZWN0aW9uLmZpbmRCeVR5cGUodHlwZSkuY2F0Y2goZSA9PiBkZWJ1ZygnZXJyb3Igd2hpbGUgZmluZEJ5VHlwZScsIGUuc3RhY2spKTtcbiAgY29ubmVjdGlvbi5vbignc2FycCcsIChkYXRhZ3JhbSkgPT4ge1xuICAgIGNvdW50ICs9IDE7XG4gICAgaWYgKGRhdGFncmFtLnF1ZXJ5VHlwZSAhPT0gU2FycFF1ZXJ5VHlwZS5CeVR5cGUpIHJldHVybjtcbiAgICBjb25zdCByZXNwb25zZVR5cGUgPSBkYXRhZ3JhbS5xdWVyeVBhcmFtLnJlYWRVSW50MTZCRSgzKTtcbiAgICAvLyBjb25zdCBpdGVtID0gdHlwZXMuZmluZCgoeyB0eXBlIH0pID0+IHJlc3BvbnNlVHlwZSA9PT0gdHlwZSk7XG4gICAgaWYgKHJlc3BvbnNlVHlwZSAhPT0gdHlwZSkgcmV0dXJuO1xuICAgIGNvbnN0IGFkZHJlc3MgPSBuZXcgQWRkcmVzcyhkYXRhZ3JhbS5tYWMpO1xuICAgIGR1bXBEZXZpY2UoYWRkcmVzcywgY29ubmVjdGlvbiwgYXJndiwgbWliKS5jYXRjaChcbiAgICAgIC8vICgpID0+IHt9LFxuICAgICAgZSA9PiBjb25zb2xlLmVycm9yKCdlcnJvciB3aGlsZSBkdW1wOicsIGUubWVzc2FnZSksXG4gICAgKTtcbiAgfSk7XG59XG5cbnR5cGUgRHVtcE9wdHMgPSBDb21tb25PcHRzO1xuXG5jb25zdCBkdW1wQ29tbWFuZDogQ29tbWFuZE1vZHVsZTxDb21tb25PcHRzLCBEdW1wT3B0cz4gPSB7XG4gIGNvbW1hbmQ6ICdkdW1wJyxcbiAgZGVzY3JpYmU6ICfQktGL0LTQsNGC0Ywg0LTQsNC80L/RiyDRg9GB0YLRgNC+0LnRgdGC0LInLFxuICBidWlsZGVyOiBhcmd2ID0+IGFyZ3ZcbiAgICAuY2hlY2soKGFyZ3YpID0+IHtcbiAgICAgIGlmIChhcmd2LmlkICYmICghYXJndi5tYWMgJiYgIWFyZ3YubWliKSkge1xuICAgICAgICB0aHJvdyBg0JTQsNC90L3Ri9C5INCw0YDQs9GD0LzQtdC90YIg0YLRgNC10LHRg9C10YIg0YHQu9C10LTRg9GO0YnQuNC5INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdGL0Lkg0LDRgNCz0YPQvNC10L3RgjpcbiBpZCAtPiBtaWIg0LjQu9C4IGlkIC0+IG1hY2A7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KSxcbiAgaGFuZGxlcjogYXJndiA9PiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgY2xvc2UgPSAoZXJyPzogc3RyaW5nKSA9PiB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICBzZXNzaW9uLmNsb3NlKCk7XG4gICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTsgZWxzZSByZXNvbHZlKCk7XG4gICAgfTtcbiAgICBjb25zdCBtYWMgPSBhcmd2Lm1hYyAmJiBuZXcgQWRkcmVzcyhhcmd2Lm1hYyk7XG4gICAgY291bnQgPSBhd2FpdCBzZXNzaW9uLnN0YXJ0KCk7XG4gICAgc2Vzc2lvbi5vbignZm91bmQnLCBhc3luYyAoeyBhZGRyZXNzLCBjb25uZWN0aW9uIH0pID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGlmIChjb25uZWN0aW9uLmRlc2NyaXB0aW9uLmxpbmspIHtcbiAgICAgICAgICBpZiAobWFjKSB7XG4gICAgICAgICAgICBjb3VudCArPSAxO1xuICAgICAgICAgICAgYXdhaXQgZHVtcERldmljZShtYWMsIGNvbm5lY3Rpb24sIGFyZ3YpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoYXJndi5taWIpIHtcbiAgICAgICAgICAgIGZpbmREZXZpY2VzKGFyZ3YubWliISwgY29ubmVjdGlvbiwgYXJndik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICgoIW1hYyB8fCBtYWMuZXF1YWxzKGFkZHJlc3MpKVxuICAgICAgICAgICYmICghYXJndi5taWIgfHwgYXJndi5taWIgPT09IGNvbm5lY3Rpb24uZGVzY3JpcHRpb24ubWliKSkge1xuICAgICAgICAgIGF3YWl0IGR1bXBEZXZpY2UoYWRkcmVzcywgY29ubmVjdGlvbiwgYXJndiwgY29ubmVjdGlvbi5kZXNjcmlwdGlvbi5taWIpO1xuICAgICAgICB9XG4gICAgICAgIGNvdW50IC09IDE7XG4gICAgICAgIGlmIChjb3VudCA9PT0gMCkge1xuICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICAgICAgICBwcm9jZXNzLm5leHRUaWNrKGNsb3NlKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjbG9zZShlLm1lc3NhZ2UgfHwgZSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB3YWl0ID0gKCkgPT4ge1xuICAgICAgY291bnQgLT0gMTtcbiAgICAgIGlmIChjb3VudCA+IDApIHtcbiAgICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQod2FpdCwgZ2V0TmlidXNUaW1lb3V0KCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xvc2UoKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgbGV0IHRpbWVvdXQgPSBzZXRUaW1lb3V0KHdhaXQsIGdldE5pYnVzVGltZW91dCgpKTtcbiAgfSksXG59O1xuXG5leHBvcnQgZGVmYXVsdCBkdW1wQ29tbWFuZDtcbiJdfQ==