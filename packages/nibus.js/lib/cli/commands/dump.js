"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _chalk = _interopRequireDefault(require("chalk"));

var _cliTable = _interopRequireDefault(require("cli-table3"));

var _lodash = _interopRequireDefault(require("lodash"));

var _debug = _interopRequireDefault(require("debug"));

var _nibus = _interopRequireWildcard(require("@nata/nibus.js-client"));

var _mib = require("@nata/nibus.js-client/lib/mib");

var _nibus2 = require("@nata/nibus.js-client/lib/nibus");

var _sarp = require("@nata/nibus.js-client/lib/sarp");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * @license
 * Copyright (c) 2019. Nata-Info
 * @author Andrei Sarakeev <avs@nata-info.ru>
 *
 * This file is part of the "@nata" project.
 * For the full copyright and license information, please view
 * the EULA file that was distributed with this source code.
 */
const debug = (0, _debug.default)('nibus:dump');
let count = 0;

async function dumpDevice(address, connection, argv, mib) {
  const raw = argv.raw;
  const compact = argv.compact;
  let device;

  if (!mib) {
    const [version, type] = await connection.getVersion(address);
    device = _mib.devices.create(address, type, version);
  } else {
    device = _mib.devices.create(address, mib);
  }

  device.connection = connection;
  let ids = [];

  if (argv.name) {
    ids = argv.name.map(name => device.getId(name));
  }

  const result = await device.read(...ids);
  const rows = Object.keys(result).map(key => {
    const value = raw ? device.getError(key) || device.getRawValue(key) : result[key];
    return {
      value,
      key,
      displayName: Reflect.getMetadata('displayName', device, key)
    };
  });
  const proto = Reflect.getPrototypeOf(device);
  device.release();

  const categories = _lodash.default.groupBy(rows, ({
    key
  }) => Reflect.getMetadata('category', proto, key) || '');

  console.info(` Устройство ${Reflect.getMetadata('mib', proto)} [${address.toString()}]`);
  const table = new _cliTable.default({
    head: ['Название', 'Значение', 'Имя'],
    style: {
      compact
    },
    wordWrap: true
  });

  const toRow = ({
    displayName,
    value,
    key
  }) => {
    let val;

    if (value && value.error) {
      val = _chalk.default.red(value.error);
    } else if (value && value.errcode) {
      val = _chalk.default.red(`errcode: ${value.errcode}`);
    } else {
      val = JSON.stringify(value);

      if (!Reflect.getMetadata('isWritable', proto, key)) {
        val = _chalk.default.grey(val);
      }
    }

    return [displayName, val, key];
  };

  Object.keys(categories).forEach(category => {
    const rows = categories[category];

    if (category) {
      table.push([{
        colSpan: 3,
        content: _chalk.default.yellow(category.toUpperCase())
      }]);
    }

    table.push(...rows.map(toRow));
  });
  console.info(table.toString());
}

function findDevices(mib, connection, argv) {
  count += 1;
  const proto = (0, _mib.getMibPrototype)(mib);
  const type = Reflect.getMetadata('deviceType', proto);
  connection.findByType(type).catch(e => debug('error while findByType', e.stack));
  connection.on('sarp', datagram => {
    count += 1;
    if (datagram.queryType !== _sarp.SarpQueryType.ByType) return;
    const responseType = datagram.queryParam.readUInt16BE(3); // const item = types.find(({ type }) => responseType === type);

    if (responseType !== type) return;
    const address = new _nibus.Address(datagram.mac);
    dumpDevice(address, connection, argv, mib).catch( // () => {},
    e => console.error('error while dump:', e.message));
  });
}

const dumpCommand = {
  command: 'dump',
  describe: 'Выдать дампы устройств',
  builder: argv => argv.check(argv => {
    if (argv.id && !argv.mac && !argv.mib) {
      throw `Данный аргумент требует следующий дополнительный аргумент:
 id -> mib или id -> mac`;
    }

    return true;
  }),
  handler: argv => new Promise(async (resolve, reject) => {
    const close = err => {
      clearTimeout(timeout);

      _nibus.default.close();

      if (err) reject(err);else resolve();
    };

    const mac = argv.mac && new _nibus.Address(argv.mac);
    count = await _nibus.default.start(); // На Windows сложнее метод определения и занимает больше времени

    if (process.platform === 'win32') {
      count *= 2;
    }

    _nibus.default.on('found', async ({
      address,
      connection
    }) => {
      try {
        if (connection.description.link) {
          if (mac) {
            count += 1;
            await dumpDevice(mac, connection, argv);
          } else if (argv.mib) {
            findDevices(argv.mib, connection, argv);
          }
        }

        if ((!mac || mac.equals(address)) && (!argv.mib || argv.mib === connection.description.mib)) {
          await dumpDevice(address, connection, argv, connection.description.mib);
        }

        count -= 1;

        if (count === 0) {
          clearTimeout(timeout);
          process.nextTick(close);
        }
      } catch (e) {
        close(e.message || e);
      }
    });

    const wait = () => {
      count -= 1;

      if (count > 0) {
        timeout = setTimeout(wait, (0, _nibus2.getNibusTimeout)());
      } else {
        close();
      }
    };

    let timeout = setTimeout(wait, (0, _nibus2.getNibusTimeout)());
  })
};
var _default = dumpCommand;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGkvY29tbWFuZHMvZHVtcC50cyJdLCJuYW1lcyI6WyJkZWJ1ZyIsImNvdW50IiwiZHVtcERldmljZSIsImFkZHJlc3MiLCJjb25uZWN0aW9uIiwiYXJndiIsIm1pYiIsInJhdyIsImNvbXBhY3QiLCJkZXZpY2UiLCJ2ZXJzaW9uIiwidHlwZSIsImdldFZlcnNpb24iLCJkZXZpY2VzIiwiY3JlYXRlIiwiaWRzIiwibmFtZSIsIm1hcCIsImdldElkIiwicmVzdWx0IiwicmVhZCIsInJvd3MiLCJPYmplY3QiLCJrZXlzIiwia2V5IiwidmFsdWUiLCJnZXRFcnJvciIsImdldFJhd1ZhbHVlIiwiZGlzcGxheU5hbWUiLCJSZWZsZWN0IiwiZ2V0TWV0YWRhdGEiLCJwcm90byIsImdldFByb3RvdHlwZU9mIiwicmVsZWFzZSIsImNhdGVnb3JpZXMiLCJfIiwiZ3JvdXBCeSIsImNvbnNvbGUiLCJpbmZvIiwidG9TdHJpbmciLCJ0YWJsZSIsIlRhYmxlIiwiaGVhZCIsInN0eWxlIiwid29yZFdyYXAiLCJ0b1JvdyIsInZhbCIsImVycm9yIiwiY2hhbGsiLCJyZWQiLCJlcnJjb2RlIiwiSlNPTiIsInN0cmluZ2lmeSIsImdyZXkiLCJmb3JFYWNoIiwiY2F0ZWdvcnkiLCJwdXNoIiwiY29sU3BhbiIsImNvbnRlbnQiLCJ5ZWxsb3ciLCJ0b1VwcGVyQ2FzZSIsImZpbmREZXZpY2VzIiwiZmluZEJ5VHlwZSIsImNhdGNoIiwiZSIsInN0YWNrIiwib24iLCJkYXRhZ3JhbSIsInF1ZXJ5VHlwZSIsIlNhcnBRdWVyeVR5cGUiLCJCeVR5cGUiLCJyZXNwb25zZVR5cGUiLCJxdWVyeVBhcmFtIiwicmVhZFVJbnQxNkJFIiwiQWRkcmVzcyIsIm1hYyIsIm1lc3NhZ2UiLCJkdW1wQ29tbWFuZCIsImNvbW1hbmQiLCJkZXNjcmliZSIsImJ1aWxkZXIiLCJjaGVjayIsImlkIiwiaGFuZGxlciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiY2xvc2UiLCJlcnIiLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0Iiwic2Vzc2lvbiIsInN0YXJ0IiwicHJvY2VzcyIsInBsYXRmb3JtIiwiZGVzY3JpcHRpb24iLCJsaW5rIiwiZXF1YWxzIiwibmV4dFRpY2siLCJ3YWl0Iiwic2V0VGltZW91dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBVUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBRUE7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7OztBQXBCQTs7Ozs7Ozs7O0FBNEJBLE1BQU1BLEtBQUssR0FBRyxvQkFBYSxZQUFiLENBQWQ7QUFDQSxJQUFJQyxLQUFLLEdBQUcsQ0FBWjs7QUFFQSxlQUFlQyxVQUFmLENBQ0VDLE9BREYsRUFFRUMsVUFGRixFQUdFQyxJQUhGLEVBSUVDLEdBSkYsRUFJK0I7QUFDN0IsUUFBTUMsR0FBRyxHQUFHRixJQUFJLENBQUNFLEdBQWpCO0FBQ0EsUUFBTUMsT0FBTyxHQUFHSCxJQUFJLENBQUNHLE9BQXJCO0FBRUEsTUFBSUMsTUFBSjs7QUFDQSxNQUFJLENBQUNILEdBQUwsRUFBVTtBQUNSLFVBQU0sQ0FBQ0ksT0FBRCxFQUFVQyxJQUFWLElBQWtCLE1BQU1QLFVBQVUsQ0FBQ1EsVUFBWCxDQUFzQlQsT0FBdEIsQ0FBOUI7QUFDQU0sSUFBQUEsTUFBTSxHQUFHSSxhQUFRQyxNQUFSLENBQWVYLE9BQWYsRUFBd0JRLElBQXhCLEVBQStCRCxPQUEvQixDQUFUO0FBQ0QsR0FIRCxNQUdPO0FBQ0xELElBQUFBLE1BQU0sR0FBR0ksYUFBUUMsTUFBUixDQUFlWCxPQUFmLEVBQXdCRyxHQUF4QixDQUFUO0FBQ0Q7O0FBQ0RHLEVBQUFBLE1BQU0sQ0FBQ0wsVUFBUCxHQUFvQkEsVUFBcEI7QUFDQSxNQUFJVyxHQUFhLEdBQUcsRUFBcEI7O0FBQ0EsTUFBSVYsSUFBSSxDQUFDVyxJQUFULEVBQWU7QUFDYkQsSUFBQUEsR0FBRyxHQUFHVixJQUFJLENBQUNXLElBQUwsQ0FBVUMsR0FBVixDQUFjRCxJQUFJLElBQUlQLE1BQU0sQ0FBQ1MsS0FBUCxDQUFh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QixRQUFBQSxLQUFLLENBQUN2QixDQUFDLENBQUNZLE9BQUYsSUFBYVosQ0FBZCxDQUFMO0FBQ0Q7QUFDRixLQXRCRDs7QUF3QkEsVUFBTW1DLElBQUksR0FBRyxNQUFNO0FBQ2pCbEcsTUFBQUEsS0FBSyxJQUFJLENBQVQ7O0FBQ0EsVUFBSUEsS0FBSyxHQUFHLENBQVosRUFBZTtBQUNieUYsUUFBQUEsT0FBTyxHQUFHVSxVQUFVLENBQUNELElBQUQsRUFBTyw4QkFBUCxDQUFwQjtBQUNELE9BRkQsTUFFTztBQUNMWixRQUFBQSxLQUFLO0FBQ047QUFDRixLQVBEOztBQVNBLFFBQUlHLE9BQU8sR0FBR1UsVUFBVSxDQUFDRCxJQUFELEVBQU8sOEJBQVAsQ0FBeEI7QUFDRCxHQTlDZ0I7QUFYc0MsQ0FBekQ7ZUE0RGV0QixXIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkuIE5hdGEtSW5mb1xuICogQGF1dGhvciBBbmRyZWkgU2FyYWtlZXYgPGF2c0BuYXRhLWluZm8ucnU+XG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIFwiQG5hdGFcIiBwcm9qZWN0LlxuICogRm9yIHRoZSBmdWxsIGNvcHlyaWdodCBhbmQgbGljZW5zZSBpbmZvcm1hdGlvbiwgcGxlYXNlIHZpZXdcbiAqIHRoZSBFVUxBIGZpbGUgdGhhdCB3YXMgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHNvdXJjZSBjb2RlLlxuICovXG5cbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgVGFibGUsIHsgSG9yaXpvbnRhbFRhYmxlIH0gZnJvbSAnY2xpLXRhYmxlMyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgQXJndW1lbnRzLCBDb21tYW5kTW9kdWxlIH0gZnJvbSAneWFyZ3MnO1xuaW1wb3J0IGRlYnVnRmFjdG9yeSBmcm9tICdkZWJ1Zyc7XG5cbmltcG9ydCBzZXNzaW9uLCB7IEFkZHJlc3MgfSBmcm9tICdAbmF0YS9uaWJ1cy5qcy1jbGllbnQnO1xuaW1wb3J0IHsgQ29tbW9uT3B0cyB9IGZyb20gJy4uL29wdGlvbnMnO1xuaW1wb3J0IHsgZGV2aWNlcywgZ2V0TWliUHJvdG90eXBlLCBJRGV2aWNlIH0gZnJvbSAnQG5hdGEvbmlidXMuanMtY2xpZW50L2xpYi9taWInO1xuaW1wb3J0IHsgZ2V0TmlidXNUaW1lb3V0LCBOaWJ1c0Nvbm5lY3Rpb24gfSBmcm9tICdAbmF0YS9uaWJ1cy5qcy1jbGllbnQvbGliL25pYnVzJztcbmltcG9ydCB7IFNhcnBRdWVyeVR5cGUgfSBmcm9tICdAbmF0YS9uaWJ1cy5qcy1jbGllbnQvbGliL3NhcnAnO1xuXG50eXBlIFJvd1R5cGUgPSB7XG4gIGRpc3BsYXlOYW1lOiBzdHJpbmcsXG4gIHZhbHVlOiBhbnksXG4gIGtleTogc3RyaW5nLFxufTtcblxuY29uc3QgZGVidWcgPSBkZWJ1Z0ZhY3RvcnkoJ25pYnVzOmR1bXAnKTtcbmxldCBjb3VudCA9IDA7XG5cbmFzeW5jIGZ1bmN0aW9uIGR1bXBEZXZpY2UoXG4gIGFkZHJlc3M6IEFkZHJlc3MsXG4gIGNvbm5lY3Rpb246IE5pYnVzQ29ubmVjdGlvbixcbiAgYXJndjogQXJndW1lbnRzPER1bXBPcHRzPixcbiAgbWliPzogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHJhdyA9IGFyZ3YucmF3O1xuICBjb25zdCBjb21wYWN0ID0gYXJndi5jb21wYWN0O1xuXG4gIGxldCBkZXZpY2U6IElEZXZpY2U7XG4gIGlmICghbWliKSB7XG4gICAgY29uc3QgW3ZlcnNpb24sIHR5cGVdID0gYXdhaXQgY29ubmVjdGlvbi5nZXRWZXJzaW9uKGFkZHJlc3MpO1xuICAgIGRldmljZSA9IGRldmljZXMuY3JlYXRlKGFkZHJlc3MsIHR5cGUhLCB2ZXJzaW9uKTtcbiAgfSBlbHNlIHtcbiAgICBkZXZpY2UgPSBkZXZpY2VzLmNyZWF0ZShhZGRyZXNzLCBtaWIpO1xuICB9XG4gIGRldmljZS5jb25uZWN0aW9uID0gY29ubmVjdGlvbjtcbiAgbGV0IGlkczogbnVtYmVyW10gPSBbXTtcbiAgaWYgKGFyZ3YubmFtZSkge1xuICAgIGlkcyA9IGFyZ3YubmFtZS5tYXAobmFtZSA9PiBkZXZpY2UuZ2V0SWQobmFtZSkpO1xuICB9XG4gIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgZGV2aWNlLnJlYWQoLi4uaWRzKTtcbiAgY29uc3Qgcm93czogUm93VHlwZVtdID0gT2JqZWN0LmtleXMocmVzdWx0KVxuICAgIC5tYXAoKGtleSkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSByYXcgPyBkZXZpY2UuZ2V0RXJyb3Ioa2V5KSB8fCBkZXZpY2UuZ2V0UmF3VmFsdWUoa2V5KSA6IHJlc3VsdFtrZXldO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmFsdWUsXG4gICAgICAgIGtleSxcbiAgICAgICAgZGlzcGxheU5hbWU6IFJlZmxlY3QuZ2V0TWV0YWRhdGEoJ2Rpc3BsYXlOYW1lJywgZGV2aWNlLCBrZXkpLFxuICAgICAgfTtcbiAgICB9KTtcbiAgY29uc3QgcHJvdG8gPSBSZWZsZWN0LmdldFByb3RvdHlwZU9mKGRldmljZSk7XG4gIGRldmljZS5yZWxlYXNlKCk7XG4gIGNvbnN0IGNhdGVnb3JpZXMgPSBfLmdyb3VwQnkoXG4gICAgcm93cyxcbiAgICAoeyBrZXkgfSkgPT4gUmVmbGVjdC5nZXRNZXRhZGF0YSgnY2F0ZWdvcnknLCBwcm90bywga2V5KSB8fCAnJyxcbiAgKTtcbiAgY29uc29sZS5pbmZvKGAg0KPRgdGC0YDQvtC50YHRgtCy0L4gJHtSZWZsZWN0LmdldE1ldGFkYXRhKCdtaWInLCBwcm90byl9IFske2FkZHJlc3MudG9TdHJpbmcoKX1dYCk7XG4gIGNvbnN0IHRhYmxlID0gbmV3IFRhYmxlKHtcbiAgICBoZWFkOiBbJ9Cd0LDQt9Cy0LDQvdC40LUnLCAn0JfQvdCw0YfQtdC90LjQtScsICfQmNC80Y8nXSxcbiAgICBzdHlsZTogeyBjb21wYWN0IH0sXG4gICAgd29yZFdyYXA6IHRydWUsXG4gIH0pIGFzIEhvcml6b250YWxUYWJsZTtcbiAgY29uc3QgdG9Sb3cgPSAoeyBkaXNwbGF5TmFtZSwgdmFsdWUsIGtleSB9OiBSb3dUeXBlKSA9PiB7XG4gICAgbGV0IHZhbDtcbiAgICBpZiAodmFsdWUgJiYgdmFsdWUuZXJyb3IpIHtcbiAgICAgIHZhbCA9IGNoYWxrLnJlZCh2YWx1ZS5lcnJvcik7XG4gICAgfSBlbHNlIGlmICh2YWx1ZSAmJiB2YWx1ZS5lcnJjb2RlKSB7XG4gICAgICB2YWwgPSBjaGFsay5yZWQoYGVycmNvZGU6ICR7dmFsdWUuZXJyY29kZX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFsID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xuICAgICAgaWYgKCFSZWZsZWN0LmdldE1ldGFkYXRhKCdpc1dyaXRhYmxlJywgcHJvdG8sIGtleSkpIHtcbiAgICAgICAgdmFsID0gY2hhbGsuZ3JleSh2YWwpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gW2Rpc3BsYXlOYW1lLCB2YWwsIGtleV07XG4gIH07XG4gIE9iamVjdC5rZXlzKGNhdGVnb3JpZXMpLmZvckVhY2goKGNhdGVnb3J5KSA9PiB7XG4gICAgY29uc3Qgcm93cyA9IGNhdGVnb3JpZXNbY2F0ZWdvcnldIGFzIFJvd1R5cGVbXTtcbiAgICBpZiAoY2F0ZWdvcnkpIHtcbiAgICAgIHRhYmxlLnB1c2goW3tcbiAgICAgICAgY29sU3BhbjogMyxcbiAgICAgICAgY29udGVudDogY2hhbGsueWVsbG93KGNhdGVnb3J5LnRvVXBwZXJDYXNlKCkpLFxuICAgICAgfV0pO1xuICAgIH1cbiAgICB0YWJsZS5wdXNoKC4uLnJvd3MubWFwKHRvUm93KSk7XG4gIH0pO1xuICBjb25zb2xlLmluZm8odGFibGUudG9TdHJpbmcoKSk7XG59XG5cbmZ1bmN0aW9uIGZpbmREZXZpY2VzKG1pYjogc3RyaW5nLCBjb25uZWN0aW9uOiBOaWJ1c0Nvbm5lY3Rpb24sIGFyZ3Y6IEFyZ3VtZW50czxEdW1wT3B0cz4pIHtcbiAgY291bnQgKz0gMTtcbiAgY29uc3QgcHJvdG8gPSBnZXRNaWJQcm90b3R5cGUobWliKTtcbiAgY29uc3QgdHlwZSA9IFJlZmxlY3QuZ2V0TWV0YWRhdGEoJ2RldmljZVR5cGUnLCBwcm90bykgYXMgbnVtYmVyO1xuICBjb25uZWN0aW9uLmZpbmRCeVR5cGUodHlwZSkuY2F0Y2goZSA9PiBkZWJ1ZygnZXJyb3Igd2hpbGUgZmluZEJ5VHlwZScsIGUuc3RhY2spKTtcbiAgY29ubmVjdGlvbi5vbignc2FycCcsIChkYXRhZ3JhbSkgPT4ge1xuICAgIGNvdW50ICs9IDE7XG4gICAgaWYgKGRhdGFncmFtLnF1ZXJ5VHlwZSAhPT0gU2FycFF1ZXJ5VHlwZS5CeVR5cGUpIHJldHVybjtcbiAgICBjb25zdCByZXNwb25zZVR5cGUgPSBkYXRhZ3JhbS5xdWVyeVBhcmFtLnJlYWRVSW50MTZCRSgzKTtcbiAgICAvLyBjb25zdCBpdGVtID0gdHlwZXMuZmluZCgoeyB0eXBlIH0pID0+IHJlc3BvbnNlVHlwZSA9PT0gdHlwZSk7XG4gICAgaWYgKHJlc3BvbnNlVHlwZSAhPT0gdHlwZSkgcmV0dXJuO1xuICAgIGNvbnN0IGFkZHJlc3MgPSBuZXcgQWRkcmVzcyhkYXRhZ3JhbS5tYWMpO1xuICAgIGR1bXBEZXZpY2UoYWRkcmVzcywgY29ubmVjdGlvbiwgYXJndiwgbWliKS5jYXRjaChcbiAgICAgIC8vICgpID0+IHt9LFxuICAgICAgZSA9PiBjb25zb2xlLmVycm9yKCdlcnJvciB3aGlsZSBkdW1wOicsIGUubWVzc2FnZSksXG4gICAgKTtcbiAgfSk7XG59XG5cbnR5cGUgRHVtcE9wdHMgPSBDb21tb25PcHRzO1xuXG5jb25zdCBkdW1wQ29tbWFuZDogQ29tbWFuZE1vZHVsZTxDb21tb25PcHRzLCBEdW1wT3B0cz4gPSB7XG4gIGNvbW1hbmQ6ICdkdW1wJyxcbiAgZGVzY3JpYmU6ICfQktGL0LTQsNGC0Ywg0LTQsNC80L/RiyDRg9GB0YLRgNC+0LnRgdGC0LInLFxuICBidWlsZGVyOiBhcmd2ID0+IGFyZ3ZcbiAgICAuY2hlY2soKGFyZ3YpID0+IHtcbiAgICAgIGlmIChhcmd2LmlkICYmICghYXJndi5tYWMgJiYgIWFyZ3YubWliKSkge1xuICAgICAgICB0aHJvdyBg0JTQsNC90L3Ri9C5INCw0YDQs9GD0LzQtdC90YIg0YLRgNC10LHRg9C10YIg0YHQu9C10LTRg9GO0YnQuNC5INC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdGL0Lkg0LDRgNCz0YPQvNC10L3RgjpcbiBpZCAtPiBtaWIg0LjQu9C4IGlkIC0+IG1hY2A7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9KSxcbiAgaGFuZGxlcjogYXJndiA9PiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgY2xvc2UgPSAoZXJyPzogc3RyaW5nKSA9PiB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICBzZXNzaW9uLmNsb3NlKCk7XG4gICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTsgZWxzZSByZXNvbHZlKCk7XG4gICAgfTtcbiAgICBjb25zdCBtYWMgPSBhcmd2Lm1hYyAmJiBuZXcgQWRkcmVzcyhhcmd2Lm1hYyk7XG4gICAgY291bnQgPSBhd2FpdCBzZXNzaW9uLnN0YXJ0KCk7XG4gICAgLy8g0J3QsCBXaW5kb3dzINGB0LvQvtC20L3QtdC1INC80LXRgtC+0LQg0L7Qv9GA0LXQtNC10LvQtdC90LjRjyDQuCDQt9Cw0L3QuNC80LDQtdGCINCx0L7Qu9GM0YjQtSDQstGA0LXQvNC10L3QuFxuICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInKSB7XG4gICAgICBjb3VudCAqPSAyO1xuICAgIH1cbiAgICBzZXNzaW9uLm9uKCdmb3VuZCcsIGFzeW5jICh7IGFkZHJlc3MsIGNvbm5lY3Rpb24gfSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKGNvbm5lY3Rpb24uZGVzY3JpcHRpb24ubGluaykge1xuICAgICAgICAgIGlmIChtYWMpIHtcbiAgICAgICAgICAgIGNvdW50ICs9IDE7XG4gICAgICAgICAgICBhd2FpdCBkdW1wRGV2aWNlKG1hYywgY29ubmVjdGlvbiwgYXJndik7XG4gICAgICAgICAgfSBlbHNlIGlmIChhcmd2Lm1pYikge1xuICAgICAgICAgICAgZmluZERldmljZXMoYXJndi5taWIhLCBjb25uZWN0aW9uLCBhcmd2KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCghbWFjIHx8IG1hYy5lcXVhbHMoYWRkcmVzcykpXG4gICAgICAgICAgJiYgKCFhcmd2Lm1pYiB8fCBhcmd2Lm1pYiA9PT0gY29ubmVjdGlvbi5kZXNjcmlwdGlvbi5taWIpKSB7XG4gICAgICAgICAgYXdhaXQgZHVtcERldmljZShhZGRyZXNzLCBjb25uZWN0aW9uLCBhcmd2LCBjb25uZWN0aW9uLmRlc2NyaXB0aW9uLm1pYik7XG4gICAgICAgIH1cbiAgICAgICAgY291bnQgLT0gMTtcbiAgICAgICAgaWYgKGNvdW50ID09PSAwKSB7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVvdXQpO1xuICAgICAgICAgIHByb2Nlc3MubmV4dFRpY2soY2xvc2UpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNsb3NlKGUubWVzc2FnZSB8fCBlKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHdhaXQgPSAoKSA9PiB7XG4gICAgICBjb3VudCAtPSAxO1xuICAgICAgaWYgKGNvdW50ID4gMCkge1xuICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dCh3YWl0LCBnZXROaWJ1c1RpbWVvdXQoKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjbG9zZSgpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICBsZXQgdGltZW91dCA9IHNldFRpbWVvdXQod2FpdCwgZ2V0TmlidXNUaW1lb3V0KCkpO1xuICB9KSxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGR1bXBDb21tYW5kO1xuIl19