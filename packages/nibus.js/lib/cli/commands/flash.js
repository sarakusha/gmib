"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _crc = require("crc");

var _fs = _interopRequireDefault(require("fs"));

var _lodash = _interopRequireDefault(require("lodash"));

var _progress = _interopRequireDefault(require("progress"));

var _handlers = require("../handlers");

var _write = require("./write");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const domain = 'RFLASH';
const crcPrev = 0xAA55;

const ident = buf => buf;

const createHeader = (kind, option, data) => {
  const buffer = Buffer.alloc(20);
  buffer.write(kind.padEnd(4, '\0'));
  buffer.writeUInt32LE(data.length, 4);
  buffer.writeUInt32LE(Math.round(Date.now() / 1000), 8);
  buffer.writeUInt16LE(option, 16);
  buffer.writeUInt16LE((0, _crc.crc16ccitt)(buffer.slice(0, 18), crcPrev), 18);
  return buffer;
};

const hexToBuf = hex => Buffer.from(hex.split(/[\s:-=]/g).join(''), 'hex');

const txtConvert = buffer => {
  const lines = buffer.toString('ascii').split(/\r?\n/g);
  const result = Buffer.alloc(32768, 0xFF);
  const begin = 0x8000;
  let offset = 0;
  lines.forEach(line => {
    if (line[0] === '@') {
      offset = parseInt(line.slice(1), 16) - begin;
    } else {
      offset += hexToBuf(line).copy(result, offset);
    }
  });
  return result;
};

const decConvert = data => {
  const lines = data.toString().split(/\r?\n/g);

  const raw = _lodash.default.flatten(lines.map(line => line.trim()).filter(line => !!line).map(line => line.split(/\s+/g).map(b => {
    const i = parseInt(b, 10);
    if (Number.isNaN(i)) console.error('Invalid Number', b);
    return i;
  })));

  if (_lodash.default.some(raw, b => Number.isNaN(b))) throw new Error('Invalid number');
  return Buffer.from(_lodash.default.flatten(raw.map(word => [word & 0xFF, word >> 8 & 0xFF])));
};

const meta = {
  rbf: {
    offset: 0x60000,
    size: [368011],
    converter: ident
  },
  tca: {
    offset: 0xC0000,
    size: [1536, 2822],
    converter: decConvert
  },
  tcc: {
    offset: 0xC0000,
    size: [1536, 2822],
    converter: decConvert
  },
  ctrl: {
    offset: 0xF0000,
    size: [32768],
    converter: txtConvert
  }
};

async function action(device, args) {
  await (0, _write.action)(device, args);
  const opts = meta[args.kind];
  process.env['NODE_NO_WARNINGS'] = '1';
  let buffer = opts.converter((await _fs.default.promises.readFile(args.source)));

  if (!opts.size.includes(buffer.length)) {
    throw new Error(`Invalid data length. Expected ${opts.size.join(',')} got ${buffer.length}`);
  }

  if (args.kind !== 'ctrl') {
    const header = createHeader(args.kind, 0, buffer);
    buffer = Buffer.concat([header, buffer, header]);
  } else {
    const crc = Buffer.alloc(2);
    crc.writeUInt16LE((0, _crc.crc16ccitt)(buffer, crcPrev), 0);
    buffer = Buffer.concat([buffer, crc]);
  }

  const dest = opts.offset.toString(16).padStart(4, '0');
  const bar = new _progress.default(`  flashing [:bar] to ${dest} :rate/bps :percent :current/:total :etas`, {
    total: buffer.length,
    width: 30
  });
  device.on('downloadData', ({
    domain: downloadDomain,
    length
  }) => {
    if (domain === downloadDomain) bar.tick(length);
  });
  await device.download(domain, buffer, opts.offset);

  if (args.execute) {
    await device.execute(args.execute);
  }
}

const flashCommand = {
  command: 'flash',
  describe: 'прошивка минихоста3',
  builder: argv => argv.option('kind', {
    alias: 'k',
    choices: ['rbf', 'tca', 'tcc', 'ctrl']
  }) // .option('offset', {
  //   alias: 'ofs',
  //   default: 0,
  //   number: true,
  //   describe: 'смещение в домене',
  // })
  .option('source', {
    alias: 'src',
    string: true,
    describe: 'загрузить данные из файла'
  }).option('execute', {
    alias: 'exec',
    string: true,
    describe: 'выполнить программу после записи'
  }) // .option('hex', {
  //   boolean: true,
  //   describe: 'использовать шестнадцатиричный формат',
  // })
  // .option('dec', {
  //   boolean: true,
  //   describe: 'использовать десятичный двубайтный формат',
  // })
  // .conflicts('hex', 'dec')
  .example('flash', '$0 flash -m ::1 -k ctrl moduleSelect=0 --src Slim_Ctrl_v5_Mcu_v1.2.txt --exec update').demandOption(['mac', 'm', 'kind', 'source']),
  handler: (0, _handlers.makeAddressHandler)(action)
};
var _default = flashCommand;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jbGkvY29tbWFuZHMvZmxhc2gudHMiXSwibmFtZXMiOlsiZG9tYWluIiwiY3JjUHJldiIsImlkZW50IiwiYnVmIiwiY3JlYXRlSGVhZGVyIiwia2luZCIsIm9wdGlvbiIsImRhdGEiLCJidWZmZXIiLCJCdWZmZXIiLCJhbGxvYyIsIndyaXRlIiwicGFkRW5kIiwid3JpdGVVSW50MzJMRSIsImxlbmd0aCIsIk1hdGgiLCJyb3VuZCIsIkRhdGUiLCJub3ciLCJ3cml0ZVVJbnQxNkxFIiwic2xpY2UiLCJoZXhUb0J1ZiIsImhleCIsImZyb20iLCJzcGxpdCIsImpvaW4iLCJ0eHRDb252ZXJ0IiwibGluZXMiLCJ0b1N0cmluZyIsInJlc3VsdCIsImJlZ2luIiwib2Zmc2V0IiwiZm9yRWFjaCIsImxpbmUiLCJwYXJzZUludCIsImNvcHkiLCJkZWNDb252ZXJ0IiwicmF3IiwiXyIsImZsYXR0ZW4iLCJtYXAiLCJ0cmltIiwiZmlsdGVyIiwiYiIsImkiLCJOdW1iZXIiLCJpc05hTiIsImNvbnNvbGUiLCJlcnJvciIsInNvbWUiLCJFcnJvciIsIndvcmQiLCJtZXRhIiwicmJmIiwic2l6ZSIsImNvbnZlcnRlciIsInRjYSIsInRjYyIsImN0cmwiLCJhY3Rpb24iLCJkZXZpY2UiLCJhcmdzIiwib3B0cyIsInByb2Nlc3MiLCJlbnYiLCJmcyIsInByb21pc2VzIiwicmVhZEZpbGUiLCJzb3VyY2UiLCJpbmNsdWRlcyIsImhlYWRlciIsImNvbmNhdCIsImNyYyIsImRlc3QiLCJwYWRTdGFydCIsImJhciIsIlByb2dyZXNzIiwidG90YWwiLCJ3aWR0aCIsIm9uIiwiZG93bmxvYWREb21haW4iLCJ0aWNrIiwiZG93bmxvYWQiLCJleGVjdXRlIiwiZmxhc2hDb21tYW5kIiwiY29tbWFuZCIsImRlc2NyaWJlIiwiYnVpbGRlciIsImFyZ3YiLCJhbGlhcyIsImNob2ljZXMiLCJzdHJpbmciLCJleGFtcGxlIiwiZGVtYW5kT3B0aW9uIiwiaGFuZGxlciJd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UCxNQURPLEVBQ0M7QUFDZG1GLElBQUFBLEtBQUssRUFBRSxHQURPO0FBRWRDLElBQUFBLE9BQU8sRUFBRSxDQUFDLEtBQUQsRUFBUSxLQUFSLEVBQWUsS0FBZixFQUFzQixNQUF0QjtBQUZLLEdBREQsRUFLZjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFWZSxHQVdkcEYsTUFYYyxDQVdQLFFBWE8sRUFXRztBQUNoQm1GLElBQUFBLEtBQUssRUFBRSxLQURTO0FBRWhCRSxJQUFBQSxNQUFNLEVBQUUsSUFGUTtBQUdoQkwsSUFBQUEsUUFBUSxFQUFFO0FBSE0sR0FYSCxFQWdCZGhGLE1BaEJjLENBZ0JQLFNBaEJPLEVBZ0JJO0FBQ2pCbUYsSUFBQUEsS0FBSyxFQUFFLE1BRFU7QUFFakJFLElBQUFBLE1BQU0sRUFBRSxJQUZTO0FBR2pCTCxJQUFBQSxRQUFRLEVBQUU7QUFITyxHQWhCSixFQXFCZjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUE3QmUsR0E4QmRNLE9BOUJjLENBK0JiLE9BL0JhLEVBZ0NiLHNGQWhDYSxFQWtDZEMsWUFsQ2MsQ0FrQ0QsQ0FBQyxLQUFELEVBQVEsR0FBUixFQUFhLE1BQWIsRUFBcUIsUUFBckIsQ0FsQ0MsQ0FId0M7QUFzQ3pEQyxFQUFBQSxPQUFPLEVBQUUsa0NBQW1CbkMsTUFBbkI7QUF0Q2dELENBQTNEO2VBeUNleUIsWSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IChjKSAyMDE5LiBOYXRhLUluZm9cbiAqIEBhdXRob3IgQW5kcmVpIFNhcmFrZWV2IDxhdnNAbmF0YS1pbmZvLnJ1PlxuICpcbiAqIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIHRoZSBcIkBuYXRhXCIgcHJvamVjdC5cbiAqIEZvciB0aGUgZnVsbCBjb3B5cmlnaHQgYW5kIGxpY2Vuc2UgaW5mb3JtYXRpb24sIHBsZWFzZSB2aWV3XG4gKiB0aGUgRVVMQSBmaWxlIHRoYXQgd2FzIGRpc3RyaWJ1dGVkIHdpdGggdGhpcyBzb3VyY2UgY29kZS5cbiAqL1xuXG5pbXBvcnQgeyBBcmd1bWVudHMsIENvbW1hbmRNb2R1bGUsIERlZmluZWQgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBjcmMxNmNjaXR0IH0gZnJvbSAnY3JjJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFByb2dyZXNzIGZyb20gJ3Byb2dyZXNzJztcblxuaW1wb3J0IHsgSURldmljZSB9IGZyb20gJ0BuYXRhL25pYnVzLmpzLWNsaWVudC9saWIvbWliJztcbmltcG9ydCB7IG1ha2VBZGRyZXNzSGFuZGxlciB9IGZyb20gJy4uL2hhbmRsZXJzJztcbmltcG9ydCB7IENvbW1vbk9wdHMgfSBmcm9tICcuLi9vcHRpb25zJztcbmltcG9ydCB7IGFjdGlvbiBhcyB3cml0ZUFjdGlvbiB9IGZyb20gJy4vd3JpdGUnO1xuXG5jb25zdCBkb21haW4gPSAnUkZMQVNIJztcbmNvbnN0IGNyY1ByZXYgPSAweEFBNTU7XG5cbnR5cGUgS2luZCA9ICdyYmYnIHwgJ3RjYScgfCAndGNjJyB8ICdjdHJsJztcbnR5cGUgS2luZE9wdHMgPSB7IG9mZnNldDogbnVtYmVyLCBzaXplOiBudW1iZXJbXSwgY29udmVydGVyOiAoYnVmZmVyOiBCdWZmZXIpID0+IEJ1ZmZlciB9O1xudHlwZSBLaW5kTWV0YSA9IFJlY29yZDxLaW5kLCBLaW5kT3B0cz47XG5cbmNvbnN0IGlkZW50ID0gKGJ1ZjogQnVmZmVyKSA9PiBidWY7XG5cbnR5cGUgRmxhc2hPcHRzID0gRGVmaW5lZDxDb21tb25PcHRzLCAnbScgfCAnbWFjJz4gJiB7XG4gIGtpbmQ6IHN0cmluZyxcbiAgc291cmNlOiBzdHJpbmcsXG4gIHNyYz86IHN0cmluZyxcbiAgZXhlY3V0ZT86IHN0cmluZyxcbiAgLy8gaGV4PzogYm9vbGVhbixcbiAgLy8gZGVjPzogYm9vbGVhbixcbn07XG5cbmNvbnN0IGNyZWF0ZUhlYWRlciA9IChraW5kOiBzdHJpbmcsIG9wdGlvbjogbnVtYmVyLCBkYXRhOiBCdWZmZXIpID0+IHtcbiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmFsbG9jKDIwKTtcbiAgYnVmZmVyLndyaXRlKGtpbmQucGFkRW5kKDQsICdcXDAnKSk7XG4gIGJ1ZmZlci53cml0ZVVJbnQzMkxFKGRhdGEubGVuZ3RoLCA0KTtcbiAgYnVmZmVyLndyaXRlVUludDMyTEUoTWF0aC5yb3VuZChEYXRlLm5vdygpIC8gMTAwMCksIDgpO1xuICBidWZmZXIud3JpdGVVSW50MTZMRShvcHRpb24sIDE2KTtcbiAgYnVmZmVyLndyaXRlVUludDE2TEUoY3JjMTZjY2l0dChidWZmZXIuc2xpY2UoMCwgMTgpLCBjcmNQcmV2KSwgMTgpO1xuICByZXR1cm4gYnVmZmVyO1xufTtcblxuY29uc3QgaGV4VG9CdWYgPSAoaGV4OiBzdHJpbmcpID0+IEJ1ZmZlci5mcm9tKGhleC5zcGxpdCgvW1xcczotPV0vZykuam9pbignJyksICdoZXgnKTtcbmNvbnN0IHR4dENvbnZlcnQgPSAoYnVmZmVyOiBCdWZmZXIpOiBCdWZmZXIgPT4ge1xuICBjb25zdCBsaW5lcyA9IGJ1ZmZlci50b1N0cmluZygnYXNjaWknKS5zcGxpdCgvXFxyP1xcbi9nKTtcbiAgY29uc3QgcmVzdWx0ID0gQnVmZmVyLmFsbG9jKDMyNzY4LCAweEZGKTtcbiAgY29uc3QgYmVnaW4gPSAweDgwMDA7XG4gIGxldCBvZmZzZXQgPSAwO1xuICBsaW5lcy5mb3JFYWNoKChsaW5lKSA9PiB7XG4gICAgaWYgKGxpbmVbMF0gPT09ICdAJykge1xuICAgICAgb2Zmc2V0ID0gcGFyc2VJbnQobGluZS5zbGljZSgxKSwgMTYpIC0gYmVnaW47XG4gICAgfSBlbHNlIHtcbiAgICAgIG9mZnNldCArPSBoZXhUb0J1ZihsaW5lKS5jb3B5KHJlc3VsdCwgb2Zmc2V0KTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gcmVzdWx0O1xufTtcblxuY29uc3QgZGVjQ29udmVydCA9IChkYXRhOiBCdWZmZXIpID0+IHtcbiAgY29uc3QgbGluZXMgPSBkYXRhLnRvU3RyaW5nKCkuc3BsaXQoL1xccj9cXG4vZyk7XG4gIGNvbnN0IHJhdyA9IF8uZmxhdHRlbihsaW5lc1xuICAgIC5tYXAobGluZSA9PiBsaW5lLnRyaW0oKSlcbiAgICAuZmlsdGVyKGxpbmUgPT4gISFsaW5lKVxuICAgIC5tYXAobGluZSA9PiBsaW5lLnNwbGl0KC9cXHMrL2cpLm1hcCgoYikgPT4ge1xuICAgICAgY29uc3QgaSA9IHBhcnNlSW50KGIsIDEwKTtcbiAgICAgIGlmIChOdW1iZXIuaXNOYU4oaSkpIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgTnVtYmVyJywgYik7XG4gICAgICByZXR1cm4gaTtcbiAgICB9KSkpO1xuICBpZiAoXy5zb21lKHJhdywgYiA9PiBOdW1iZXIuaXNOYU4oYikpKSB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgbnVtYmVyJyk7XG4gIHJldHVybiBCdWZmZXIuZnJvbShfLmZsYXR0ZW4ocmF3Lm1hcCh3b3JkID0+IFt3b3JkICYgMHhGRiwgKHdvcmQgPj4gOCkgJiAweEZGXSkpKTtcbn07XG5cbmNvbnN0IG1ldGE6IEtpbmRNZXRhID0ge1xuICByYmY6IHtcbiAgICBvZmZzZXQ6IDB4NjAwMDAsXG4gICAgc2l6ZTogWzM2ODAxMV0sXG4gICAgY29udmVydGVyOiBpZGVudCxcbiAgfSxcbiAgdGNhOiB7XG4gICAgb2Zmc2V0OiAweEMwMDAwLFxuICAgIHNpemU6IFsxNTM2LCAyODIyXSxcbiAgICBjb252ZXJ0ZXI6IGRlY0NvbnZlcnQsXG4gIH0sXG4gIHRjYzoge1xuICAgIG9mZnNldDogMHhDMDAwMCxcbiAgICBzaXplOiBbMTUzNiwgMjgyMl0sXG4gICAgY29udmVydGVyOiBkZWNDb252ZXJ0LFxuICB9LFxuICBjdHJsOiB7XG4gICAgb2Zmc2V0OiAweEYwMDAwLFxuICAgIHNpemU6IFszMjc2OF0sXG4gICAgY29udmVydGVyOiB0eHRDb252ZXJ0LFxuICB9LFxufTtcblxuYXN5bmMgZnVuY3Rpb24gYWN0aW9uKGRldmljZTogSURldmljZSwgYXJnczogQXJndW1lbnRzPEZsYXNoT3B0cz4pIHtcbiAgYXdhaXQgd3JpdGVBY3Rpb24oZGV2aWNlLCBhcmdzKTtcbiAgY29uc3Qgb3B0cyA9IG1ldGFbYXJncy5raW5kIGFzIEtpbmRdO1xuICBwcm9jZXNzLmVudlsnTk9ERV9OT19XQVJOSU5HUyddID0gJzEnO1xuICBsZXQgYnVmZmVyID0gb3B0cy5jb252ZXJ0ZXIoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoYXJncy5zb3VyY2UpKTtcbiAgaWYgKCFvcHRzLnNpemUuaW5jbHVkZXMoYnVmZmVyLmxlbmd0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZGF0YSBsZW5ndGguIEV4cGVjdGVkICR7b3B0cy5zaXplLmpvaW4oJywnKX0gZ290ICR7YnVmZmVyLmxlbmd0aH1gKTtcbiAgfVxuICBpZiAoYXJncy5raW5kICE9PSAnY3RybCcpIHtcbiAgICBjb25zdCBoZWFkZXIgPSBjcmVhdGVIZWFkZXIoYXJncy5raW5kLCAwLCBidWZmZXIpO1xuICAgIGJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoW2hlYWRlciwgYnVmZmVyLCBoZWFkZXJdKTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBjcmMgPSBCdWZmZXIuYWxsb2MoMik7XG4gICAgY3JjLndyaXRlVUludDE2TEUoY3JjMTZjY2l0dChidWZmZXIsIGNyY1ByZXYpLCAwKTtcbiAgICBidWZmZXIgPSBCdWZmZXIuY29uY2F0KFtidWZmZXIsIGNyY10pO1xuICB9XG4gIGNvbnN0IGRlc3QgPSBvcHRzLm9mZnNldC50b1N0cmluZygxNikucGFkU3RhcnQoNCwgJzAnKTtcbiAgY29uc3QgYmFyID0gbmV3IFByb2dyZXNzKFxuICAgIGAgIGZsYXNoaW5nIFs6YmFyXSB0byAke2Rlc3R9IDpyYXRlL2JwcyA6cGVyY2VudCA6Y3VycmVudC86dG90YWwgOmV0YXNgLFxuICAgIHtcbiAgICAgIHRvdGFsOiBidWZmZXIubGVuZ3RoLFxuICAgICAgd2lkdGg6IDMwLFxuICAgIH0sXG4gICk7XG4gIGRldmljZS5vbignZG93bmxvYWREYXRhJywgKHsgZG9tYWluOiBkb3dubG9hZERvbWFpbiwgbGVuZ3RoIH0pID0+IHtcbiAgICBpZiAoZG9tYWluID09PSBkb3dubG9hZERvbWFpbikgYmFyLnRpY2sobGVuZ3RoKTtcbiAgfSk7XG5cbiAgYXdhaXQgZGV2aWNlLmRvd25sb2FkKGRvbWFpbiwgYnVmZmVyLCBvcHRzLm9mZnNldCk7XG4gIGlmIChhcmdzLmV4ZWN1dGUpIHtcbiAgICBhd2FpdCBkZXZpY2UuZXhlY3V0ZShhcmdzLmV4ZWN1dGUpO1xuICB9XG59XG5cbmNvbnN0IGZsYXNoQ29tbWFuZDogQ29tbWFuZE1vZHVsZTxDb21tb25PcHRzLCBGbGFzaE9wdHM+ID0ge1xuICBjb21tYW5kOiAnZmxhc2gnLFxuICBkZXNjcmliZTogJ9C/0YDQvtGI0LjQstC60LAg0LzQuNC90LjRhdC+0YHRgtCwMycsXG4gIGJ1aWxkZXI6IGFyZ3YgPT4gYXJndlxuICAgIC5vcHRpb24oJ2tpbmQnLCB7XG4gICAgICBhbGlhczogJ2snLFxuICAgICAgY2hvaWNlczogWydyYmYnLCAndGNhJywgJ3RjYycsICdjdHJsJ10sXG4gICAgfSlcbiAgICAvLyAub3B0aW9uKCdvZmZzZXQnLCB7XG4gICAgLy8gICBhbGlhczogJ29mcycsXG4gICAgLy8gICBkZWZhdWx0OiAwLFxuICAgIC8vICAgbnVtYmVyOiB0cnVlLFxuICAgIC8vICAgZGVzY3JpYmU6ICfRgdC80LXRidC10L3QuNC1INCyINC00L7QvNC10L3QtScsXG4gICAgLy8gfSlcbiAgICAub3B0aW9uKCdzb3VyY2UnLCB7XG4gICAgICBhbGlhczogJ3NyYycsXG4gICAgICBzdHJpbmc6IHRydWUsXG4gICAgICBkZXNjcmliZTogJ9C30LDQs9GA0YPQt9C40YLRjCDQtNCw0L3QvdGL0LUg0LjQtyDRhNCw0LnQu9CwJyxcbiAgICB9KVxuICAgIC5vcHRpb24oJ2V4ZWN1dGUnLCB7XG4gICAgICBhbGlhczogJ2V4ZWMnLFxuICAgICAgc3RyaW5nOiB0cnVlLFxuICAgICAgZGVzY3JpYmU6ICfQstGL0L/QvtC70L3QuNGC0Ywg0L/RgNC+0LPRgNCw0LzQvNGDINC/0L7RgdC70LUg0LfQsNC/0LjRgdC4JyxcbiAgICB9KVxuICAgIC8vIC5vcHRpb24oJ2hleCcsIHtcbiAgICAvLyAgIGJvb2xlYW46IHRydWUsXG4gICAgLy8gICBkZXNjcmliZTogJ9C40YHQv9C+0LvRjNC30L7QstCw0YLRjCDRiNC10YHRgtC90LDQtNGG0LDRgtC40YDQuNGH0L3Ri9C5INGE0L7RgNC80LDRgicsXG4gICAgLy8gfSlcbiAgICAvLyAub3B0aW9uKCdkZWMnLCB7XG4gICAgLy8gICBib29sZWFuOiB0cnVlLFxuICAgIC8vICAgZGVzY3JpYmU6ICfQuNGB0L/QvtC70YzQt9C+0LLQsNGC0Ywg0LTQtdGB0Y/RgtC40YfQvdGL0Lkg0LTQstGD0LHQsNC50YLQvdGL0Lkg0YTQvtGA0LzQsNGCJyxcbiAgICAvLyB9KVxuICAgIC8vIC5jb25mbGljdHMoJ2hleCcsICdkZWMnKVxuICAgIC5leGFtcGxlKFxuICAgICAgJ2ZsYXNoJyxcbiAgICAgICckMCBmbGFzaCAtbSA6OjEgLWsgY3RybCBtb2R1bGVTZWxlY3Q9MCAtLXNyYyBTbGltX0N0cmxfdjVfTWN1X3YxLjIudHh0IC0tZXhlYyB1cGRhdGUnLFxuICAgIClcbiAgICAuZGVtYW5kT3B0aW9uKFsnbWFjJywgJ20nLCAna2luZCcsICdzb3VyY2UnXSksXG4gIGhhbmRsZXI6IG1ha2VBZGRyZXNzSGFuZGxlcihhY3Rpb24pLFxufTtcblxuZXhwb3J0IGRlZmF1bHQgZmxhc2hDb21tYW5kO1xuIl19