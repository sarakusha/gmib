"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _configstore = _interopRequireDefault(require("configstore"));

var _debug = _interopRequireDefault(require("debug"));

var _lodash = _interopRequireDefault(require("lodash"));

var _ipc = require("../ipc");

var _Server = require("../ipc/Server");

var _mib = require("@nata/nibus.js-client/lib/mib");

var _devices = require("@nata/nibus.js-client/lib/mib/devices");

var _nibus = require("@nata/nibus.js-client/lib/nibus");

var _helper = require("@nata/nibus.js-client/lib/nibus/helper");

var _readline = require("readline");

var _fs = _interopRequireDefault(require("fs"));

var _nibus2 = require("@nata/nibus.js-client");

var _detector = _interopRequireDefault(require("./detector"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const pkgName = '@nata/nibus.js'; // = require('../../package.json');

const conf = new _configstore.default(pkgName, {
  logLevel: 'none',
  omit: ['priority']
}); // debugFactory.enable('nibus:detector,nibus.service');

const debug = (0, _debug.default)('nibus:service');
const debugIn = (0, _debug.default)('nibus:INP<<<');
const debugOut = (0, _debug.default)('nibus:OUT>>>');
debug(`config path: ${conf.path}`);

const noop = () => {};

if (process.platform === 'win32') {
  const rl = (0, _readline.createInterface)({
    input: process.stdin,
    output: process.stdout
  });
  rl.on('SIGINT', () => process.emit('SIGINT', 'SIGINT'));
}

const minVersionToInt = str => {
  if (!str) return 0;
  const [high, low] = str.split('.', 2);
  return ((0, _mib.toInt)(high) << 8) + (0, _mib.toInt)(low);
};

async function updateMibTypes() {
  const mibs = await (0, _mib.getMibs)();
  conf.set('mibs', mibs);
  const mibTypes = {};
  mibs.forEach(mib => {
    const mibfile = (0, _mib.getMibFile)(mib);

    const validation = _devices.MibDeviceV.decode(JSON.parse(_fs.default.readFileSync(mibfile).toString()));

    if (validation.isLeft()) {
      debug(`<error>: Invalid mib file ${mibfile}`);
    } else {
      const {
        types
      } = validation.value;
      const device = types[validation.value.device];
      const type = (0, _mib.toInt)(device.appinfo.device_type);
      const minVersion = minVersionToInt(device.appinfo.min_version);
      const mibs = mibTypes[type] || [];
      mibs.push({
        mib,
        minVersion
      });
      mibTypes[type] = _lodash.default.sortBy(mibs, 'minVersion');
    }
  });
  conf.set('mibTypes', mibTypes);
}

updateMibTypes().catch(e => debug(`<error> ${e.message}`)); // const direction = (dir: Direction) => dir === Direction.in ? '<<<' : '>>>';

const decoderIn = new _nibus.NibusDecoder();
decoderIn.on('data', datagram => {
  debugIn(datagram.toString({
    pick: conf.get('pick'),
    omit: conf.get('omit')
  }));
});
const decoderOut = new _nibus.NibusDecoder();
decoderOut.on('data', datagram => {
  debugOut(datagram.toString({
    pick: conf.get('pick'),
    omit: conf.get('omit')
  }));
});
const loggers = {
  none: null,
  hex: (data, dir) => {
    switch (dir) {
      case _Server.Direction.in:
        debugIn((0, _helper.printBuffer)(data));
        break;

      case _Server.Direction.out:
        debugOut((0, _helper.printBuffer)(data));
        break;
    }
  },
  nibus: (data, dir) => {
    switch (dir) {
      case _Server.Direction.in:
        decoderIn.write(data);
        break;

      case _Server.Direction.out:
        decoderOut.write(data);
        break;
    }
  }
};

class NibusService {
  constructor() {
    _defineProperty(this, "server", void 0);

    _defineProperty(this, "isStarted", false);

    _defineProperty(this, "connections", []);

    _defineProperty(this, "logLevelHandler", (client, logLevel, pickFields, omitFields) => {
      logLevel && conf.set('logLevel', logLevel);
      pickFields && conf.set('pick', pickFields);
      omitFields && conf.set('omit', omitFields);
      this.updateLogger();
    });

    _defineProperty(this, "connectionHandler", socket => {
      const {
        server,
        connections
      } = this;
      server.send(socket, 'ports', connections.map(connection => connection.toJSON())).catch(err => {
        debug('<error>', err.stack);
      });
    });

    _defineProperty(this, "addHandler", portInfo => {
      const {
        category
      } = portInfo;
      const mibCategory = _detector.default.detection.mibCategories[category];

      if (mibCategory) {
        const connection = new _ipc.SerialTee(portInfo, mibCategory);
        connection.on('close', comName => this.removeHandler({
          comName
        }));
        this.connections.push(connection);
        this.server.broadcast('add', connection.toJSON()).catch(noop);
        this.updateLogger(connection); // this.find(connection);
      }
    });

    _defineProperty(this, "removeHandler", ({
      comName
    }) => {
      const index = this.connections.findIndex(({
        portInfo: {
          comName: port
        }
      }) => port === comName);

      if (index !== -1) {
        const [connection] = this.connections.splice(index, 1); // debug(`nibus-connection was closed ${connection.description.category}`);

        connection.close();
        this.server.broadcast('remove', connection.toJSON()).catch(noop);
      }
    });

    this.server = new _ipc.Server(_nibus2.PATH);
    this.server.on('connection', this.connectionHandler);
    this.server.on('client:setLogLevel', this.logLevelHandler);
  }

  updateLogger(connection) {
    const logger = loggers[conf.get('logLevel')];
    const connections = connection ? [connection] : this.connections;
    connections.forEach(con => con.setLogger(logger));
  }

  start() {
    if (this.isStarted) return;
    this.isStarted = true;
    const {
      detection
    } = _detector.default;
    if (detection == null) throw new Error('detection is N/A');

    _detector.default.on('add', this.addHandler);

    _detector.default.on('remove', this.removeHandler);

    _detector.default.getPorts().catch(err => {
      console.error('error while get ports', err.stack);
    });

    _detector.default.start();

    process.once('SIGINT', () => this.stop());
    process.once('SIGTERM', () => this.stop());
    /**
     * @event NibusService#start
     */

    debug('started');
  }

  stop() {
    if (!this.isStarted) return;
    const connections = this.connections.splice(0, this.connections.length);

    if (connections.length) {
      // Хак, нужен чтобы успеть закрыть все соединения, иначе не успевает их закрыть и выходит
      setTimeout(() => {
        connections.forEach(connection => connection.close());
      }, 0);
    }

    _detector.default.removeListener('add', this.addHandler);

    _detector.default.removeListener('remove', this.removeHandler); // detector.stop();


    this.isStarted = false;
    debug('stopped');
  }

  get path() {
    return this.server.path;
  }

}

const service = new NibusService();
var _default = service;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlL2luZGV4LnRzIl0sIm5hbWVzIjpbInBrZ05hbWUiLCJjb25mIiwiQ29uZmlnc3RvcmUiLCJsb2dMZXZlbCIsIm9taXQiLCJkZWJ1ZyIsImRlYnVnSW4iLCJkZWJ1Z091dCIsInBhdGgiLCJub29wIiwicHJvY2VzcyIsInBsYXRmb3JtIiwicmwiLCJpbnB1dCIsInN0ZGluIiwib3V0cHV0Iiwic3Rkb3V0Iiwib24iLCJlbWl0IiwibWluVmVyc2lvblRvSW50Iiwic3RyIiwiaGlnaCIsImxvdyIsInNwbGl0IiwidXBkYXRlTWliVHlwZXMiLCJtaWJzIiwic2V0IiwibWliVHlwZXMiLCJmb3JFYWNoIiwibWliIiwibWliZmlsZSIsInZhbGlkYXRpb24iLCJNaWJEZXZpY2VWIiwiZGVjb2RlIiwiSlNPTiIsInBhcnNlIiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJ0b1N0cmluZyIsImlzTGVmdCIsInR5cGVzIiwidmFsdWUiLCJkZXZpY2UiLCJ0eXBlIiwiYXBwaW5mbyIsImRldmljZV90eXBlIiwibWluVmVyc2lvbiIsIm1pbl92ZXJzaW9uIiwicHVzaCIsIl8iLCJzb3J0QnkiLCJjYXRjaCIsImUiLCJtZXNzYWdlIiwiZGVjb2RlckluIiwiTmlidXNEZWNvZGVyIiwiZGF0YWdyYW0iLCJwaWNrIiwiZ2V0IiwiZGVjb2Rlck91dCIsImxvZ2dlcnMiLCJub25lIiwiaGV4IiwiZGF0YSIsImRpciIsIkRpcmVjdGlvbiIsImluIiwib3V0IiwibmlidXMiLCJ3cml0ZSIsIk5pYnVzU2VydmljZSIsImNvbnN0cnVjdG9yIiwiY2xpZW50IiwicGlja0ZpZWxkcyIsIm9taXRGaWVsZHMiLCJ1cGRhdGVMb2dnZXIiLCJzb2NrZXQiLCJzZXJ2ZXIiLCJjb25uZWN0aW9ucyIsInNlbmQiLCJtYXAiLCJjb25uZWN0aW9uIiwidG9KU09OIiwiZXJyIiwic3RhY2siLCJwb3J0SW5mbyIsImNhdGVnb3J5IiwibWliQ2F0ZWdvcnkiLCJkZXRlY3RvciIsImRldGVjdGlvbiIsIm1pYkNhdGVnb3JpZXMiLCJTZXJpYWxUZWUiLCJjb21OYW1lIiwicmVtb3ZlSGFuZGxlciIsImJyb2FkY2FzdCIsImluZGV4IiwiZmluZEluZGV4IiwicG9ydCIsInNwbGljZSIsImNsb3NlIiwiU2VydmVyIiwiUEFUSCIsImNvbm5lY3Rpb25IYW5kbGVyIiwibG9nTGV2ZWxIYW5kbGVyIiwibG9nZ2VyIiwiY29uIiwic2V0TG9nZ2VyIiwic3RhcnQiLCJpc1N0YXJ0ZWQiLCJFcnJvciIsImFkZEhhbmRsZXIiLCJnZXRQb3J0cyIsImNvbnNvbGUiLCJlcnJvciIsIm9uY2UiLCJzdG9wIiwibGVuZ3RoIiwic2V0VGltZW91dCIsInJlbW92ZUxpc3RlbmVyIiwic2VydmljZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBVUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUdBLE1BQU1BLE9BQU8sR0FBRyxnQkFBaEIsQyxDQUFrQzs7QUFDbEMsTUFBTUMsSUFBSSxHQUFHLElBQUlDLG9CQUFKLENBQ1hGLE9BRFcsRUFFWDtBQUNFRyxFQUFBQSxRQUFRLEVBQUUsTUFEWjtBQUVFQyxFQUFBQSxJQUFJLEVBQUUsQ0FBQyxVQUFEO0FBRlIsQ0FGVyxDQUFiLEMsQ0FRQTs7QUFDQSxNQUFNQyxLQUFLLEdBQUcsb0JBQWEsZUFBYixDQUFkO0FBQ0EsTUFBTUMsT0FBTyxHQUFHLG9CQUFhLGNBQWIsQ0FBaEI7QUFDQSxNQUFNQyxRQUFRLEdBQUcsb0JBQWEsY0FBYixDQUFqQjtBQUVBRixLQUFLLENBQUUsZ0JBQWVKLElBQUksQ0FBQ08sSUFBSyxFQUEzQixDQUFMOztBQUVBLE1BQU1DLElBQUksR0FBRyxNQUFNLENBQUUsQ0FBckI7O0FBRUEsSUFBSUMsT0FBTyxDQUFDQyxRQUFSLEtBQXFCLE9BQXpCLEVBQWtDO0FBQ2hDLFFBQU1DLEVBQUUsR0FBRywrQkFBZ0I7QUFDekJDLElBQUFBLEtB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LE1BQWpCLENBQXdCLENBQXhCLEVBQTJCLEtBQUtwQixXQUFMLENBQWlCc0MsTUFBNUMsQ0FBcEI7O0FBQ0EsUUFBSXRDLFdBQVcsQ0FBQ3NDLE1BQWhCLEVBQXdCO0FBQ3RCO0FBQ0FDLE1BQUFBLFVBQVUsQ0FBQyxNQUFNO0FBQ2Z2QyxRQUFBQSxXQUFXLENBQUNsRCxPQUFaLENBQW9CcUQsVUFBVSxJQUFJQSxVQUFVLENBQUNrQixLQUFYLEVBQWxDO0FBQ0QsT0FGUyxFQUVQLENBRk8sQ0FBVjtBQUdEOztBQUNEWCxzQkFBUzhCLGNBQVQsQ0FBd0IsS0FBeEIsRUFBK0IsS0FBS1IsVUFBcEM7O0FBQ0F0QixzQkFBUzhCLGNBQVQsQ0FBd0IsUUFBeEIsRUFBa0MsS0FBS3pCLGFBQXZDLEVBVlksQ0FXWjs7O0FBQ0EsU0FBS2UsU0FBTCxHQUFpQixLQUFqQjtBQUNBdkcsSUFBQUEsS0FBSyxDQUFDLFNBQUQsQ0FBTDtBQUNEOztBQUVELE1BQUlHLElBQUosR0FBVztBQUNULFdBQU8sS0FBS3FFLE1BQUwsQ0FBWXJFLElBQW5CO0FBQ0Q7O0FBbEdnQjs7QUFxR25CLE1BQU0rRyxPQUFPLEdBQUcsSUFBSWpELFlBQUosRUFBaEI7ZUFFZWlELE8iLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAoYykgMjAxOS4gTmF0YS1JbmZvXG4gKiBAYXV0aG9yIEFuZHJlaSBTYXJha2VldiA8YXZzQG5hdGEtaW5mby5ydT5cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiB0aGUgXCJAbmF0YVwiIHByb2plY3QuXG4gKiBGb3IgdGhlIGZ1bGwgY29weXJpZ2h0IGFuZCBsaWNlbnNlIGluZm9ybWF0aW9uLCBwbGVhc2Ugdmlld1xuICogdGhlIEVVTEEgZmlsZSB0aGF0IHdhcyBkaXN0cmlidXRlZCB3aXRoIHRoaXMgc291cmNlIGNvZGUuXG4gKi9cblxuaW1wb3J0IENvbmZpZ3N0b3JlIGZyb20gJ2NvbmZpZ3N0b3JlJztcbmltcG9ydCBkZWJ1Z0ZhY3RvcnkgZnJvbSAnZGVidWcnO1xuaW1wb3J0IHsgU29ja2V0IH0gZnJvbSAnbmV0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBTZXJpYWxUZWUsIFNlcnZlciB9IGZyb20gJy4uL2lwYyc7XG5pbXBvcnQgeyBTZXJpYWxMb2dnZXIgfSBmcm9tICcuLi9pcGMvU2VyaWFsVGVlJztcbmltcG9ydCB7IERpcmVjdGlvbiB9IGZyb20gJy4uL2lwYy9TZXJ2ZXInO1xuaW1wb3J0IHsgZ2V0TWliRmlsZSwgZ2V0TWlicywgdG9JbnQgfSBmcm9tICdAbmF0YS9uaWJ1cy5qcy1jbGllbnQvbGliL21pYic7XG5pbXBvcnQgeyBJTWliRGV2aWNlVHlwZSwgTWliRGV2aWNlViB9IGZyb20gJ0BuYXRhL25pYnVzLmpzLWNsaWVudC9saWIvbWliL2RldmljZXMnO1xuaW1wb3J0IHsgTmlidXNEYXRhZ3JhbSwgTmlidXNEZWNvZGVyIH0gZnJvbSAnQG5hdGEvbmlidXMuanMtY2xpZW50L2xpYi9uaWJ1cyc7XG5pbXBvcnQgeyBwcmludEJ1ZmZlciB9IGZyb20gJ0BuYXRhL25pYnVzLmpzLWNsaWVudC9saWIvbmlidXMvaGVscGVyJztcbmltcG9ydCB7IGNyZWF0ZUludGVyZmFjZSB9IGZyb20gJ3JlYWRsaW5lJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBDb25maWcsIExvZ0xldmVsLCBQQVRIIH0gZnJvbSAnQG5hdGEvbmlidXMuanMtY2xpZW50JztcbmltcG9ydCBkZXRlY3RvciBmcm9tICcuL2RldGVjdG9yJztcbmltcG9ydCB7IElLbm93blBvcnQgfSBmcm9tICdAbmF0YS9uaWJ1cy5qcy1jbGllbnQvbGliL3Nlc3Npb24vS25vd25Qb3J0cyc7XG5cbmNvbnN0IHBrZ05hbWUgPSAnQG5hdGEvbmlidXMuanMnOyAvLyA9IHJlcXVpcmUoJy4uLy4uL3BhY2thZ2UuanNvbicpO1xuY29uc3QgY29uZiA9IG5ldyBDb25maWdzdG9yZShcbiAgcGtnTmFtZSxcbiAge1xuICAgIGxvZ0xldmVsOiAnbm9uZScsXG4gICAgb21pdDogWydwcmlvcml0eSddLFxuICB9LFxuKTtcblxuLy8gZGVidWdGYWN0b3J5LmVuYWJsZSgnbmlidXM6ZGV0ZWN0b3IsbmlidXMuc2VydmljZScpO1xuY29uc3QgZGVidWcgPSBkZWJ1Z0ZhY3RvcnkoJ25pYnVzOnNlcnZpY2UnKTtcbmNvbnN0IGRlYnVnSW4gPSBkZWJ1Z0ZhY3RvcnkoJ25pYnVzOklOUDw8PCcpO1xuY29uc3QgZGVidWdPdXQgPSBkZWJ1Z0ZhY3RvcnkoJ25pYnVzOk9VVD4+PicpO1xuXG5kZWJ1ZyhgY29uZmlnIHBhdGg6ICR7Y29uZi5wYXRofWApO1xuXG5jb25zdCBub29wID0gKCkgPT4ge307XG5cbmlmIChwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInKSB7XG4gIGNvbnN0IHJsID0gY3JlYXRlSW50ZXJmYWNlKHtcbiAgICBpbnB1dDogcHJvY2Vzcy5zdGRpbixcbiAgICBvdXRwdXQ6IHByb2Nlc3Muc3Rkb3V0LFxuICB9KTtcblxuICBybC5vbignU0lHSU5UJywgKCkgPT4gcHJvY2Vzcy5lbWl0KCdTSUdJTlQnLCAnU0lHSU5UJykpO1xufVxuXG50eXBlIEZpZWxkcyA9IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuXG5jb25zdCBtaW5WZXJzaW9uVG9JbnQgPSAoc3RyPzogc3RyaW5nKSA9PiB7XG4gIGlmICghc3RyKSByZXR1cm4gMDtcbiAgY29uc3QgW2hpZ2gsIGxvd10gPSBzdHIuc3BsaXQoJy4nLCAyKTtcbiAgcmV0dXJuICh0b0ludChoaWdoKSA8PCA4KSArIHRvSW50KGxvdyk7XG59O1xuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVNaWJUeXBlcygpIHtcbiAgY29uc3QgbWlicyA9IGF3YWl0IGdldE1pYnMoKTtcbiAgY29uZi5zZXQoJ21pYnMnLCBtaWJzKTtcbiAgY29uc3QgbWliVHlwZXM6IENvbmZpZ1snbWliVHlwZXMnXSA9IHt9O1xuICBtaWJzLmZvckVhY2goKG1pYikgPT4ge1xuICAgIGNvbnN0IG1pYmZpbGUgPSBnZXRNaWJGaWxlKG1pYik7XG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IE1pYkRldmljZVYuZGVjb2RlKEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKG1pYmZpbGUpLnRvU3RyaW5nKCkpKTtcbiAgICBpZiAodmFsaWRhdGlvbi5pc0xlZnQoKSkge1xuICAgICAgZGVidWcoYDxlcnJvcj46IEludmFsaWQgbWliIGZpbGUgJHttaWJmaWxlfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCB7IHR5cGVzIH0gPSB2YWxpZGF0aW9uLnZhbHVlO1xuICAgICAgY29uc3QgZGV2aWNlID0gdHlwZXNbdmFsaWRhdGlvbi52YWx1ZS5kZXZpY2VdIGFzIElNaWJEZXZpY2VUeXBlO1xuICAgICAgY29uc3QgdHlwZSA9IHRvSW50KGRldmljZS5hcHBpbmZvLmRldmljZV90eXBlKTtcbiAgICAgIGNvbnN0IG1pblZlcnNpb24gPSBtaW5WZXJzaW9uVG9JbnQoZGV2aWNlLmFwcGluZm8ubWluX3ZlcnNpb24pO1xuICAgICAgY29uc3QgbWlicyA9IG1pYlR5cGVzW3R5cGVdIHx8IFtdO1xuICAgICAgbWlicy5wdXNoKHtcbiAgICAgICAgbWliLFxuICAgICAgICBtaW5WZXJzaW9uLFxuICAgICAgfSk7XG4gICAgICBtaWJUeXBlc1t0eXBlXSA9IF8uc29ydEJ5KG1pYnMsICdtaW5WZXJzaW9uJyk7XG4gICAgfVxuICB9KTtcbiAgY29uZi5zZXQoJ21pYlR5cGVzJywgbWliVHlwZXMpO1xufVxuXG51cGRhdGVNaWJUeXBlcygpLmNhdGNoKGUgPT4gZGVidWcoYDxlcnJvcj4gJHtlLm1lc3NhZ2V9YCkpO1xuXG4vLyBjb25zdCBkaXJlY3Rpb24gPSAoZGlyOiBEaXJlY3Rpb24pID0+IGRpciA9PT0gRGlyZWN0aW9uLmluID8gJzw8PCcgOiAnPj4+JztcbmNvbnN0IGRlY29kZXJJbiA9IG5ldyBOaWJ1c0RlY29kZXIoKTtcbmRlY29kZXJJbi5vbignZGF0YScsIChkYXRhZ3JhbTogTmlidXNEYXRhZ3JhbSkgPT4ge1xuICBkZWJ1Z0luKGRhdGFncmFtLnRvU3RyaW5nKHtcbiAgICBwaWNrOiBjb25mLmdldCgncGljaycpIGFzIEZpZWxkcyxcbiAgICBvbWl0OiBjb25mLmdldCgnb21pdCcpIGFzIEZpZWxkcyxcbiAgfSkpO1xufSk7XG5jb25zdCBkZWNvZGVyT3V0ID0gbmV3IE5pYnVzRGVjb2RlcigpO1xuZGVjb2Rlck91dC5vbignZGF0YScsIChkYXRhZ3JhbTogTmlidXNEYXRhZ3JhbSkgPT4ge1xuICBkZWJ1Z091dChkYXRhZ3JhbS50b1N0cmluZyh7XG4gICAgcGljazogY29uZi5nZXQoJ3BpY2snKSBhcyBGaWVsZHMsXG4gICAgb21pdDogY29uZi5nZXQoJ29taXQnKSBhcyBGaWVsZHMsXG4gIH0pKTtcbn0pO1xuXG5jb25zdCBsb2dnZXJzID0ge1xuICBub25lOiBudWxsLFxuICBoZXg6IChkYXRhOiBCdWZmZXIsIGRpcjogRGlyZWN0aW9uKSA9PiB7XG4gICAgc3dpdGNoIChkaXIpIHtcbiAgICAgIGNhc2UgRGlyZWN0aW9uLmluOlxuICAgICAgICBkZWJ1Z0luKHByaW50QnVmZmVyKGRhdGEpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIERpcmVjdGlvbi5vdXQ6XG4gICAgICAgIGRlYnVnT3V0KHByaW50QnVmZmVyKGRhdGEpKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9LFxuICBuaWJ1czogKGRhdGE6IEJ1ZmZlciwgZGlyOiBEaXJlY3Rpb24pID0+IHtcbiAgICBzd2l0Y2ggKGRpcikge1xuICAgICAgY2FzZSBEaXJlY3Rpb24uaW46XG4gICAgICAgIGRlY29kZXJJbi53cml0ZShkYXRhKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIERpcmVjdGlvbi5vdXQ6XG4gICAgICAgIGRlY29kZXJPdXQud3JpdGUoZGF0YSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSxcbn07XG5cbmNsYXNzIE5pYnVzU2VydmljZSB7XG4gIHByaXZhdGUgcmVhZG9ubHkgc2VydmVyOiBTZXJ2ZXI7XG4gIHByaXZhdGUgaXNTdGFydGVkID0gZmFsc2U7XG4gIHByaXZhdGUgY29ubmVjdGlvbnM6IFNlcmlhbFRlZVtdID0gW107XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5zZXJ2ZXIgPSBuZXcgU2VydmVyKFBBVEgpO1xuICAgIHRoaXMuc2VydmVyLm9uKCdjb25uZWN0aW9uJywgdGhpcy5jb25uZWN0aW9uSGFuZGxlcik7XG4gICAgdGhpcy5zZXJ2ZXIub24oJ2NsaWVudDpzZXRMb2dMZXZlbCcsIHRoaXMubG9nTGV2ZWxIYW5kbGVyKTtcbiAgfVxuXG4gIHVwZGF0ZUxvZ2dlcihjb25uZWN0aW9uPzogU2VyaWFsVGVlKSB7XG4gICAgY29uc3QgbG9nZ2VyOiBTZXJpYWxMb2dnZXIgfCBudWxsID0gbG9nZ2Vyc1tjb25mLmdldCgnbG9nTGV2ZWwnKSBhcyBMb2dMZXZlbF07XG4gICAgY29uc3QgY29ubmVjdGlvbnMgPSBjb25uZWN0aW9uID8gW2Nvbm5lY3Rpb25dIDogdGhpcy5jb25uZWN0aW9ucztcbiAgICBjb25uZWN0aW9ucy5mb3JFYWNoKGNvbiA9PiBjb24uc2V0TG9nZ2VyKGxvZ2dlcikpO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2dMZXZlbEhhbmRsZXIgPSAoXG4gICAgY2xpZW50OiBTb2NrZXQsXG4gICAgbG9nTGV2ZWw6IExvZ0xldmVsIHwgdW5kZWZpbmVkLFxuICAgIHBpY2tGaWVsZHM6IEZpZWxkcyxcbiAgICBvbWl0RmllbGRzOiBGaWVsZHMpID0+IHtcbiAgICBsb2dMZXZlbCAmJiBjb25mLnNldCgnbG9nTGV2ZWwnLCBsb2dMZXZlbCk7XG4gICAgcGlja0ZpZWxkcyAmJiBjb25mLnNldCgncGljaycsIHBpY2tGaWVsZHMpO1xuICAgIG9taXRGaWVsZHMgJiYgY29uZi5zZXQoJ29taXQnLCBvbWl0RmllbGRzKTtcbiAgICB0aGlzLnVwZGF0ZUxvZ2dlcigpO1xuICB9O1xuXG4gIHByaXZhdGUgY29ubmVjdGlvbkhhbmRsZXIgPSAoc29ja2V0OiBTb2NrZXQpID0+IHtcbiAgICBjb25zdCB7IHNlcnZlciwgY29ubmVjdGlvbnMgfSA9IHRoaXM7XG4gICAgc2VydmVyXG4gICAgICAuc2VuZChzb2NrZXQsICdwb3J0cycsIGNvbm5lY3Rpb25zLm1hcChjb25uZWN0aW9uID0+IGNvbm5lY3Rpb24udG9KU09OKCkpKVxuICAgICAgLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgZGVidWcoJzxlcnJvcj4nLCBlcnIuc3RhY2spO1xuICAgICAgfSk7XG4gIH07XG5cbiAgcHJpdmF0ZSBhZGRIYW5kbGVyID0gKHBvcnRJbmZvOiBJS25vd25Qb3J0KSA9PiB7XG4gICAgY29uc3QgeyBjYXRlZ29yeSB9ID0gcG9ydEluZm87XG4gICAgY29uc3QgbWliQ2F0ZWdvcnkgPSBkZXRlY3Rvci5kZXRlY3Rpb24hLm1pYkNhdGVnb3JpZXNbY2F0ZWdvcnkhXTtcbiAgICBpZiAobWliQ2F0ZWdvcnkpIHtcbiAgICAgIGNvbnN0IGNvbm5lY3Rpb24gPSBuZXcgU2VyaWFsVGVlKHBvcnRJbmZvLCBtaWJDYXRlZ29yeSk7XG4gICAgICBjb25uZWN0aW9uLm9uKCdjbG9zZScsIChjb21OYW1lOiBzdHJpbmcpID0+IHRoaXMucmVtb3ZlSGFuZGxlcih7IGNvbU5hbWUgfSkpO1xuICAgICAgdGhpcy5jb25uZWN0aW9ucy5wdXNoKGNvbm5lY3Rpb24pO1xuICAgICAgdGhpcy5zZXJ2ZXIuYnJvYWRjYXN0KCdhZGQnLCBjb25uZWN0aW9uLnRvSlNPTigpKS5jYXRjaChub29wKTtcbiAgICAgIHRoaXMudXBkYXRlTG9nZ2VyKGNvbm5lY3Rpb24pO1xuICAgICAgLy8gdGhpcy5maW5kKGNvbm5lY3Rpb24pO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIHJlbW92ZUhhbmRsZXIgPSAoeyBjb21OYW1lIH06IHsgY29tTmFtZTogc3RyaW5nIH0pID0+IHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuY29ubmVjdGlvbnMuZmluZEluZGV4KCh7IHBvcnRJbmZvOiB7IGNvbU5hbWU6IHBvcnQgfSB9KSA9PiBwb3J0ID09PSBjb21OYW1lKTtcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICBjb25zdCBbY29ubmVjdGlvbl0gPSB0aGlzLmNvbm5lY3Rpb25zLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAvLyBkZWJ1ZyhgbmlidXMtY29ubmVjdGlvbiB3YXMgY2xvc2VkICR7Y29ubmVjdGlvbi5kZXNjcmlwdGlvbi5jYXRlZ29yeX1gKTtcbiAgICAgIGNvbm5lY3Rpb24uY2xvc2UoKTtcbiAgICAgIHRoaXMuc2VydmVyLmJyb2FkY2FzdCgncmVtb3ZlJywgY29ubmVjdGlvbi50b0pTT04oKSkuY2F0Y2gobm9vcCk7XG4gICAgfVxuICB9O1xuXG4gIHB1YmxpYyBzdGFydCgpIHtcbiAgICBpZiAodGhpcy5pc1N0YXJ0ZWQpIHJldHVybjtcbiAgICB0aGlzLmlzU3RhcnRlZCA9IHRydWU7XG4gICAgY29uc3QgeyBkZXRlY3Rpb24gfSA9IGRldGVjdG9yO1xuICAgIGlmIChkZXRlY3Rpb24gPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdkZXRlY3Rpb24gaXMgTi9BJyk7XG4gICAgZGV0ZWN0b3Iub24oJ2FkZCcsIHRoaXMuYWRkSGFuZGxlcik7XG4gICAgZGV0ZWN0b3Iub24oJ3JlbW92ZScsIHRoaXMucmVtb3ZlSGFuZGxlcik7XG4gICAgZGV0ZWN0b3IuZ2V0UG9ydHMoKS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICBjb25zb2xlLmVycm9yKCdlcnJvciB3aGlsZSBnZXQgcG9ydHMnLCBlcnIuc3RhY2spO1xuICAgIH0pO1xuXG4gICAgZGV0ZWN0b3Iuc3RhcnQoKTtcbiAgICBwcm9jZXNzLm9uY2UoJ1NJR0lOVCcsICgpID0+IHRoaXMuc3RvcCgpKTtcbiAgICBwcm9jZXNzLm9uY2UoJ1NJR1RFUk0nLCAoKSA9PiB0aGlzLnN0b3AoKSk7XG4gICAgLyoqXG4gICAgICogQGV2ZW50IE5pYnVzU2VydmljZSNzdGFydFxuICAgICAqL1xuICAgIGRlYnVnKCdzdGFydGVkJyk7XG4gIH1cblxuICBwdWJsaWMgc3RvcCgpIHtcbiAgICBpZiAoIXRoaXMuaXNTdGFydGVkKSByZXR1cm47XG4gICAgY29uc3QgY29ubmVjdGlvbnMgPSB0aGlzLmNvbm5lY3Rpb25zLnNwbGljZSgwLCB0aGlzLmNvbm5lY3Rpb25zLmxlbmd0aCk7XG4gICAgaWYgKGNvbm5lY3Rpb25zLmxlbmd0aCkge1xuICAgICAgLy8g0KXQsNC6LCDQvdGD0LbQtdC9INGH0YLQvtCx0Ysg0YPRgdC/0LXRgtGMINC30LDQutGA0YvRgtGMINCy0YHQtSDRgdC+0LXQtNC40L3QtdC90LjRjywg0LjQvdCw0YfQtSDQvdC1INGD0YHQv9C10LLQsNC10YIg0LjRhSDQt9Cw0LrRgNGL0YLRjCDQuCDQstGL0YXQvtC00LjRglxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbm5lY3Rpb25zLmZvckVhY2goY29ubmVjdGlvbiA9PiBjb25uZWN0aW9uLmNsb3NlKCkpO1xuICAgICAgfSwgMCk7XG4gICAgfVxuICAgIGRldGVjdG9yLnJlbW92ZUxpc3RlbmVyKCdhZGQnLCB0aGlzLmFkZEhhbmRsZXIpO1xuICAgIGRldGVjdG9yLnJlbW92ZUxpc3RlbmVyKCdyZW1vdmUnLCB0aGlzLnJlbW92ZUhhbmRsZXIpO1xuICAgIC8vIGRldGVjdG9yLnN0b3AoKTtcbiAgICB0aGlzLmlzU3RhcnRlZCA9IGZhbHNlO1xuICAgIGRlYnVnKCdzdG9wcGVkJyk7XG4gIH1cblxuICBnZXQgcGF0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5zZXJ2ZXIucGF0aDtcbiAgfVxufVxuXG5jb25zdCBzZXJ2aWNlID0gbmV3IE5pYnVzU2VydmljZSgpO1xuXG5leHBvcnQgZGVmYXVsdCBzZXJ2aWNlO1xuIl19