"use strict";

require("source-map-support/register");

var _configstore = _interopRequireDefault(require("configstore"));

var _debug = _interopRequireDefault(require("debug"));

var _lodash = _interopRequireDefault(require("lodash"));

var _ipc = require("../ipc");

var _Server = require("../ipc/Server");

var _mib = require("@nata/nibus.js-client/lib/mib");

var _devices = require("@nata/nibus.js-client/lib/mib/devices");

var _nibus = require("@nata/nibus.js-client/lib/nibus");

var _helper = require("@nata/nibus.js-client/lib/nibus/helper");

var _nibus2 = require("@nata/nibus.js-client");

var _detector = _interopRequireDefault(require("./detector"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const pkg = require('../../package.json');

const conf = new _configstore.default(pkg.name, {
  logLevel: 'none',
  omit: ['priority']
}); // debugFactory.enable('nibus:detector,nibus.service');

const debug = (0, _debug.default)('nibus:service');
const debugIn = (0, _debug.default)('nibus:INP<<<');
const debugOut = (0, _debug.default)('nibus:OUT>>>');
debug(`config path: ${conf.path}`);

const noop = () => {};

if (process.platform === 'win32') {
  const rl = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
  });

  rl.on('SIGINT', () => process.emit('SIGINT', 'SIGINT'));
}

const minVersionToInt = str => {
  if (!str) return 0;
  const [high, low] = str.split('.', 2);
  return ((0, _mib.toInt)(high) << 8) + (0, _mib.toInt)(low);
};

async function updateMibTypes() {
  const mibs = await (0, _mib.getMibs)();
  conf.set('mibs', mibs);
  const mibTypes = {};
  mibs.forEach(mib => {
    const mibfile = (0, _mib.getMibFile)(mib);

    const validation = _devices.MibDeviceV.decode(require(mibfile));

    if (validation.isLeft()) {
      debug(`<error>: Invalid mib file ${mibfile}`);
    } else {
      const {
        types
      } = validation.value;
      const device = types[validation.value.device];
      const type = (0, _mib.toInt)(device.appinfo.device_type);
      const minVersion = minVersionToInt(device.appinfo.min_version);
      const mibs = mibTypes[type] || [];
      mibs.push({
        mib,
        minVersion
      });
      mibTypes[type] = _lodash.default.sortBy(mibs, 'minVersion');
    }
  });
  conf.set('mibTypes', mibTypes);
}

updateMibTypes().catch(e => debug(`<error> ${e.message}`)); // const direction = (dir: Direction) => dir === Direction.in ? '<<<' : '>>>';

const decoderIn = new _nibus.NibusDecoder();
decoderIn.on('data', datagram => {
  debugIn(datagram.toString({
    pick: conf.get('pick'),
    omit: conf.get('omit')
  }));
});
const decoderOut = new _nibus.NibusDecoder();
decoderOut.on('data', datagram => {
  debugOut(datagram.toString({
    pick: conf.get('pick'),
    omit: conf.get('omit')
  }));
});
const loggers = {
  none: null,
  hex: (data, dir) => {
    switch (dir) {
      case _Server.Direction.in:
        debugIn((0, _helper.printBuffer)(data));
        break;

      case _Server.Direction.out:
        debugOut((0, _helper.printBuffer)(data));
        break;
    }
  },
  nibus: (data, dir) => {
    switch (dir) {
      case _Server.Direction.in:
        decoderIn.write(data);
        break;

      case _Server.Direction.out:
        decoderOut.write(data);
        break;
    }
  }
};

class NibusService {
  constructor() {
    _defineProperty(this, "server", void 0);

    _defineProperty(this, "isStarted", false);

    _defineProperty(this, "connections", []);

    _defineProperty(this, "logLevelHandler", (client, logLevel, pickFields, omitFields) => {
      logLevel && conf.set('logLevel', logLevel);
      pickFields && conf.set('pick', pickFields);
      omitFields && conf.set('omit', omitFields);
      this.updateLogger();
    });

    _defineProperty(this, "connectionHandler", socket => {
      const {
        server,
        connections
      } = this;
      server.send(socket, 'ports', connections.map(connection => connection.toJSON())).catch(err => {
        debug('<error>', err.stack);
      });
    });

    _defineProperty(this, "addHandler", portInfo => {
      const {
        category
      } = portInfo;
      const mibCategory = _detector.default.detection.mibCategories[category];

      if (mibCategory) {
        const connection = new _ipc.SerialTee(portInfo, mibCategory);
        connection.on('close', comName => this.removeHandler({
          comName
        }));
        this.connections.push(connection);
        this.server.broadcast('add', connection.toJSON()).catch(noop);
        this.updateLogger(connection); // this.find(connection);
      }
    });

    _defineProperty(this, "removeHandler", ({
      comName
    }) => {
      const index = this.connections.findIndex(({
        portInfo: {
          comName: port
        }
      }) => port === comName);

      if (index !== -1) {
        const [connection] = this.connections.splice(index, 1); // debug(`nibus-connection was closed ${connection.description.category}`);

        connection.close();
        this.server.broadcast('remove', connection.toJSON()).catch(noop);
      }
    });

    this.server = new _ipc.Server(_nibus2.PATH);
    this.server.on('connection', this.connectionHandler);
    this.server.on('client:setLogLevel', this.logLevelHandler);
  }

  updateLogger(connection) {
    const logger = loggers[conf.get('logLevel')];
    const connections = connection ? [connection] : this.connections;
    connections.forEach(con => con.setLogger(logger));
  }

  start() {
    if (this.isStarted) return;
    this.isStarted = true;
    const {
      detection
    } = _detector.default;
    if (detection == null) throw new Error('detection is N/A');

    _detector.default.on('add', this.addHandler);

    _detector.default.on('remove', this.removeHandler);

    _detector.default.getPorts().catch(err => {
      console.error('error while get ports', err.stack);
    });

    _detector.default.start();

    process.once('SIGINT', () => this.stop());
    process.once('SIGTERM', () => this.stop());
    /**
     * @event NibusService#start
     */

    debug('started');
  }

  stop() {
    if (!this.isStarted) return;
    const connections = this.connections.splice(0, this.connections.length);

    if (connections.length) {
      // Хак, нужен чтобы успеть закрыть все соединения, иначе не успевает их закрыть и выходит
      setTimeout(() => {
        connections.forEach(connection => connection.close());
      }, 0);
    }

    _detector.default.removeListener('add', this.addHandler);

    _detector.default.removeListener('remove', this.removeHandler); // detector.stop();


    this.isStarted = false;
    debug('stopped');
  }

  get path() {
    return this.server.path;
  }

}

const service = new NibusService();
service.start();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlL2RlbW9uLnRzIl0sIm5hbWVzIjpbInBrZyIsInJlcXVpcmUiLCJjb25mIiwiQ29uZmlnc3RvcmUiLCJuYW1lIiwibG9nTGV2ZWwiLCJvbWl0IiwiZGVidWciLCJkZWJ1Z0luIiwiZGVidWdPdXQiLCJwYXRoIiwibm9vcCIsInByb2Nlc3MiLCJwbGF0Zm9ybSIsInJsIiwiY3JlYXRlSW50ZXJmYWNlIiwiaW5wdXQiLCJzdGRpbiIsIm91dHB1dCIsInN0ZG91dCIsIm9uIiwiZW1pdCIsIm1pblZlcnNpb25Ub0ludCIsInN0ciIsImhpZ2giLCJsb3ciLCJzcGxpdCIsInVwZGF0ZU1pYlR5cGVzIiwibWlicyIsInNldCIsIm1pYlR5cGVzIiwiZm9yRWFjaCIsIm1pYiIsIm1pYmZpbGUiLCJ2YWxpZGF0aW9uIiwiTWliRGV2aWNlViIsImRlY29kZSIsImlzTGVmdCIsInR5cGVzIiwidmFsdWUiLCJkZXZpY2UiLCJ0eXBlIiwiYXBwaW5mbyIsImRldmljZV90eXBlIiwibWluVmVyc2lvbiIsIm1pbl92ZXJzaW9uIiwicHVzaCIsIl8iLCJzb3J0QnkiLCJjYXRjaCIsImUiLCJtZXNzYWdlIiwiZGVjb2RlckluIiwiTmlidXNEZWNvZGVyIiwiZGF0YWdyYW0iLCJ0b1N0cmluZyIsInBpY2siLCJnZXQiLCJkZWNvZGVyT3V0IiwibG9nZ2VycyIsIm5vbmUiLCJoZXgiLCJkYXRhIiwiZGlyIiwiRGlyZWN0aW9uIiwiaW4iLCJvdXQiLCJuaWJ1cyIsIndyaXRlIiwiTmlidXNTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJjbGllbnQiLCJwaWNrRmllbGRzIiwib21pdEZpZWxkcyIsInVwZGF0ZUxvZ2dlciIsInNvY2tldCIsInNlcnZlciIsImNvbm5lY3Rpb25zIiwic2VuZCIsIm1hcCIsImNvbm5lY3Rpb24iLCJ0b0pTT04iLCJlcnIiLCJzdGFjayIsInBvcnRJbmZvIiwiY2F0ZWdvcnkiLCJtaWJDYXRlZ29yeSIsImRldGVjdG9yIiwiZGV0ZWN0aW9uIiwibWliQ2F0ZWdvcmllcyIsIlNlcmlhbFRlZSIsImNvbU5hbWUiLCJyZW1vdmVIYW5kbGVyIiwiYnJvYWRjYXN0IiwiaW5kZXgiLCJmaW5kSW5kZXgiLCJwb3J0Iiwic3BsaWNlIiwiY2xvc2UiLCJTZXJ2ZXIiLCJQQVRIIiwiY29ubmVjdGlvbkhhbmRsZXIiLCJsb2dMZXZlbEhhbmRsZXIiLCJsb2dnZXIiLCJjb24iLCJzZXRMb2dnZXIiLCJzdGFydCIsImlzU3RhcnRlZCIsIkVycm9yIiwiYWRkSGFuZGxlciIsImdldFBvcnRzIiwiY29uc29sZSIsImVycm9yIiwib25jZSIsInN0b3AiLCJsZW5ndGgiLCJzZXRUaW1lb3V0IiwicmVtb3ZlTGlzdGVuZXIiLCJzZXJ2aWNlIl0sIm1hcHBpbmdzIjoiOzs7O0FBVUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7OztBQUdBLE1BQU1BLEdBQUcsR0FBR0MsT0FBTyxDQUFDLG9CQUFELENBQW5COztBQUNBLE1BQU1DLElBQUksR0FBRyxJQUFJQyxvQkFBSixDQUNYSCxHQUFHLENBQUNJLElBRE8sRUFFWDtBQUNFQyxFQUFBQSxRQUFRLEVBQUUsTUFEWjtBQUVFQyxFQUFBQSxJQUFJLEVBQUUsQ0FBQyxVQUFEO0FBRlIsQ0FGVyxDQUFiLEMsQ0FRQTs7QUFDQSxNQUFNQyxLQUFLLEdBQUcsb0JBQWEsZUFBYixDQUFkO0FBQ0EsTUFBTUMsT0FBTyxHQUFHLG9CQUFhLGNBQWIsQ0FBaEI7QUFDQSxNQUFNQyxRQUFRLEdBQUcsb0JBQWEsY0FBYixDQUFqQjtBQUVBRixLQUFLLENBQUUsZ0JBQWVMLElBQUksQ0FBQ1EsSUFBSyxFQUEzQixDQUFMOztBQUVBLE1BQU1DLElBQUksR0FBRyxNQUFNLENBQUUsQ0FBckI7O0FBRUEsSUFBSUMsT0FBTyxDQUFDQyxRQUFSLEtBQXFCLE9BQXpCLEVBQWtDO0FBQ2hDLFFBQU1DLEVBQUUsR0FBR2IsT0FBTyxDQUFDLFVBQUQsQ0FBUCxDQUFv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MkIsS0FBS3BCLFdBQUwsQ0FBaUJzQyxNQUE1QyxDQUFwQjs7QUFDQSxRQUFJdEMsV0FBVyxDQUFDc0MsTUFBaEIsRUFBd0I7QUFDdEI7QUFDQUMsTUFBQUEsVUFBVSxDQUFDLE1BQU07QUFDZnZDLFFBQUFBLFdBQVcsQ0FBQzlDLE9BQVosQ0FBb0JpRCxVQUFVLElBQUlBLFVBQVUsQ0FBQ2tCLEtBQVgsRUFBbEM7QUFDRCxPQUZTLEVBRVAsQ0FGTyxDQUFWO0FBR0Q7O0FBQ0RYLHNCQUFTOEIsY0FBVCxDQUF3QixLQUF4QixFQUErQixLQUFLUixVQUFwQzs7QUFDQXRCLHNCQUFTOEIsY0FBVCxDQUF3QixRQUF4QixFQUFrQyxLQUFLekIsYUFBdkMsRUFWWSxDQVdaOzs7QUFDQSxTQUFLZSxTQUFMLEdBQWlCLEtBQWpCO0FBQ0FwRyxJQUFBQSxLQUFLLENBQUMsU0FBRCxDQUFMO0FBQ0Q7O0FBRUQsTUFBSUcsSUFBSixHQUFXO0FBQ1QsV0FBTyxLQUFLa0UsTUFBTCxDQUFZbEUsSUFBbkI7QUFDRDs7QUFsR2dCOztBQXFHbkIsTUFBTTRHLE9BQU8sR0FBRyxJQUFJakQsWUFBSixFQUFoQjtBQUVBaUQsT0FBTyxDQUFDWixLQUFSIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTkuIE5hdGEtSW5mb1xuICogQGF1dGhvciBBbmRyZWkgU2FyYWtlZXYgPGF2c0BuYXRhLWluZm8ucnU+XG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgdGhlIFwiQG5hdGFcIiBwcm9qZWN0LlxuICogRm9yIHRoZSBmdWxsIGNvcHlyaWdodCBhbmQgbGljZW5zZSBpbmZvcm1hdGlvbiwgcGxlYXNlIHZpZXdcbiAqIHRoZSBFVUxBIGZpbGUgdGhhdCB3YXMgZGlzdHJpYnV0ZWQgd2l0aCB0aGlzIHNvdXJjZSBjb2RlLlxuICovXG5cbmltcG9ydCBDb25maWdzdG9yZSBmcm9tICdjb25maWdzdG9yZSc7XG5pbXBvcnQgZGVidWdGYWN0b3J5IGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IFNvY2tldCB9IGZyb20gJ25ldCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgU2VyaWFsVGVlLCBTZXJ2ZXIgfSBmcm9tICcuLi9pcGMnO1xuaW1wb3J0IHsgU2VyaWFsTG9nZ2VyIH0gZnJvbSAnLi4vaXBjL1NlcmlhbFRlZSc7XG5pbXBvcnQgeyBEaXJlY3Rpb24gfSBmcm9tICcuLi9pcGMvU2VydmVyJztcbmltcG9ydCB7IGdldE1pYkZpbGUsIGdldE1pYnMsIHRvSW50IH0gZnJvbSAnQG5hdGEvbmlidXMuanMtY2xpZW50L2xpYi9taWInO1xuaW1wb3J0IHsgSU1pYkRldmljZVR5cGUsIE1pYkRldmljZVYgfSBmcm9tICdAbmF0YS9uaWJ1cy5qcy1jbGllbnQvbGliL21pYi9kZXZpY2VzJztcbmltcG9ydCB7IE5pYnVzRGF0YWdyYW0sIE5pYnVzRGVjb2RlciB9IGZyb20gJ0BuYXRhL25pYnVzLmpzLWNsaWVudC9saWIvbmlidXMnO1xuaW1wb3J0IHsgcHJpbnRCdWZmZXIgfSBmcm9tICdAbmF0YS9uaWJ1cy5qcy1jbGllbnQvbGliL25pYnVzL2hlbHBlcic7XG5pbXBvcnQgeyBDb25maWcsIExvZ0xldmVsLCBQQVRIIH0gZnJvbSAnQG5hdGEvbmlidXMuanMtY2xpZW50JztcbmltcG9ydCBkZXRlY3RvciBmcm9tICcuL2RldGVjdG9yJztcbmltcG9ydCB7IElLbm93blBvcnQgfSBmcm9tICdAbmF0YS9uaWJ1cy5qcy1jbGllbnQvbGliL3Nlc3Npb24vS25vd25Qb3J0cyc7XG5cbmNvbnN0IHBrZyA9IHJlcXVpcmUoJy4uLy4uL3BhY2thZ2UuanNvbicpO1xuY29uc3QgY29uZiA9IG5ldyBDb25maWdzdG9yZShcbiAgcGtnLm5hbWUsXG4gIHtcbiAgICBsb2dMZXZlbDogJ25vbmUnLFxuICAgIG9taXQ6IFsncHJpb3JpdHknXSxcbiAgfSxcbik7XG5cbi8vIGRlYnVnRmFjdG9yeS5lbmFibGUoJ25pYnVzOmRldGVjdG9yLG5pYnVzLnNlcnZpY2UnKTtcbmNvbnN0IGRlYnVnID0gZGVidWdGYWN0b3J5KCduaWJ1czpzZXJ2aWNlJyk7XG5jb25zdCBkZWJ1Z0luID0gZGVidWdGYWN0b3J5KCduaWJ1czpJTlA8PDwnKTtcbmNvbnN0IGRlYnVnT3V0ID0gZGVidWdGYWN0b3J5KCduaWJ1czpPVVQ+Pj4nKTtcblxuZGVidWcoYGNvbmZpZyBwYXRoOiAke2NvbmYucGF0aH1gKTtcblxuY29uc3Qgbm9vcCA9ICgpID0+IHt9O1xuXG5pZiAocHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJykge1xuICBjb25zdCBybCA9IHJlcXVpcmUoJ3JlYWRsaW5lJykuY3JlYXRlSW50ZXJmYWNlKHtcbiAgICBpbnB1dDogcHJvY2Vzcy5zdGRpbixcbiAgICBvdXRwdXQ6IHByb2Nlc3Muc3Rkb3V0LFxuICB9KTtcblxuICBybC5vbignU0lHSU5UJywgKCkgPT4gcHJvY2Vzcy5lbWl0KCdTSUdJTlQnLCAnU0lHSU5UJykpO1xufVxuXG50eXBlIEZpZWxkcyA9IHN0cmluZ1tdIHwgdW5kZWZpbmVkO1xuXG5jb25zdCBtaW5WZXJzaW9uVG9JbnQgPSAoc3RyPzogc3RyaW5nKSA9PiB7XG4gIGlmICghc3RyKSByZXR1cm4gMDtcbiAgY29uc3QgW2hpZ2gsIGxvd10gPSBzdHIuc3BsaXQoJy4nLCAyKTtcbiAgcmV0dXJuICh0b0ludChoaWdoKSA8PCA4KSArIHRvSW50KGxvdyk7XG59O1xuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVNaWJUeXBlcygpIHtcbiAgY29uc3QgbWlicyA9IGF3YWl0IGdldE1pYnMoKTtcbiAgY29uZi5zZXQoJ21pYnMnLCBtaWJzKTtcbiAgY29uc3QgbWliVHlwZXM6IENvbmZpZ1snbWliVHlwZXMnXSA9IHt9O1xuICBtaWJzLmZvckVhY2goKG1pYikgPT4ge1xuICAgIGNvbnN0IG1pYmZpbGUgPSBnZXRNaWJGaWxlKG1pYik7XG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IE1pYkRldmljZVYuZGVjb2RlKHJlcXVpcmUobWliZmlsZSkpO1xuICAgIGlmICh2YWxpZGF0aW9uLmlzTGVmdCgpKSB7XG4gICAgICBkZWJ1ZyhgPGVycm9yPjogSW52YWxpZCBtaWIgZmlsZSAke21pYmZpbGV9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHsgdHlwZXMgfSA9IHZhbGlkYXRpb24udmFsdWU7XG4gICAgICBjb25zdCBkZXZpY2UgPSB0eXBlc1t2YWxpZGF0aW9uLnZhbHVlLmRldmljZV0gYXMgSU1pYkRldmljZVR5cGU7XG4gICAgICBjb25zdCB0eXBlID0gdG9JbnQoZGV2aWNlLmFwcGluZm8uZGV2aWNlX3R5cGUpO1xuICAgICAgY29uc3QgbWluVmVyc2lvbiA9IG1pblZlcnNpb25Ub0ludChkZXZpY2UuYXBwaW5mby5taW5fdmVyc2lvbik7XG4gICAgICBjb25zdCBtaWJzID0gbWliVHlwZXNbdHlwZV0gfHwgW107XG4gICAgICBtaWJzLnB1c2goe1xuICAgICAgICBtaWIsXG4gICAgICAgIG1pblZlcnNpb24sXG4gICAgICB9KTtcbiAgICAgIG1pYlR5cGVzW3R5cGVdID0gXy5zb3J0QnkobWlicywgJ21pblZlcnNpb24nKTtcbiAgICB9XG4gIH0pO1xuICBjb25mLnNldCgnbWliVHlwZXMnLCBtaWJUeXBlcyk7XG59XG5cbnVwZGF0ZU1pYlR5cGVzKCkuY2F0Y2goZSA9PiBkZWJ1ZyhgPGVycm9yPiAke2UubWVzc2FnZX1gKSk7XG5cbi8vIGNvbnN0IGRpcmVjdGlvbiA9IChkaXI6IERpcmVjdGlvbikgPT4gZGlyID09PSBEaXJlY3Rpb24uaW4gPyAnPDw8JyA6ICc+Pj4nO1xuY29uc3QgZGVjb2RlckluID0gbmV3IE5pYnVzRGVjb2RlcigpO1xuZGVjb2RlckluLm9uKCdkYXRhJywgKGRhdGFncmFtOiBOaWJ1c0RhdGFncmFtKSA9PiB7XG4gIGRlYnVnSW4oZGF0YWdyYW0udG9TdHJpbmcoe1xuICAgIHBpY2s6IGNvbmYuZ2V0KCdwaWNrJykgYXMgRmllbGRzLFxuICAgIG9taXQ6IGNvbmYuZ2V0KCdvbWl0JykgYXMgRmllbGRzLFxuICB9KSk7XG59KTtcbmNvbnN0IGRlY29kZXJPdXQgPSBuZXcgTmlidXNEZWNvZGVyKCk7XG5kZWNvZGVyT3V0Lm9uKCdkYXRhJywgKGRhdGFncmFtOiBOaWJ1c0RhdGFncmFtKSA9PiB7XG4gIGRlYnVnT3V0KGRhdGFncmFtLnRvU3RyaW5nKHtcbiAgICBwaWNrOiBjb25mLmdldCgncGljaycpIGFzIEZpZWxkcyxcbiAgICBvbWl0OiBjb25mLmdldCgnb21pdCcpIGFzIEZpZWxkcyxcbiAgfSkpO1xufSk7XG5cbmNvbnN0IGxvZ2dlcnMgPSB7XG4gIG5vbmU6IG51bGwsXG4gIGhleDogKGRhdGE6IEJ1ZmZlciwgZGlyOiBEaXJlY3Rpb24pID0+IHtcbiAgICBzd2l0Y2ggKGRpcikge1xuICAgICAgY2FzZSBEaXJlY3Rpb24uaW46XG4gICAgICAgIGRlYnVnSW4ocHJpbnRCdWZmZXIoZGF0YSkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRGlyZWN0aW9uLm91dDpcbiAgICAgICAgZGVidWdPdXQocHJpbnRCdWZmZXIoZGF0YSkpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH0sXG4gIG5pYnVzOiAoZGF0YTogQnVmZmVyLCBkaXI6IERpcmVjdGlvbikgPT4ge1xuICAgIHN3aXRjaCAoZGlyKSB7XG4gICAgICBjYXNlIERpcmVjdGlvbi5pbjpcbiAgICAgICAgZGVjb2RlckluLndyaXRlKGRhdGEpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgRGlyZWN0aW9uLm91dDpcbiAgICAgICAgZGVjb2Rlck91dC53cml0ZShkYXRhKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9LFxufTtcblxuY2xhc3MgTmlidXNTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzZXJ2ZXI6IFNlcnZlcjtcbiAgcHJpdmF0ZSBpc1N0YXJ0ZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBjb25uZWN0aW9uczogU2VyaWFsVGVlW10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnNlcnZlciA9IG5ldyBTZXJ2ZXIoUEFUSCk7XG4gICAgdGhpcy5zZXJ2ZXIub24oJ2Nvbm5lY3Rpb24nLCB0aGlzLmNvbm5lY3Rpb25IYW5kbGVyKTtcbiAgICB0aGlzLnNlcnZlci5vbignY2xpZW50OnNldExvZ0xldmVsJywgdGhpcy5sb2dMZXZlbEhhbmRsZXIpO1xuICB9XG5cbiAgdXBkYXRlTG9nZ2VyKGNvbm5lY3Rpb24/OiBTZXJpYWxUZWUpIHtcbiAgICBjb25zdCBsb2dnZXI6IFNlcmlhbExvZ2dlciB8IG51bGwgPSBsb2dnZXJzW2NvbmYuZ2V0KCdsb2dMZXZlbCcpIGFzIExvZ0xldmVsXTtcbiAgICBjb25zdCBjb25uZWN0aW9ucyA9IGNvbm5lY3Rpb24gPyBbY29ubmVjdGlvbl0gOiB0aGlzLmNvbm5lY3Rpb25zO1xuICAgIGNvbm5lY3Rpb25zLmZvckVhY2goY29uID0+IGNvbi5zZXRMb2dnZXIobG9nZ2VyKSk7XG4gIH1cblxuICBwcml2YXRlIGxvZ0xldmVsSGFuZGxlciA9IChcbiAgICBjbGllbnQ6IFNvY2tldCxcbiAgICBsb2dMZXZlbDogTG9nTGV2ZWwgfCB1bmRlZmluZWQsXG4gICAgcGlja0ZpZWxkczogRmllbGRzLFxuICAgIG9taXRGaWVsZHM6IEZpZWxkcykgPT4ge1xuICAgIGxvZ0xldmVsICYmIGNvbmYuc2V0KCdsb2dMZXZlbCcsIGxvZ0xldmVsKTtcbiAgICBwaWNrRmllbGRzICYmIGNvbmYuc2V0KCdwaWNrJywgcGlja0ZpZWxkcyk7XG4gICAgb21pdEZpZWxkcyAmJiBjb25mLnNldCgnb21pdCcsIG9taXRGaWVsZHMpO1xuICAgIHRoaXMudXBkYXRlTG9nZ2VyKCk7XG4gIH07XG5cbiAgcHJpdmF0ZSBjb25uZWN0aW9uSGFuZGxlciA9IChzb2NrZXQ6IFNvY2tldCkgPT4ge1xuICAgIGNvbnN0IHsgc2VydmVyLCBjb25uZWN0aW9ucyB9ID0gdGhpcztcbiAgICBzZXJ2ZXJcbiAgICAgIC5zZW5kKHNvY2tldCwgJ3BvcnRzJywgY29ubmVjdGlvbnMubWFwKGNvbm5lY3Rpb24gPT4gY29ubmVjdGlvbi50b0pTT04oKSkpXG4gICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICBkZWJ1ZygnPGVycm9yPicsIGVyci5zdGFjayk7XG4gICAgICB9KTtcbiAgfTtcblxuICBwcml2YXRlIGFkZEhhbmRsZXIgPSAocG9ydEluZm86IElLbm93blBvcnQpID0+IHtcbiAgICBjb25zdCB7IGNhdGVnb3J5IH0gPSBwb3J0SW5mbztcbiAgICBjb25zdCBtaWJDYXRlZ29yeSA9IGRldGVjdG9yLmRldGVjdGlvbiEubWliQ2F0ZWdvcmllc1tjYXRlZ29yeSFdO1xuICAgIGlmIChtaWJDYXRlZ29yeSkge1xuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IG5ldyBTZXJpYWxUZWUocG9ydEluZm8sIG1pYkNhdGVnb3J5KTtcbiAgICAgIGNvbm5lY3Rpb24ub24oJ2Nsb3NlJywgKGNvbU5hbWU6IHN0cmluZykgPT4gdGhpcy5yZW1vdmVIYW5kbGVyKHsgY29tTmFtZSB9KSk7XG4gICAgICB0aGlzLmNvbm5lY3Rpb25zLnB1c2goY29ubmVjdGlvbik7XG4gICAgICB0aGlzLnNlcnZlci5icm9hZGNhc3QoJ2FkZCcsIGNvbm5lY3Rpb24udG9KU09OKCkpLmNhdGNoKG5vb3ApO1xuICAgICAgdGhpcy51cGRhdGVMb2dnZXIoY29ubmVjdGlvbik7XG4gICAgICAvLyB0aGlzLmZpbmQoY29ubmVjdGlvbik7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgcmVtb3ZlSGFuZGxlciA9ICh7IGNvbU5hbWUgfTogeyBjb21OYW1lOiBzdHJpbmcgfSkgPT4ge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5jb25uZWN0aW9ucy5maW5kSW5kZXgoKHsgcG9ydEluZm86IHsgY29tTmFtZTogcG9ydCB9IH0pID0+IHBvcnQgPT09IGNvbU5hbWUpO1xuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgIGNvbnN0IFtjb25uZWN0aW9uXSA9IHRoaXMuY29ubmVjdGlvbnMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgIC8vIGRlYnVnKGBuaWJ1cy1jb25uZWN0aW9uIHdhcyBjbG9zZWQgJHtjb25uZWN0aW9uLmRlc2NyaXB0aW9uLmNhdGVnb3J5fWApO1xuICAgICAgY29ubmVjdGlvbi5jbG9zZSgpO1xuICAgICAgdGhpcy5zZXJ2ZXIuYnJvYWRjYXN0KCdyZW1vdmUnLCBjb25uZWN0aW9uLnRvSlNPTigpKS5jYXRjaChub29wKTtcbiAgICB9XG4gIH07XG5cbiAgcHVibGljIHN0YXJ0KCkge1xuICAgIGlmICh0aGlzLmlzU3RhcnRlZCkgcmV0dXJuO1xuICAgIHRoaXMuaXNTdGFydGVkID0gdHJ1ZTtcbiAgICBjb25zdCB7IGRldGVjdGlvbiB9ID0gZGV0ZWN0b3I7XG4gICAgaWYgKGRldGVjdGlvbiA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ2RldGVjdGlvbiBpcyBOL0EnKTtcbiAgICBkZXRlY3Rvci5vbignYWRkJywgdGhpcy5hZGRIYW5kbGVyKTtcbiAgICBkZXRlY3Rvci5vbigncmVtb3ZlJywgdGhpcy5yZW1vdmVIYW5kbGVyKTtcbiAgICBkZXRlY3Rvci5nZXRQb3J0cygpLmNhdGNoKChlcnIpID0+IHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2Vycm9yIHdoaWxlIGdldCBwb3J0cycsIGVyci5zdGFjayk7XG4gICAgfSk7XG5cbiAgICBkZXRlY3Rvci5zdGFydCgpO1xuICAgIHByb2Nlc3Mub25jZSgnU0lHSU5UJywgKCkgPT4gdGhpcy5zdG9wKCkpO1xuICAgIHByb2Nlc3Mub25jZSgnU0lHVEVSTScsICgpID0+IHRoaXMuc3RvcCgpKTtcbiAgICAvKipcbiAgICAgKiBAZXZlbnQgTmlidXNTZXJ2aWNlI3N0YXJ0XG4gICAgICovXG4gICAgZGVidWcoJ3N0YXJ0ZWQnKTtcbiAgfVxuXG4gIHB1YmxpYyBzdG9wKCkge1xuICAgIGlmICghdGhpcy5pc1N0YXJ0ZWQpIHJldHVybjtcbiAgICBjb25zdCBjb25uZWN0aW9ucyA9IHRoaXMuY29ubmVjdGlvbnMuc3BsaWNlKDAsIHRoaXMuY29ubmVjdGlvbnMubGVuZ3RoKTtcbiAgICBpZiAoY29ubmVjdGlvbnMubGVuZ3RoKSB7XG4gICAgICAvLyDQpdCw0LosINC90YPQttC10L0g0YfRgtC+0LHRiyDRg9GB0L/QtdGC0Ywg0LfQsNC60YDRi9GC0Ywg0LLRgdC1INGB0L7QtdC00LjQvdC10L3QuNGPLCDQuNC90LDRh9C1INC90LUg0YPRgdC/0LXQstCw0LXRgiDQuNGFINC30LDQutGA0YvRgtGMINC4INCy0YvRhdC+0LTQuNGCXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgY29ubmVjdGlvbnMuZm9yRWFjaChjb25uZWN0aW9uID0+IGNvbm5lY3Rpb24uY2xvc2UoKSk7XG4gICAgICB9LCAwKTtcbiAgICB9XG4gICAgZGV0ZWN0b3IucmVtb3ZlTGlzdGVuZXIoJ2FkZCcsIHRoaXMuYWRkSGFuZGxlcik7XG4gICAgZGV0ZWN0b3IucmVtb3ZlTGlzdGVuZXIoJ3JlbW92ZScsIHRoaXMucmVtb3ZlSGFuZGxlcik7XG4gICAgLy8gZGV0ZWN0b3Iuc3RvcCgpO1xuICAgIHRoaXMuaXNTdGFydGVkID0gZmFsc2U7XG4gICAgZGVidWcoJ3N0b3BwZWQnKTtcbiAgfVxuXG4gIGdldCBwYXRoKCkge1xuICAgIHJldHVybiB0aGlzLnNlcnZlci5wYXRoO1xuICB9XG59XG5cbmNvbnN0IHNlcnZpY2UgPSBuZXcgTmlidXNTZXJ2aWNlKCk7XG5cbnNlcnZpY2Uuc3RhcnQoKTtcbiJdfQ==