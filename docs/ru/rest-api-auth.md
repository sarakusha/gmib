# Методы авторизации интерфейса REST API

## Локальная авторизация

На стороне сервера при каждом запуске генерируется произвольная последовательность длиной 48 байт ```secret``` которая используется клиентской частью для добавления заголовка ```Authorization=Bearer ${secret.toString('base64')}``` в запросы. Доступ клиентской части к ```secret``` осуществляется через экспозицию свойства ```identify.appSecret``` из preload-скрипта полученного с помощью IPC из main вызовом ```getLocalCredentials```.

## Сетевая авторизация

Каждый экземпляр gmib поучает уникальный идентификатор ```identifier```, генерируемый вызовом ```nanoid()```, также на основании пароля по умолчанию `nata-info` генерируются верификатор ```verifier``` и соль ```salt``` по протоколу [SRP](https://ru.wikipedia.org/wiki/SRP). Полученные свойства сохраняются в локальном конфигурационном файле. Свойство ```identifier``` &ndash; только для чтения и не должно в дальнейшем изменяться. При смене пароля необходимо сгенерировать и обновить поля ```verifier```, ```salt``` и удалить все сохраненные сессионные ключи из таблицы ```isecret``` БД.

### Аутентификация

Первоначальная аутентификация удаленного хоста осуществляется по протоколу [SRP](https://ru.wikipedia.org/wiki/SRP) за два шага:
1. ```GET /api/handshake/:id```
2. ``` POST /api/login/:id```

Полученный на втором шаге сессионный ключ используется для подписания запросов от хоста с идентификатором ```id``` и сохраняется в локальной БД в таблице для входящих запросов ```isecret``` на стороне сервера и, соответственно, в таблице для исходящих запросов ```osecret``` на стороне клиента, что позволяет не требовать аутентификацию для последующих запросов. Для повторной аутентификации достаточно удалить запись в БД на стороне сервера и/или клиента.

### Авторизация

Каждый запрос от клиента должен содержать заголовки ```x-ni-identifier``` содержащий ```identifier``` клиента, ```x-ni-timestamp``` &ndash; хранит время создания запроса, ```x-ni-signature``` &ndash; подпись, сгенерированная на основе сессионного ключа полученного во время аутентификации и сохраненного в БД, метода REST, url запроса (без базы), времени запроса и тела запроса. Получить подпись можно вызвав функцию ```generateSignature```. Доступ клиентской части к сессионному ключу осуществляется через экспозицию свойства ```identify.appSecret``` из preload-скрипта полученного с помощью IPC из main вызовом ```getRemoteCredentials```.
### Свободные ресурсы

Следующие ресурсы доступны неавторизованным клиентам:
* ```/api/handshake/*``` &ndash; 1 шаг аутентификации
* ```/api/login/*``` &ndash; 2 шаг аутентификации
* ```/api/identifier``` - запрос идентификатора
* ```/api/novastar/subscribe``` - подписка на события novastar
